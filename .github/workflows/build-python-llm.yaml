# =============================================================================
# Build Python LLM - Reusable Workflow
# =============================================================================
# Purpose: Builds 2 Python LLM AppImages with bundled Gemma 3 1B model
#   - Linux x86_64 LLM AppImage (~1.5GB with bundled model)
#   - Linux ARM64 LLM AppImage (~1.5GB with bundled model)
#
# Dependencies: Requires artifacts from build-python-prolog.yaml
#   - python-linux-x86_64-full-prolog / python-linux-arm64-full-prolog
#   - python-swipl-runtime-x86_64-full / python-swipl-runtime-aarch64-full
#
# Inputs:
#   - ref: Git ref to build (default: github.ref)
#
# Outputs:
#   - Artifacts: python-llm-gemma3-1b-appimage-x86_64, python-llm-gemma3-1b-appimage-aarch64
#
# Part of Story: TEA-RELEASE-005 (Workflow Modularization)
# =============================================================================

name: Build Python LLM

on:
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to build'
        type: string
        required: false
        default: ''
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to build (leave empty for current branch)'
        type: string
        required: false
        default: ''

jobs:
  # ============================================================
  # Python LLM AppImage - x86_64 (Gemma 3 1B)
  # Self-contained with bundled Gemma 3 1B Q8_0 GGUF model (~1.07GB)
  # ============================================================
  build-python-llm-gemma3-1b-x86_64:
    runs-on: ubuntu-24.04
    name: Python LLM AppImage x86_64 (Gemma3-1B)

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          # libpython3.12t64 provides libpython3.12.so.1.0 needed by janus.so (t64 = time64 ABI on Ubuntu 24.04)
          sudo apt-get install -y file libfuse2 libossp-uuid16 wget libpython3.12t64

      - name: Download Python Full Prolog binary
        uses: actions/download-artifact@v4
        with:
          name: python-linux-x86_64-full-prolog
          path: .

      - name: Download SWI-Prolog runtime from build job
        uses: actions/download-artifact@v4
        with:
          name: python-swipl-runtime-x86_64-full
          path: .

      - name: Download Gemma 3 1B Q8_0 model from Hugging Face
        run: |
          mkdir -p models
          # Download Gemma 3 1B Q8_0 (~1.07GB)
          wget -q --show-progress -O models/gemma-3-1b-it-Q8_0.gguf \
            "https://huggingface.co/unsloth/gemma-3-1b-it-GGUF/resolve/main/gemma-3-1b-it-Q8_0.gguf"
          ls -lh models/

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Create .desktop file
        run: |
          cat > tea-python-llm.desktop << 'EOF'
          [Desktop Entry]
          Name=TEA LLM Python Gemma3-1B
          Comment=Lightweight state graph workflow engine with bundled Gemma 3 1B LLM
          Exec=tea
          Icon=tea-python-llm
          Type=Application
          Categories=Development;
          Terminal=true
          EOF
          sed -i 's/^[[:space:]]*//' tea-python-llm.desktop

      - name: Create placeholder icon
        run: |
          cat > tea-python-llm.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="#4285F4"/>
            <text x="128" y="140" font-family="monospace" font-size="40" fill="#FFFFFF" text-anchor="middle">Gemma</text>
            <text x="128" y="200" font-family="monospace" font-size="40" fill="#FFFFFF" text-anchor="middle">py</text>
          </svg>
          EOF
          sed -i 's/^[[:space:]]*//' tea-python-llm.svg

      - name: Create AppDir structure
        run: |
          mkdir -p tea-python-llm.AppDir/usr/bin
          mkdir -p tea-python-llm.AppDir/usr/lib/swipl
          mkdir -p tea-python-llm.AppDir/usr/share/models
          chmod +x tea-python-linux-x86_64-full-prolog
          cp tea-python-linux-x86_64-full-prolog tea-python-llm.AppDir/usr/bin/tea
          cp models/gemma-3-1b-it-Q8_0.gguf tea-python-llm.AppDir/usr/share/models/

      - name: Bundle SWI-Prolog runtime
        run: |
          tar -xzf python-swipl-runtime-x86_64-full.tar.gz
          cp -r python-swipl-runtime-x86_64-full/home/* tea-python-llm.AppDir/usr/lib/swipl/
          mkdir -p tea-python-llm.AppDir/usr/lib
          cp -L python-swipl-runtime-x86_64-full/lib/libswipl.so* tea-python-llm.AppDir/usr/lib/

          cd tea-python-llm.AppDir/usr/lib
          FULL_LIB=$(ls libswipl.so.*.*.* 2>/dev/null | head -1 || true)
          if [ -n "$FULL_LIB" ]; then
            MAJOR_VERSION=$(echo "$FULL_LIB" | sed 's/libswipl.so.\([0-9]*\).*/\1/')
            [ ! -e "libswipl.so.${MAJOR_VERSION}" ] && ln -sf "$FULL_LIB" "libswipl.so.${MAJOR_VERSION}"
            [ ! -e "libswipl.so" ] && ln -sf "libswipl.so.${MAJOR_VERSION}" "libswipl.so"
          fi
          cd ../../..

      - name: Bundle libpython for janus.so
        run: |
          # janus.so (SWI-Prolog/Python bridge) requires libpython
          LIBPYTHON=$(find /usr/lib -name "libpython3*.so.1.0" 2>/dev/null | head -1)
          if [ -n "$LIBPYTHON" ]; then
            cp -L "$LIBPYTHON" tea-python-llm.AppDir/usr/lib/
            echo "Bundled libpython from: $LIBPYTHON"
          else
            echo "Warning: libpython not found"
          fi

      - name: Run linuxdeploy
        run: |
          export LD_LIBRARY_PATH="$(pwd)/tea-python-llm.AppDir/usr/lib:${LD_LIBRARY_PATH}"
          ./linuxdeploy-x86_64.AppImage \
            --appdir tea-python-llm.AppDir \
            --executable tea-python-llm.AppDir/usr/bin/tea \
            --desktop-file tea-python-llm.desktop \
            --icon-file tea-python-llm.svg \
            --output appimage

      - name: Create custom AppRun with LLM model path
        run: |
          rm -f tea-python-llm.AppDir/AppRun
          cat > tea-python-llm.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export SWI_HOME_DIR="${HERE}/usr/lib/swipl"
          export PYTHONDONTWRITEBYTECODE=1
          export PYTHONUNBUFFERED=1
          export TEA_MODEL_PATH="${HERE}/usr/share/models/gemma-3-1b-it-Q8_0.gguf"
          exec "${HERE}/usr/bin/tea" "$@"
          EOF
          chmod +x tea-python-llm.AppDir/AppRun

      - name: Rebuild AppImage with custom AppRun
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage tea-python-llm.AppDir "tea-python-llm-gemma3-1b-${VERSION}-x86_64.AppImage"

      - name: Smoke test AppImage
        run: |
          chmod +x tea-python-llm-gemma3-1b-*-x86_64.AppImage
          ./tea-python-llm-gemma3-1b-*-x86_64.AppImage --version
          impl=$(./tea-python-llm-gemma3-1b-*-x86_64.AppImage --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Functional test - verify model is bundled
        run: |
          ./tea-python-llm-gemma3-1b-*-x86_64.AppImage --appimage-extract
          if [ ! -f squashfs-root/usr/share/models/gemma-3-1b-it-Q8_0.gguf ]; then
            echo "Error: Model file not found in AppImage"
            exit 1
          fi
          model_size=$(stat -c%s "squashfs-root/usr/share/models/gemma-3-1b-it-Q8_0.gguf")
          model_size_mb=$((model_size / 1024 / 1024))
          echo "Bundled model size: ${model_size_mb}MB"
          rm -rf squashfs-root

      - name: Check AppImage size
        run: |
          size=$(stat -c%s tea-python-llm-gemma3-1b-*-x86_64.AppImage)
          size_mb=$((size / 1024 / 1024))
          echo "AppImage size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-llm-gemma3-1b-appimage-x86_64
          path: tea-python-llm-gemma3-1b-*-x86_64.AppImage
          retention-days: 1

  # ============================================================
  # Python LLM AppImage - ARM64 (Gemma 3 1B)
  # Self-contained with bundled Gemma 3 1B Q8_0 GGUF model (~1.07GB)
  # ============================================================
  build-python-llm-gemma3-1b-aarch64:
    runs-on: ubuntu-24.04-arm
    name: Python LLM AppImage aarch64 (Gemma3-1B)

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          # libpython3.12t64 provides libpython3.12.so.1.0 needed by janus.so (t64 = time64 ABI on Ubuntu 24.04)
          sudo apt-get install -y file libfuse2 libossp-uuid16 wget libpython3.12t64

      - name: Download Python Full Prolog binary
        uses: actions/download-artifact@v4
        with:
          name: python-linux-arm64-full-prolog
          path: .

      - name: Download SWI-Prolog runtime from build job
        uses: actions/download-artifact@v4
        with:
          name: python-swipl-runtime-aarch64-full
          path: .

      - name: Download Gemma 3 1B Q8_0 model from Hugging Face
        run: |
          mkdir -p models
          # Download Gemma 3 1B Q8_0 (~1.07GB)
          wget -q --show-progress -O models/gemma-3-1b-it-Q8_0.gguf \
            "https://huggingface.co/unsloth/gemma-3-1b-it-GGUF/resolve/main/gemma-3-1b-it-Q8_0.gguf"
          ls -lh models/

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
          chmod +x linuxdeploy-aarch64.AppImage

      - name: Create .desktop file
        run: |
          cat > tea-python-llm.desktop << 'EOF'
          [Desktop Entry]
          Name=TEA LLM Python Gemma3-1B
          Comment=Lightweight state graph workflow engine with bundled Gemma 3 1B LLM
          Exec=tea
          Icon=tea-python-llm
          Type=Application
          Categories=Development;
          Terminal=true
          EOF
          sed -i 's/^[[:space:]]*//' tea-python-llm.desktop

      - name: Create placeholder icon
        run: |
          cat > tea-python-llm.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="#4285F4"/>
            <text x="128" y="140" font-family="monospace" font-size="40" fill="#FFFFFF" text-anchor="middle">Gemma</text>
            <text x="128" y="200" font-family="monospace" font-size="40" fill="#FFFFFF" text-anchor="middle">py</text>
          </svg>
          EOF
          sed -i 's/^[[:space:]]*//' tea-python-llm.svg

      - name: Create AppDir structure
        run: |
          mkdir -p tea-python-llm.AppDir/usr/bin
          mkdir -p tea-python-llm.AppDir/usr/lib/swipl
          mkdir -p tea-python-llm.AppDir/usr/share/models
          chmod +x tea-python-linux-arm64-full-prolog
          cp tea-python-linux-arm64-full-prolog tea-python-llm.AppDir/usr/bin/tea
          cp models/gemma-3-1b-it-Q8_0.gguf tea-python-llm.AppDir/usr/share/models/

      - name: Bundle SWI-Prolog runtime
        run: |
          tar -xzf python-swipl-runtime-aarch64-full.tar.gz
          cp -r python-swipl-runtime-aarch64-full/home/* tea-python-llm.AppDir/usr/lib/swipl/
          mkdir -p tea-python-llm.AppDir/usr/lib
          cp -L python-swipl-runtime-aarch64-full/lib/libswipl.so* tea-python-llm.AppDir/usr/lib/

          cd tea-python-llm.AppDir/usr/lib
          FULL_LIB=$(ls libswipl.so.*.*.* 2>/dev/null | head -1 || true)
          if [ -n "$FULL_LIB" ]; then
            MAJOR_VERSION=$(echo "$FULL_LIB" | sed 's/libswipl.so.\([0-9]*\).*/\1/')
            [ ! -e "libswipl.so.${MAJOR_VERSION}" ] && ln -sf "$FULL_LIB" "libswipl.so.${MAJOR_VERSION}"
            [ ! -e "libswipl.so" ] && ln -sf "libswipl.so.${MAJOR_VERSION}" "libswipl.so"
          fi
          cd ../../..

      - name: Bundle libpython for janus.so
        run: |
          # janus.so (SWI-Prolog/Python bridge) requires libpython
          LIBPYTHON=$(find /usr/lib -name "libpython3*.so.1.0" 2>/dev/null | head -1)
          if [ -n "$LIBPYTHON" ]; then
            cp -L "$LIBPYTHON" tea-python-llm.AppDir/usr/lib/
            echo "Bundled libpython from: $LIBPYTHON"
          else
            echo "Warning: libpython not found"
          fi

      - name: Run linuxdeploy
        run: |
          export LD_LIBRARY_PATH="$(pwd)/tea-python-llm.AppDir/usr/lib:${LD_LIBRARY_PATH}"
          ./linuxdeploy-aarch64.AppImage \
            --appdir tea-python-llm.AppDir \
            --executable tea-python-llm.AppDir/usr/bin/tea \
            --desktop-file tea-python-llm.desktop \
            --icon-file tea-python-llm.svg \
            --output appimage

      - name: Create custom AppRun with LLM model path
        run: |
          rm -f tea-python-llm.AppDir/AppRun
          cat > tea-python-llm.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export SWI_HOME_DIR="${HERE}/usr/lib/swipl"
          export PYTHONDONTWRITEBYTECODE=1
          export PYTHONUNBUFFERED=1
          export TEA_MODEL_PATH="${HERE}/usr/share/models/gemma-3-1b-it-Q8_0.gguf"
          exec "${HERE}/usr/bin/tea" "$@"
          EOF
          chmod +x tea-python-llm.AppDir/AppRun

      - name: Rebuild AppImage with custom AppRun
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
          chmod +x appimagetool-aarch64.AppImage
          ARCH=aarch64 ./appimagetool-aarch64.AppImage tea-python-llm.AppDir "tea-python-llm-gemma3-1b-${VERSION}-aarch64.AppImage"

      - name: Smoke test AppImage
        run: |
          chmod +x tea-python-llm-gemma3-1b-*-aarch64.AppImage
          ./tea-python-llm-gemma3-1b-*-aarch64.AppImage --version
          impl=$(./tea-python-llm-gemma3-1b-*-aarch64.AppImage --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Functional test - verify model is bundled
        run: |
          ./tea-python-llm-gemma3-1b-*-aarch64.AppImage --appimage-extract
          if [ ! -f squashfs-root/usr/share/models/gemma-3-1b-it-Q8_0.gguf ]; then
            echo "Error: Model file not found in AppImage"
            exit 1
          fi
          model_size=$(stat -c%s "squashfs-root/usr/share/models/gemma-3-1b-it-Q8_0.gguf")
          model_size_mb=$((model_size / 1024 / 1024))
          echo "Bundled model size: ${model_size_mb}MB"
          rm -rf squashfs-root

      - name: Check AppImage size
        run: |
          size=$(stat -c%s tea-python-llm-gemma3-1b-*-aarch64.AppImage)
          size_mb=$((size / 1024 / 1024))
          echo "AppImage size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-llm-gemma3-1b-appimage-aarch64
          path: tea-python-llm-gemma3-1b-*-aarch64.AppImage
          retention-days: 1
