# Multi-Platform Binary Release Pipeline
# Story: TEA-RELEASE-001
#
# Triggers on tag push (v*) and builds:
# - Python standalone binaries (PyInstaller) for 5 platforms:
#   - Linux x86_64: Docker (batonogov/pyinstaller-linux)
#   - Linux ARM64: Native runner (ubuntu-24.04-arm)
#   - Windows x86_64: Docker + Wine (batonogov/pyinstaller-windows)
#   - macOS ARM64: Native runner (macos-latest)
#   - macOS x86_64: Native runner with cross-compile
# - Rust binaries for 5 platforms (native compilation)
# - Python wheel (.whl) files
#
# All artifacts are published to GitHub Releases with SHA256 checksums.

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.11'
  RUST_VERSION: 'stable'

jobs:
  # ============================================================
  # Python Standalone Binaries - Linux (Docker-based)
  # ============================================================
  build-python-linux:
    runs-on: ubuntu-latest
    name: Python linux-x86_64

    steps:
      - uses: actions/checkout@v4

      - name: Build with PyInstaller Docker
        run: |
          docker run --rm -v "$(pwd):/src" --entrypoint /bin/bash batonogov/pyinstaller-linux:latest -c \
            "cd /src/python && \
             pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer && \
             pip install -e . --no-deps && \
             pyinstaller --onefile --name tea-python-linux-x86_64 \
               --hidden-import=the_edge_agent \
               --hidden-import=the_edge_agent.yaml_engine \
               --hidden-import=the_edge_agent.stategraph \
               --hidden-import=yaml \
               --hidden-import=json \
               --hidden-import=jinja2 \
               --hidden-import=typer \
               --collect-all the_edge_agent \
               --exclude-module tkinter \
               --exclude-module matplotlib \
               --exclude-module numpy \
               --exclude-module pandas \
               --strip \
               src/the_edge_agent/cli.py"

      - name: Smoke test
        run: |
          sudo chmod +x python/dist/tea-python-linux-x86_64
          ./python/dist/tea-python-linux-x86_64 --version
          impl=$(./python/dist/tea-python-linux-x86_64 --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-x86_64")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-x86_64
          path: python/dist/tea-python-linux-x86_64
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Linux ARM64 (Native runner)
  # ============================================================
  build-python-linux-arm64:
    runs-on: ubuntu-24.04-arm
    name: Python linux-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary
        run: |
          cd python
          pyinstaller --onefile --name tea-python-linux-arm64 \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --collect-all the_edge_agent \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --exclude-module numpy \
            --exclude-module pandas \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          ./python/dist/tea-python-linux-arm64 --version
          impl=$(./python/dist/tea-python-linux-arm64 --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-arm64")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-arm64
          path: python/dist/tea-python-linux-arm64
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Windows (Docker + Wine)
  # ============================================================
  build-python-windows:
    runs-on: ubuntu-latest
    name: Python windows-x86_64

    steps:
      - uses: actions/checkout@v4

      - name: Build with PyInstaller Windows Docker
        run: |
          docker run --rm -v "$(pwd):/src" --entrypoint /bin/bash batonogov/pyinstaller-windows:latest -c \
            "cd /src/python && \
             pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer && \
             pip install -e . --no-deps && \
             pyinstaller --onefile --name tea-python-windows-x86_64 \
               --hidden-import=the_edge_agent \
               --hidden-import=the_edge_agent.yaml_engine \
               --hidden-import=the_edge_agent.stategraph \
               --hidden-import=yaml \
               --hidden-import=json \
               --hidden-import=jinja2 \
               --hidden-import=typer \
               --collect-all the_edge_agent \
               --exclude-module tkinter \
               --exclude-module matplotlib \
               --exclude-module numpy \
               --exclude-module pandas \
               src/the_edge_agent/cli.py"

      - name: Check binary exists
        run: |
          ls -la python/dist/
          file python/dist/tea-python-windows-x86_64.exe

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-windows-x86_64.exe")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-windows-x86_64
          path: python/dist/tea-python-windows-x86_64.exe
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - macOS (Native runners)
  # ============================================================
  build-python-macos:
    runs-on: macos-latest
    name: Python darwin-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary
        run: |
          cd python
          pyinstaller --onefile --name tea-python-darwin-arm64 \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --collect-all the_edge_agent \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --exclude-module numpy \
            --exclude-module pandas \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          ./python/dist/tea-python-darwin-arm64 --version
          impl=$(./python/dist/tea-python-darwin-arm64 --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -f%z "python/dist/tea-python-darwin-arm64")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-darwin-arm64
          path: python/dist/tea-python-darwin-arm64
          retention-days: 1

  # ============================================================
  # Rust Binaries
  # ============================================================
  build-rust:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact: tea-linux-x86_64
            ext: ''
            use_cross: false
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-musl
            artifact: tea-linux-arm64
            ext: ''
            use_cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: tea-windows-x86_64
            ext: '.exe'
            use_cross: false
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: tea-darwin-arm64
            ext: ''
            use_cross: false
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: tea-darwin-x86_64
            ext: ''
            use_cross: false

    runs-on: ${{ matrix.os }}
    name: Rust ${{ matrix.artifact }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      - name: Install musl tools (Linux x86_64)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Install musl tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools gcc-aarch64-linux-gnu

      - name: Build release binary
        run: |
          cd rust
          cargo build --release --target ${{ matrix.target }} --bin tea

      - name: Copy binary
        run: |
          cp rust/target/${{ matrix.target }}/release/tea${{ matrix.ext }} ${{ matrix.artifact }}${{ matrix.ext }}
        shell: bash

      - name: Smoke test - version
        if: matrix.target != 'x86_64-apple-darwin'
        run: |
          ./${{ matrix.artifact }}${{ matrix.ext }} --version
        shell: bash

      - name: Smoke test - version (x86_64 on ARM64 macOS)
        if: matrix.target == 'x86_64-apple-darwin'
        run: |
          arch -x86_64 ./${{ matrix.artifact }}${{ matrix.ext }} --version
        shell: bash

      - name: Smoke test - impl
        if: matrix.target != 'x86_64-apple-darwin'
        run: |
          impl=$(./${{ matrix.artifact }}${{ matrix.ext }} --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi
        shell: bash

      - name: Smoke test - impl (x86_64 on ARM64 macOS)
        if: matrix.target == 'x86_64-apple-darwin'
        run: |
          impl=$(arch -x86_64 ./${{ matrix.artifact }}${{ matrix.ext }} --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi
        shell: bash

      - name: Verify version matches tag
        if: matrix.target != 'x86_64-apple-darwin'
        run: |
          version=$(./${{ matrix.artifact }}${{ matrix.ext }} --version | awk '{print $2}')
          tag="${GITHUB_REF_NAME#v}"
          if [ "$version" != "$tag" ]; then
            echo "Warning: Binary version ($version) does not match tag ($tag)"
          fi
        shell: bash

      - name: Verify version matches tag (x86_64 on ARM64 macOS)
        if: matrix.target == 'x86_64-apple-darwin'
        run: |
          version=$(arch -x86_64 ./${{ matrix.artifact }}${{ matrix.ext }} --version | awk '{print $2}')
          tag="${GITHUB_REF_NAME#v}"
          if [ "$version" != "$tag" ]; then
            echo "Warning: Binary version ($version) does not match tag ($tag)"
          fi
        shell: bash

      - name: Check binary size
        run: |
          size=$(stat -f%z "${{ matrix.artifact }}${{ matrix.ext }}" 2>/dev/null || stat -c%s "${{ matrix.artifact }}${{ matrix.ext }}")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"
          if [ $size_mb -gt 20 ]; then
            echo "Warning: Binary exceeds 20MB target (${size_mb}MB)"
          fi
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-${{ matrix.artifact }}
          path: ${{ matrix.artifact }}${{ matrix.ext }}
          retention-days: 1

  # ============================================================
  # Python Wheel (existing)
  # ============================================================
  build-wheel:
    runs-on: ubuntu-latest
    name: Python Wheel

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build wheel
        run: |
          cd python
          pip install build
          python -m build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-wheel
          path: python/dist/*.whl
          retention-days: 1

  # ============================================================
  # Create Release
  # ============================================================
  release:
    needs: [build-python-linux, build-python-linux-arm64, build-python-windows, build-python-macos, build-rust, build-wheel]
    runs-on: ubuntu-latest
    name: Create Release

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for release notes

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten artifacts
        run: |
          mkdir -p release
          find dist -type f -exec mv {} release/ \;
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
