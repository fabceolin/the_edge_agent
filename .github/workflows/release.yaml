# Multi-Platform Binary Release Pipeline
# Story: TEA-RELEASE-001
#
# Triggers on tag push (v*) and builds:
# - Python standalone binaries (PyInstaller) for 8 variants:
#   - Linux x86_64: Docker (batonogov/pyinstaller-linux) - core deps only
#   - Linux x86_64 Full: Docker with all optional dependencies
#   - Linux ARM64: Native runner (ubuntu-24.04-arm) - core deps only
#   - Linux ARM64 Full: Native runner with all optional dependencies
#   - Windows x86_64: Native runner (windows-latest) - core deps only
#   - Windows x86_64 Full: Native runner with all optional dependencies
#   - macOS ARM64: Native runner (macos-latest) - core deps only
#   - macOS ARM64 Full: Native runner with all optional dependencies
# - Rust binaries for 5 platforms (native compilation)
# - Python wheel (.whl) files
#
# Full builds include: openai, numpy, chromadb, requests, RestrictedPython,
# pycozo, pandas, s3fs, gcsfs, adlfs, lupa, kuzu
#
# All artifacts are published to GitHub Releases with SHA256 checksums.

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.11'
  RUST_VERSION: 'stable'

jobs:
  # ============================================================
  # Python Standalone Binaries - Linux (Docker-based)
  # ============================================================
  build-python-linux:
    runs-on: ubuntu-latest
    name: Python linux-x86_64

    steps:
      - uses: actions/checkout@v4

      - name: Build with PyInstaller Docker
        run: |
          docker run --rm -v "$(pwd):/src" --entrypoint /bin/bash batonogov/pyinstaller-linux:latest -c \
            "cd /src/python && \
             pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer python-dotenv pydantic pydot && \
             pip install -e . --no-deps && \
             pyinstaller --onefile --name tea-python-linux-x86_64 \
               --hidden-import=the_edge_agent \
               --hidden-import=the_edge_agent.yaml_engine \
               --hidden-import=the_edge_agent.stategraph \
               --hidden-import=yaml \
               --hidden-import=json \
               --hidden-import=jinja2 \
               --hidden-import=typer \
               --hidden-import=dotenv \
               --hidden-import=pydantic \
               --hidden-import=pydot \
               --collect-all the_edge_agent \
               --collect-all pydantic \
               --collect-all pydot \
               --exclude-module tkinter \
               --exclude-module matplotlib \
               --exclude-module numpy \
               --exclude-module pandas \
               --strip \
               src/the_edge_agent/cli.py"

      - name: Smoke test
        run: |
          sudo chmod +x python/dist/tea-python-linux-x86_64
          ./python/dist/tea-python-linux-x86_64 --version
          impl=$(./python/dist/tea-python-linux-x86_64 --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-x86_64")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-x86_64
          path: python/dist/tea-python-linux-x86_64
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Linux x86_64 Full (Docker-based)
  # Includes all optional dependencies: LLM, RAG, web, code, graph, storage
  # ============================================================
  build-python-linux-full:
    runs-on: ubuntu-latest
    name: Python linux-x86_64-full

    steps:
      - uses: actions/checkout@v4

      - name: Build with PyInstaller Docker (full dependencies)
        run: |
          docker run --rm -v "$(pwd):/src" --entrypoint /bin/bash batonogov/pyinstaller-linux:latest -c \
            "cd /src/python && \
             pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer python-dotenv pydantic pydot \
                         openai 'numpy<2' chromadb requests RestrictedPython \
                         'pycozo[embedded]' pandas \
                         s3fs gcsfs adlfs lupa kuzu \
                         firebase-admin duckdb && \
             pip install -e . --no-deps && \
             pyinstaller --onefile --name tea-python-linux-x86_64-full \
               --hidden-import=the_edge_agent \
               --hidden-import=the_edge_agent.yaml_engine \
               --hidden-import=the_edge_agent.stategraph \
               --hidden-import=yaml \
               --hidden-import=json \
               --hidden-import=jinja2 \
               --hidden-import=typer \
               --hidden-import=dotenv \
               --hidden-import=pydantic \
               --hidden-import=pydot \
               --hidden-import=openai \
               --hidden-import=numpy \
               --hidden-import=chromadb \
               --hidden-import=requests \
               --hidden-import=RestrictedPython \
               --hidden-import=pycozo \
               --hidden-import=pandas \
               --hidden-import=s3fs \
               --hidden-import=gcsfs \
               --hidden-import=adlfs \
               --hidden-import=lupa \
               --hidden-import=kuzu \
               --hidden-import=firebase_admin \
               --hidden-import=duckdb \
               --collect-all the_edge_agent \
               --collect-all numpy \
               --collect-all pandas \
               --collect-all firebase_admin \
               --collect-all pydantic \
               --collect-all pydot \
               --exclude-module tkinter \
               --exclude-module matplotlib \
               --strip \
               src/the_edge_agent/cli.py"

      - name: Smoke test
        run: |
          sudo chmod +x python/dist/tea-python-linux-x86_64-full
          ./python/dist/tea-python-linux-x86_64-full --version
          impl=$(./python/dist/tea-python-linux-x86_64-full --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-x86_64-full")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-x86_64-full
          path: python/dist/tea-python-linux-x86_64-full
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Linux ARM64 (Native runner)
  # ============================================================
  build-python-linux-arm64:
    runs-on: ubuntu-24.04-arm
    name: Python linux-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer python-dotenv pydantic pydot
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary
        run: |
          cd python
          pyinstaller --onefile --name tea-python-linux-arm64 \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --hidden-import=dotenv \
            --hidden-import=pydantic \
            --hidden-import=pydot \
            --collect-all the_edge_agent \
            --collect-all pydantic \
            --collect-all pydot \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --exclude-module numpy \
            --exclude-module pandas \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          chmod +x python/dist/tea-python-linux-arm64
          ./python/dist/tea-python-linux-arm64 --version
          impl=$(./python/dist/tea-python-linux-arm64 --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-arm64")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-arm64
          path: python/dist/tea-python-linux-arm64
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Linux ARM64 Full (Native runner)
  # Includes all optional dependencies: LLM, RAG, web, code, graph, storage
  # ============================================================
  build-python-linux-arm64-full:
    runs-on: ubuntu-24.04-arm
    name: Python linux-arm64-full

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies (full)
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer python-dotenv pydantic pydot \
                      openai 'numpy<2' chromadb requests RestrictedPython \
                      'pycozo[embedded]' pandas \
                      s3fs gcsfs adlfs lupa kuzu \
                      firebase-admin duckdb
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary (full)
        run: |
          cd python
          pyinstaller --onefile --name tea-python-linux-arm64-full \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --hidden-import=dotenv \
            --hidden-import=pydantic \
            --hidden-import=pydot \
            --hidden-import=openai \
            --hidden-import=numpy \
            --hidden-import=chromadb \
            --hidden-import=requests \
            --hidden-import=RestrictedPython \
            --hidden-import=pycozo \
            --hidden-import=pandas \
            --hidden-import=s3fs \
            --hidden-import=gcsfs \
            --hidden-import=adlfs \
            --hidden-import=lupa \
            --hidden-import=kuzu \
            --hidden-import=firebase_admin \
            --hidden-import=duckdb \
            --collect-all the_edge_agent \
            --collect-all numpy \
            --collect-all pandas \
            --collect-all firebase_admin \
            --collect-all pydantic \
            --collect-all pydot \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          chmod +x python/dist/tea-python-linux-arm64-full
          ./python/dist/tea-python-linux-arm64-full --version
          impl=$(./python/dist/tea-python-linux-arm64-full --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-arm64-full")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-arm64-full
          path: python/dist/tea-python-linux-arm64-full
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Windows (Native runner)
  # ============================================================
  build-python-windows:
    runs-on: windows-latest
    name: Python windows-x86_64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer python-dotenv pydantic pydot
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary
        run: |
          cd python
          pyinstaller --onefile --name tea-python-windows-x86_64 `
            --hidden-import=the_edge_agent `
            --hidden-import=the_edge_agent.yaml_engine `
            --hidden-import=the_edge_agent.stategraph `
            --hidden-import=yaml `
            --hidden-import=json `
            --hidden-import=jinja2 `
            --hidden-import=typer `
            --hidden-import=dotenv `
            --hidden-import=pydantic `
            --hidden-import=pydot `
            --collect-all the_edge_agent `
            --collect-all pydantic `
            --collect-all pydot `
            --exclude-module tkinter `
            --exclude-module matplotlib `
            --exclude-module numpy `
            --exclude-module pandas `
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          ./python/dist/tea-python-windows-x86_64.exe --version
          $impl = ./python/dist/tea-python-windows-x86_64.exe --impl
          if ($impl -ne "python") {
            Write-Error "Error: Expected 'python', got '$impl'"
            exit 1
          }

      - name: Check binary size
        run: |
          $size = (Get-Item "python/dist/tea-python-windows-x86_64.exe").Length
          $size_mb = [math]::Floor($size / 1024 / 1024)
          Write-Host "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-windows-x86_64
          path: python/dist/tea-python-windows-x86_64.exe
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Windows Full (Native runner)
  # Includes all optional dependencies: LLM, RAG, web, code, graph, storage
  # ============================================================
  build-python-windows-full:
    runs-on: windows-latest
    name: Python windows-x86_64-full

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies (full)
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer python-dotenv pydantic pydot `
                      openai "numpy<2" chromadb requests RestrictedPython `
                      "pycozo[embedded]" pandas `
                      s3fs gcsfs adlfs lupa kuzu `
                      firebase-admin duckdb
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary (full)
        run: |
          cd python
          pyinstaller --onefile --name tea-python-windows-x86_64-full `
            --hidden-import=the_edge_agent `
            --hidden-import=the_edge_agent.yaml_engine `
            --hidden-import=the_edge_agent.stategraph `
            --hidden-import=yaml `
            --hidden-import=json `
            --hidden-import=jinja2 `
            --hidden-import=typer `
            --hidden-import=dotenv `
            --hidden-import=pydantic `
            --hidden-import=pydot `
            --hidden-import=openai `
            --hidden-import=numpy `
            --hidden-import=chromadb `
            --hidden-import=requests `
            --hidden-import=RestrictedPython `
            --hidden-import=pycozo `
            --hidden-import=pandas `
            --hidden-import=s3fs `
            --hidden-import=gcsfs `
            --hidden-import=adlfs `
            --hidden-import=lupa `
            --hidden-import=kuzu `
            --hidden-import=firebase_admin `
            --hidden-import=duckdb `
            --collect-all the_edge_agent `
            --collect-all numpy `
            --collect-all pandas `
            --collect-all firebase_admin `
            --collect-all pydantic `
            --collect-all pydot `
            --exclude-module tkinter `
            --exclude-module matplotlib `
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          ./python/dist/tea-python-windows-x86_64-full.exe --version
          $impl = ./python/dist/tea-python-windows-x86_64-full.exe --impl
          if ($impl -ne "python") {
            Write-Error "Error: Expected 'python', got '$impl'"
            exit 1
          }

      - name: Check binary size
        run: |
          $size = (Get-Item "python/dist/tea-python-windows-x86_64-full.exe").Length
          $size_mb = [math]::Floor($size / 1024 / 1024)
          Write-Host "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-windows-x86_64-full
          path: python/dist/tea-python-windows-x86_64-full.exe
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - macOS (Native runners)
  # ============================================================
  build-python-macos:
    runs-on: macos-latest
    name: Python darwin-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer python-dotenv pydantic pydot
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary
        run: |
          cd python
          pyinstaller --onefile --name tea-python-darwin-arm64 \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --hidden-import=dotenv \
            --hidden-import=pydantic \
            --hidden-import=pydot \
            --collect-all the_edge_agent \
            --collect-all pydantic \
            --collect-all pydot \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --exclude-module numpy \
            --exclude-module pandas \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          chmod +x python/dist/tea-python-darwin-arm64
          ./python/dist/tea-python-darwin-arm64 --version
          impl=$(./python/dist/tea-python-darwin-arm64 --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -f%z "python/dist/tea-python-darwin-arm64")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-darwin-arm64
          path: python/dist/tea-python-darwin-arm64
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - macOS Full (Native runners)
  # Includes all optional dependencies: LLM, RAG, web, code, graph, storage
  # ============================================================
  build-python-macos-full:
    runs-on: macos-latest
    name: Python darwin-arm64-full

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies (full)
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer python-dotenv pydantic pydot \
                      openai 'numpy<2' chromadb requests RestrictedPython \
                      'pycozo[embedded]' pandas \
                      s3fs gcsfs adlfs lupa kuzu \
                      firebase-admin duckdb
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary (full)
        run: |
          cd python
          pyinstaller --onefile --name tea-python-darwin-arm64-full \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --hidden-import=dotenv \
            --hidden-import=pydantic \
            --hidden-import=pydot \
            --hidden-import=openai \
            --hidden-import=numpy \
            --hidden-import=chromadb \
            --hidden-import=requests \
            --hidden-import=RestrictedPython \
            --hidden-import=pycozo \
            --hidden-import=pandas \
            --hidden-import=s3fs \
            --hidden-import=gcsfs \
            --hidden-import=adlfs \
            --hidden-import=lupa \
            --hidden-import=kuzu \
            --hidden-import=firebase_admin \
            --hidden-import=duckdb \
            --collect-all the_edge_agent \
            --collect-all numpy \
            --collect-all pandas \
            --collect-all firebase_admin \
            --collect-all pydantic \
            --collect-all pydot \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          chmod +x python/dist/tea-python-darwin-arm64-full
          ./python/dist/tea-python-darwin-arm64-full --version
          impl=$(./python/dist/tea-python-darwin-arm64-full --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -f%z "python/dist/tea-python-darwin-arm64-full")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-darwin-arm64-full
          path: python/dist/tea-python-darwin-arm64-full
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Linux x86_64 Prolog (Native runner)
  # Core deps + janus-swi (requires SWI-Prolog 9.1+ on system)
  # Uses glibc dynamic linking for libswipl.so compatibility
  # ============================================================
  build-python-linux-prolog-x86_64:
    runs-on: ubuntu-22.04
    name: Python linux-x86_64-prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install SWI-Prolog 9.1+
        run: |
          # Official PPA required for 9.1+
          sudo apt-add-repository -y ppa:swi-prolog/stable
          sudo apt-get update
          sudo apt-get install -y swi-prolog-nox pkg-config

          # Verify version (must be 9.1+)
          swipl --version
          SWIPL_HOME=$(swipl --dump-runtime-variables | grep PLBASE= | cut -d= -f2 | tr -d '";')
          echo "SWI-Prolog home: $SWIPL_HOME"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer python-dotenv pydantic pydot
          pip install janus-swi
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary
        run: |
          cd python
          pyinstaller --onefile --name tea-python-linux-x86_64-prolog \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --hidden-import=dotenv \
            --hidden-import=janus_swi \
            --hidden-import=pydantic \
            --hidden-import=pydot \
            --collect-all the_edge_agent \
            --collect-all janus_swi \
            --collect-all pydantic \
            --collect-all pydot \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --exclude-module numpy \
            --exclude-module pandas \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          chmod +x python/dist/tea-python-linux-x86_64-prolog
          ./python/dist/tea-python-linux-x86_64-prolog --version
          impl=$(./python/dist/tea-python-linux-x86_64-prolog --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Functional test - run Prolog example
        run: |
          ./python/dist/tea-python-linux-x86_64-prolog run examples/prolog/simple-prolog-agent.yaml --input '{"value": 21}'

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-x86_64-prolog")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Bundle SWI-Prolog runtime for AppImage
        run: |
          # Get the exact SWI-Prolog paths from swipl itself
          SWIPL_HOME=$(swipl --dump-runtime-variables | grep PLBASE= | cut -d= -f2 | tr -d '";')
          SWIPL_LIBDIR=$(swipl --dump-runtime-variables | grep PLLIBDIR= | cut -d= -f2 | tr -d '";')

          echo "SWI-Prolog home: $SWIPL_HOME"
          echo "SWI-Prolog lib: $SWIPL_LIBDIR"

          # Create bundle directory
          mkdir -p python-swipl-runtime-x86_64/lib
          mkdir -p python-swipl-runtime-x86_64/home

          # Copy libswipl.so from the correct location
          cp -L "$SWIPL_LIBDIR"/libswipl.so* python-swipl-runtime-x86_64/lib/

          # Copy the SWI-Prolog home directory
          cp -r "$SWIPL_HOME"/* python-swipl-runtime-x86_64/home/

          # Collect library dependencies
          echo "Collecting library dependencies..."
          BLACKLIST="linux-vdso|ld-linux|libc.so|libm.so|libdl.so|libpthread.so|librt.so|libgcc_s|libstdc++|libz.so"

          : > /tmp/all_deps.txt
          ldd python/dist/tea-python-linux-x86_64-prolog 2>/dev/null | grep "=>" | awk '{print $3}' | grep -v "not found" >> /tmp/all_deps.txt || true

          sort -u /tmp/all_deps.txt | grep -v -E "$BLACKLIST" | while read lib; do
            if [ -n "$lib" ] && [ -f "$lib" ]; then
              BASENAME=$(basename "$lib")
              if [ ! -f "python-swipl-runtime-x86_64/lib/$BASENAME" ]; then
                echo "Bundling: $lib"
                cp -L "$lib" python-swipl-runtime-x86_64/lib/ || true
              fi
            fi
          done

          # Create tarball
          tar -czf python-swipl-runtime-x86_64.tar.gz python-swipl-runtime-x86_64

          echo "Bundle contents:"
          ls -la python-swipl-runtime-x86_64/lib/ | head -20

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-x86_64-prolog
          path: python/dist/tea-python-linux-x86_64-prolog
          retention-days: 1

      - name: Upload SWI-Prolog runtime
        uses: actions/upload-artifact@v4
        with:
          name: python-swipl-runtime-x86_64
          path: python-swipl-runtime-x86_64.tar.gz
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Linux ARM64 Prolog (Native runner)
  # Core deps + janus-swi (requires SWI-Prolog 9.1+ on system)
  # ============================================================
  build-python-linux-prolog-arm64:
    runs-on: ubuntu-24.04-arm
    name: Python linux-arm64-prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install SWI-Prolog 9.1+ (build from source)
        run: |
          # Ubuntu 24.04 has SWI-Prolog 9.0.4, but janus-swi requires >= 9.1.12
          # Build SWI-Prolog 9.3.x from source

          # Install build dependencies
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libgmp-dev libssl-dev \
            zlib1g-dev libarchive-dev libpcre2-dev libyaml-dev \
            libreadline-dev libedit-dev pkg-config

          # Clone and build SWI-Prolog 9.3.x
          git clone --depth 1 --branch V9.3.24 https://github.com/SWI-Prolog/swipl-devel.git /tmp/swipl-devel
          cd /tmp/swipl-devel
          git submodule update --init

          mkdir build && cd build
          cmake -G Ninja -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DSWIPL_PACKAGES_JAVA=OFF \
            -DSWIPL_PACKAGES_X=OFF \
            ..
          ninja
          sudo ninja install

          # Update library path
          echo "/usr/local/lib/swipl/lib/aarch64-linux" | sudo tee /etc/ld.so.conf.d/swipl.conf
          sudo ldconfig

          # Verify version
          swipl --version
          SWIPL_HOME=$(swipl --dump-runtime-variables | grep PLBASE= | cut -d= -f2 | tr -d '";')
          echo "SWI-Prolog home: $SWIPL_HOME"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer python-dotenv pydantic pydot
          pip install janus-swi
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary
        run: |
          cd python
          pyinstaller --onefile --name tea-python-linux-arm64-prolog \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --hidden-import=dotenv \
            --hidden-import=janus_swi \
            --hidden-import=pydantic \
            --hidden-import=pydot \
            --collect-all the_edge_agent \
            --collect-all janus_swi \
            --collect-all pydantic \
            --collect-all pydot \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --exclude-module numpy \
            --exclude-module pandas \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          chmod +x python/dist/tea-python-linux-arm64-prolog
          ./python/dist/tea-python-linux-arm64-prolog --version
          impl=$(./python/dist/tea-python-linux-arm64-prolog --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Functional test - run Prolog example
        run: |
          ./python/dist/tea-python-linux-arm64-prolog run examples/prolog/simple-prolog-agent.yaml --input '{"value": 21}'

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-arm64-prolog")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Bundle SWI-Prolog runtime for AppImage
        run: |
          # Get the exact SWI-Prolog paths from swipl itself
          SWIPL_HOME=$(swipl --dump-runtime-variables | grep PLBASE= | cut -d= -f2 | tr -d '";')
          SWIPL_LIBDIR=$(swipl --dump-runtime-variables | grep PLLIBDIR= | cut -d= -f2 | tr -d '";')

          echo "SWI-Prolog home: $SWIPL_HOME"
          echo "SWI-Prolog lib: $SWIPL_LIBDIR"

          # Create bundle directory
          mkdir -p python-swipl-runtime-aarch64/lib
          mkdir -p python-swipl-runtime-aarch64/home

          # Copy libswipl.so from the correct location
          cp -L "$SWIPL_LIBDIR"/libswipl.so* python-swipl-runtime-aarch64/lib/

          # Copy the SWI-Prolog home directory
          cp -r "$SWIPL_HOME"/* python-swipl-runtime-aarch64/home/

          # Collect library dependencies
          echo "Collecting library dependencies..."
          BLACKLIST="linux-vdso|ld-linux|libc.so|libm.so|libdl.so|libpthread.so|librt.so|libgcc_s|libstdc++|libz.so"

          : > /tmp/all_deps.txt
          ldd python/dist/tea-python-linux-arm64-prolog 2>/dev/null | grep "=>" | awk '{print $3}' | grep -v "not found" >> /tmp/all_deps.txt || true

          sort -u /tmp/all_deps.txt | grep -v -E "$BLACKLIST" | while read lib; do
            if [ -n "$lib" ] && [ -f "$lib" ]; then
              BASENAME=$(basename "$lib")
              if [ ! -f "python-swipl-runtime-aarch64/lib/$BASENAME" ]; then
                echo "Bundling: $lib"
                cp -L "$lib" python-swipl-runtime-aarch64/lib/ || true
              fi
            fi
          done

          # Create tarball
          tar -czf python-swipl-runtime-aarch64.tar.gz python-swipl-runtime-aarch64

          echo "Bundle contents:"
          ls -la python-swipl-runtime-aarch64/lib/ | head -20

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-arm64-prolog
          path: python/dist/tea-python-linux-arm64-prolog
          retention-days: 1

      - name: Upload SWI-Prolog runtime
        uses: actions/upload-artifact@v4
        with:
          name: python-swipl-runtime-aarch64
          path: python-swipl-runtime-aarch64.tar.gz
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Linux x86_64 Full Prolog (Native runner)
  # All optional deps + janus-swi (requires SWI-Prolog 9.1+ on system)
  # ============================================================
  build-python-linux-full-prolog-x86_64:
    runs-on: ubuntu-22.04
    name: Python linux-x86_64-full-prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install SWI-Prolog 9.1+
        run: |
          # Official PPA required for 9.1+
          sudo apt-add-repository -y ppa:swi-prolog/stable
          sudo apt-get update
          sudo apt-get install -y swi-prolog-nox pkg-config

          # Verify version (must be 9.1+)
          swipl --version
          SWIPL_HOME=$(swipl --dump-runtime-variables | grep PLBASE= | cut -d= -f2 | tr -d '";')
          echo "SWI-Prolog home: $SWIPL_HOME"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies (full + janus-swi)
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer python-dotenv pydantic pydot \
                      openai 'numpy<2' chromadb requests RestrictedPython \
                      'pycozo[embedded]' pandas \
                      s3fs gcsfs adlfs lupa kuzu \
                      firebase-admin duckdb
          pip install janus-swi
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary (full + prolog)
        run: |
          cd python
          pyinstaller --onefile --name tea-python-linux-x86_64-full-prolog \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --hidden-import=dotenv \
            --hidden-import=pydantic \
            --hidden-import=pydot \
            --hidden-import=openai \
            --hidden-import=numpy \
            --hidden-import=chromadb \
            --hidden-import=requests \
            --hidden-import=RestrictedPython \
            --hidden-import=pycozo \
            --hidden-import=pandas \
            --hidden-import=s3fs \
            --hidden-import=gcsfs \
            --hidden-import=adlfs \
            --hidden-import=lupa \
            --hidden-import=kuzu \
            --hidden-import=firebase_admin \
            --hidden-import=duckdb \
            --hidden-import=janus_swi \
            --collect-all the_edge_agent \
            --collect-all numpy \
            --collect-all pandas \
            --collect-all firebase_admin \
            --collect-all janus_swi \
            --collect-all pydantic \
            --collect-all pydot \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          chmod +x python/dist/tea-python-linux-x86_64-full-prolog
          ./python/dist/tea-python-linux-x86_64-full-prolog --version
          impl=$(./python/dist/tea-python-linux-x86_64-full-prolog --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Functional test - run Prolog example
        run: |
          ./python/dist/tea-python-linux-x86_64-full-prolog run examples/prolog/simple-prolog-agent.yaml --input '{"value": 21}'

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-x86_64-full-prolog")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Bundle SWI-Prolog runtime for AppImage
        run: |
          # Get the exact SWI-Prolog paths from swipl itself
          SWIPL_HOME=$(swipl --dump-runtime-variables | grep PLBASE= | cut -d= -f2 | tr -d '";')
          SWIPL_LIBDIR=$(swipl --dump-runtime-variables | grep PLLIBDIR= | cut -d= -f2 | tr -d '";')

          echo "SWI-Prolog home: $SWIPL_HOME"
          echo "SWI-Prolog lib: $SWIPL_LIBDIR"

          # Create bundle directory
          mkdir -p python-swipl-runtime-x86_64-full/lib
          mkdir -p python-swipl-runtime-x86_64-full/home

          # Copy libswipl.so from the correct location
          cp -L "$SWIPL_LIBDIR"/libswipl.so* python-swipl-runtime-x86_64-full/lib/

          # Copy the SWI-Prolog home directory
          cp -r "$SWIPL_HOME"/* python-swipl-runtime-x86_64-full/home/

          # Collect library dependencies
          echo "Collecting library dependencies..."
          BLACKLIST="linux-vdso|ld-linux|libc.so|libm.so|libdl.so|libpthread.so|librt.so|libgcc_s|libstdc++|libz.so"

          : > /tmp/all_deps.txt
          ldd python/dist/tea-python-linux-x86_64-full-prolog 2>/dev/null | grep "=>" | awk '{print $3}' | grep -v "not found" >> /tmp/all_deps.txt || true

          sort -u /tmp/all_deps.txt | grep -v -E "$BLACKLIST" | while read lib; do
            if [ -n "$lib" ] && [ -f "$lib" ]; then
              BASENAME=$(basename "$lib")
              if [ ! -f "python-swipl-runtime-x86_64-full/lib/$BASENAME" ]; then
                echo "Bundling: $lib"
                cp -L "$lib" python-swipl-runtime-x86_64-full/lib/ || true
              fi
            fi
          done

          # Create tarball
          tar -czf python-swipl-runtime-x86_64-full.tar.gz python-swipl-runtime-x86_64-full

          echo "Bundle contents:"
          ls -la python-swipl-runtime-x86_64-full/lib/ | head -20

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-x86_64-full-prolog
          path: python/dist/tea-python-linux-x86_64-full-prolog
          retention-days: 1

      - name: Upload SWI-Prolog runtime
        uses: actions/upload-artifact@v4
        with:
          name: python-swipl-runtime-x86_64-full
          path: python-swipl-runtime-x86_64-full.tar.gz
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Linux ARM64 Full Prolog (Native runner)
  # All optional deps + janus-swi (requires SWI-Prolog 9.1+ on system)
  # ============================================================
  build-python-linux-full-prolog-arm64:
    runs-on: ubuntu-24.04-arm
    name: Python linux-arm64-full-prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install SWI-Prolog 9.1+ (build from source)
        run: |
          # Ubuntu 24.04 has SWI-Prolog 9.0.4, but janus-swi requires >= 9.1.12
          # Build SWI-Prolog 9.3.x from source

          # Install build dependencies
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libgmp-dev libssl-dev \
            zlib1g-dev libarchive-dev libpcre2-dev libyaml-dev \
            libreadline-dev libedit-dev pkg-config

          # Clone and build SWI-Prolog 9.3.x
          git clone --depth 1 --branch V9.3.24 https://github.com/SWI-Prolog/swipl-devel.git /tmp/swipl-devel
          cd /tmp/swipl-devel
          git submodule update --init

          mkdir build && cd build
          cmake -G Ninja -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DSWIPL_PACKAGES_JAVA=OFF \
            -DSWIPL_PACKAGES_X=OFF \
            ..
          ninja
          sudo ninja install

          # Update library path
          echo "/usr/local/lib/swipl/lib/aarch64-linux" | sudo tee /etc/ld.so.conf.d/swipl.conf
          sudo ldconfig

          # Verify version
          swipl --version
          SWIPL_HOME=$(swipl --dump-runtime-variables | grep PLBASE= | cut -d= -f2 | tr -d '";')
          echo "SWI-Prolog home: $SWIPL_HOME"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies (full + janus-swi)
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer python-dotenv pydantic pydot \
                      openai 'numpy<2' chromadb requests RestrictedPython \
                      'pycozo[embedded]' pandas \
                      s3fs gcsfs adlfs lupa kuzu \
                      firebase-admin duckdb
          pip install janus-swi
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary (full + prolog)
        run: |
          cd python
          pyinstaller --onefile --name tea-python-linux-arm64-full-prolog \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --hidden-import=dotenv \
            --hidden-import=pydantic \
            --hidden-import=pydot \
            --hidden-import=openai \
            --hidden-import=numpy \
            --hidden-import=chromadb \
            --hidden-import=requests \
            --hidden-import=RestrictedPython \
            --hidden-import=pycozo \
            --hidden-import=pandas \
            --hidden-import=s3fs \
            --hidden-import=gcsfs \
            --hidden-import=adlfs \
            --hidden-import=lupa \
            --hidden-import=kuzu \
            --hidden-import=firebase_admin \
            --hidden-import=duckdb \
            --hidden-import=janus_swi \
            --collect-all the_edge_agent \
            --collect-all numpy \
            --collect-all pandas \
            --collect-all firebase_admin \
            --collect-all janus_swi \
            --collect-all pydantic \
            --collect-all pydot \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          chmod +x python/dist/tea-python-linux-arm64-full-prolog
          ./python/dist/tea-python-linux-arm64-full-prolog --version
          impl=$(./python/dist/tea-python-linux-arm64-full-prolog --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Functional test - run Prolog example
        run: |
          ./python/dist/tea-python-linux-arm64-full-prolog run examples/prolog/simple-prolog-agent.yaml --input '{"value": 21}'

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-arm64-full-prolog")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Bundle SWI-Prolog runtime for AppImage
        run: |
          # Get the exact SWI-Prolog paths from swipl itself
          SWIPL_HOME=$(swipl --dump-runtime-variables | grep PLBASE= | cut -d= -f2 | tr -d '";')
          SWIPL_LIBDIR=$(swipl --dump-runtime-variables | grep PLLIBDIR= | cut -d= -f2 | tr -d '";')

          echo "SWI-Prolog home: $SWIPL_HOME"
          echo "SWI-Prolog lib: $SWIPL_LIBDIR"

          # Create bundle directory
          mkdir -p python-swipl-runtime-aarch64-full/lib
          mkdir -p python-swipl-runtime-aarch64-full/home

          # Copy libswipl.so from the correct location
          cp -L "$SWIPL_LIBDIR"/libswipl.so* python-swipl-runtime-aarch64-full/lib/

          # Copy the SWI-Prolog home directory
          cp -r "$SWIPL_HOME"/* python-swipl-runtime-aarch64-full/home/

          # Collect library dependencies
          echo "Collecting library dependencies..."
          BLACKLIST="linux-vdso|ld-linux|libc.so|libm.so|libdl.so|libpthread.so|librt.so|libgcc_s|libstdc++|libz.so"

          : > /tmp/all_deps.txt
          ldd python/dist/tea-python-linux-arm64-full-prolog 2>/dev/null | grep "=>" | awk '{print $3}' | grep -v "not found" >> /tmp/all_deps.txt || true

          sort -u /tmp/all_deps.txt | grep -v -E "$BLACKLIST" | while read lib; do
            if [ -n "$lib" ] && [ -f "$lib" ]; then
              BASENAME=$(basename "$lib")
              if [ ! -f "python-swipl-runtime-aarch64-full/lib/$BASENAME" ]; then
                echo "Bundling: $lib"
                cp -L "$lib" python-swipl-runtime-aarch64-full/lib/ || true
              fi
            fi
          done

          # Create tarball
          tar -czf python-swipl-runtime-aarch64-full.tar.gz python-swipl-runtime-aarch64-full

          echo "Bundle contents:"
          ls -la python-swipl-runtime-aarch64-full/lib/ | head -20

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-arm64-full-prolog
          path: python/dist/tea-python-linux-arm64-full-prolog
          retention-days: 1

      - name: Upload SWI-Prolog runtime
        uses: actions/upload-artifact@v4
        with:
          name: python-swipl-runtime-aarch64-full
          path: python-swipl-runtime-aarch64-full.tar.gz
          retention-days: 1

  # ============================================================
  # Rust Binaries
  # ============================================================
  build-rust:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact: tea-rust-linux-x86_64
            ext: ''
            use_cross: false
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-musl
            artifact: tea-rust-linux-arm64
            ext: ''
            use_cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: tea-rust-windows-x86_64
            ext: '.exe'
            use_cross: false
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: tea-rust-darwin-arm64
            ext: ''
            use_cross: false
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: tea-rust-darwin-x86_64
            ext: ''
            use_cross: false

    runs-on: ${{ matrix.os }}
    name: Rust ${{ matrix.artifact }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      - name: Install musl tools (Linux x86_64)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Install musl tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools gcc-aarch64-linux-gnu

      - name: Build release binary
        run: |
          cd rust
          cargo build --release --target ${{ matrix.target }} --bin tea

      - name: Copy binary
        run: |
          cp rust/target/${{ matrix.target }}/release/tea${{ matrix.ext }} ${{ matrix.artifact }}${{ matrix.ext }}
        shell: bash

      - name: Set executable permission
        if: runner.os != 'Windows'
        run: |
          chmod +x ${{ matrix.artifact }}${{ matrix.ext }}
        shell: bash

      - name: Smoke test - version
        if: matrix.target != 'x86_64-apple-darwin'
        run: |
          ./${{ matrix.artifact }}${{ matrix.ext }} --version
        shell: bash

      - name: Smoke test - version (x86_64 on ARM64 macOS)
        if: matrix.target == 'x86_64-apple-darwin'
        run: |
          arch -x86_64 ./${{ matrix.artifact }}${{ matrix.ext }} --version
        shell: bash

      - name: Smoke test - impl
        if: matrix.target != 'x86_64-apple-darwin'
        run: |
          impl=$(./${{ matrix.artifact }}${{ matrix.ext }} --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi
        shell: bash

      - name: Smoke test - impl (x86_64 on ARM64 macOS)
        if: matrix.target == 'x86_64-apple-darwin'
        run: |
          impl=$(arch -x86_64 ./${{ matrix.artifact }}${{ matrix.ext }} --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi
        shell: bash

      - name: Verify version matches tag
        if: matrix.target != 'x86_64-apple-darwin'
        run: |
          version=$(./${{ matrix.artifact }}${{ matrix.ext }} --version | awk '{print $2}')
          tag="${GITHUB_REF_NAME#v}"
          if [ "$version" != "$tag" ]; then
            echo "Warning: Binary version ($version) does not match tag ($tag)"
          fi
        shell: bash

      - name: Verify version matches tag (x86_64 on ARM64 macOS)
        if: matrix.target == 'x86_64-apple-darwin'
        run: |
          version=$(arch -x86_64 ./${{ matrix.artifact }}${{ matrix.ext }} --version | awk '{print $2}')
          tag="${GITHUB_REF_NAME#v}"
          if [ "$version" != "$tag" ]; then
            echo "Warning: Binary version ($version) does not match tag ($tag)"
          fi
        shell: bash

      - name: Check binary size
        run: |
          size=$(stat -f%z "${{ matrix.artifact }}${{ matrix.ext }}" 2>/dev/null || stat -c%s "${{ matrix.artifact }}${{ matrix.ext }}")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"
          if [ $size_mb -gt 20 ]; then
            echo "Warning: Binary exceeds 20MB target (${size_mb}MB)"
          fi
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-${{ matrix.artifact }}
          path: ${{ matrix.artifact }}${{ matrix.ext }}
          retention-days: 1

  # ============================================================
  # Rust Prolog Binaries (glibc dynamic linking)
  # These require SWI-Prolog installed on the system
  # ============================================================
  build-rust-prolog-linux-x86_64:
    runs-on: ubuntu-22.04
    name: Rust linux-x86_64-prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install SWI-Prolog
        run: |
          # Use official SWI-Prolog PPA for consistent versioning across build and AppImage jobs
          sudo apt-add-repository -y ppa:swi-prolog/stable
          sudo apt-get update
          sudo apt-get install -y swi-prolog-nox pkg-config

          # Show version for debugging
          swipl --version
          SWIPL_HOME=$(swipl --dump-runtime-variables | grep PLBASE= | cut -d= -f2 | tr -d '";')
          echo "SWI-Prolog home: $SWIPL_HOME"

          # Fix pkg-config path if needed
          SWIPL_LIBDIR=$(swipl --dump-runtime-variables | grep PLLIBDIR= | cut -d= -f2 | tr -d '";')
          if [ ! -f "$SWIPL_LIBDIR/libswipl.so" ]; then
            sudo mkdir -p "$SWIPL_LIBDIR"
            sudo ln -sf /usr/lib/x86_64-linux-gnu/libswipl.so "$SWIPL_LIBDIR/libswipl.so"
          fi

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-x86_64-prolog-cargo-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-x86_64-prolog-cargo-

      - name: Build release binary with Prolog feature
        run: |
          cd rust
          cargo build --release --features prolog --bin tea

      - name: Copy binary
        run: |
          cp rust/target/release/tea tea-rust-linux-x86_64-prolog

      - name: Set executable permission
        run: chmod +x tea-rust-linux-x86_64-prolog

      - name: Smoke test - version
        run: ./tea-rust-linux-x86_64-prolog --version

      - name: Smoke test - impl
        run: |
          impl=$(./tea-rust-linux-x86_64-prolog --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi

      - name: Functional test - run Prolog example
        run: ./tea-rust-linux-x86_64-prolog run examples/prolog/simple-prolog-agent.yaml

      - name: Check binary size
        run: |
          size=$(stat -c%s "tea-rust-linux-x86_64-prolog")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Bundle SWI-Prolog runtime for AppImage
        run: |
          # Get the exact SWI-Prolog paths from the version we built against
          SWIPL_HOME=$(swipl --dump-runtime-variables | grep PLBASE= | cut -d= -f2 | tr -d '";')
          SWIPL_LIBDIR=$(dirname $(ldd tea-rust-linux-x86_64-prolog | grep libswipl | awk '{print $3}'))

          echo "SWI-Prolog home: $SWIPL_HOME"
          echo "SWI-Prolog lib: $SWIPL_LIBDIR"

          # Create bundle directory
          mkdir -p swipl-runtime-x86_64/lib
          mkdir -p swipl-runtime-x86_64/home

          # Copy libswipl.so
          cp -L "$SWIPL_LIBDIR"/libswipl.so* swipl-runtime-x86_64/lib/

          # Copy the SWI-Prolog home directory
          cp -r "$SWIPL_HOME"/* swipl-runtime-x86_64/home/

          # Collect ALL library dependencies from tea binary and SWI-Prolog extensions
          echo "Collecting all library dependencies..."

          # System libraries to exclude (linuxdeploy blacklists these)
          BLACKLIST="linux-vdso|ld-linux|libc.so|libm.so|libdl.so|libpthread.so|librt.so|libgcc_s|libstdc++|libz.so|libgmp.so"

          # Collect deps from tea binary and all SWI-Prolog .so extensions into a file
          : > /tmp/all_deps.txt
          ldd tea-rust-linux-x86_64-prolog 2>/dev/null | grep "=>" | awk '{print $3}' | grep -v "not found" >> /tmp/all_deps.txt || true
          for so in swipl-runtime-x86_64/home/lib/x86_64-linux/*.so; do
            if [ -f "$so" ]; then
              ldd "$so" 2>/dev/null | grep "=>" | awk '{print $3}' | grep -v "not found" >> /tmp/all_deps.txt || true
            fi
          done

          # Remove duplicates, filter blacklist, and copy libraries
          sort -u /tmp/all_deps.txt | grep -v -E "$BLACKLIST" | while read lib; do
            if [ -n "$lib" ] && [ -f "$lib" ]; then
              BASENAME=$(basename "$lib")
              if [ ! -f "swipl-runtime-x86_64/lib/$BASENAME" ]; then
                echo "Bundling: $lib"
                cp -L "$lib" swipl-runtime-x86_64/lib/ || true
              fi
            fi
          done

          # Create tarball
          tar -czf swipl-runtime-x86_64.tar.gz swipl-runtime-x86_64

          echo "Bundle contents:"
          ls -la swipl-runtime-x86_64/lib/
          echo "---"
          ls -la swipl-runtime-x86_64/home/ | head -10

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-tea-rust-linux-x86_64-prolog
          path: tea-rust-linux-x86_64-prolog
          retention-days: 1

      - name: Upload SWI-Prolog runtime
        uses: actions/upload-artifact@v4
        with:
          name: swipl-runtime-x86_64
          path: swipl-runtime-x86_64.tar.gz
          retention-days: 1

  build-rust-prolog-linux-arm64:
    runs-on: ubuntu-24.04-arm
    name: Rust linux-arm64-prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install SWI-Prolog
        run: |
          # Use official SWI-Prolog PPA for consistent versioning across build and AppImage jobs
          sudo apt-add-repository -y ppa:swi-prolog/stable
          sudo apt-get update
          sudo apt-get install -y swi-prolog-nox pkg-config

          # Show version for debugging
          swipl --version
          SWIPL_HOME=$(swipl --dump-runtime-variables | grep PLBASE= | cut -d= -f2 | tr -d '";')
          echo "SWI-Prolog home: $SWIPL_HOME"

          # Fix pkg-config path if needed
          SWIPL_LIBDIR=$(swipl --dump-runtime-variables | grep PLLIBDIR= | cut -d= -f2 | tr -d '";')
          if [ ! -f "$SWIPL_LIBDIR/libswipl.so" ]; then
            sudo mkdir -p "$SWIPL_LIBDIR"
            sudo ln -sf /usr/lib/aarch64-linux-gnu/libswipl.so "$SWIPL_LIBDIR/libswipl.so"
          fi

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-aarch64-prolog-cargo-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-aarch64-prolog-cargo-

      - name: Build release binary with Prolog feature
        run: |
          cd rust
          cargo build --release --features prolog --bin tea

      - name: Copy binary
        run: |
          cp rust/target/release/tea tea-rust-linux-arm64-prolog

      - name: Set executable permission
        run: chmod +x tea-rust-linux-arm64-prolog

      - name: Smoke test - version
        run: ./tea-rust-linux-arm64-prolog --version

      - name: Smoke test - impl
        run: |
          impl=$(./tea-rust-linux-arm64-prolog --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi

      - name: Functional test - run Prolog example
        run: ./tea-rust-linux-arm64-prolog run examples/prolog/simple-prolog-agent.yaml

      - name: Check binary size
        run: |
          size=$(stat -c%s "tea-rust-linux-arm64-prolog")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Bundle SWI-Prolog runtime for AppImage
        run: |
          # Get the exact SWI-Prolog paths from the version we built against
          SWIPL_HOME=$(swipl --dump-runtime-variables | grep PLBASE= | cut -d= -f2 | tr -d '";')
          SWIPL_LIBDIR=$(dirname $(ldd tea-rust-linux-arm64-prolog | grep libswipl | awk '{print $3}'))

          echo "SWI-Prolog home: $SWIPL_HOME"
          echo "SWI-Prolog lib: $SWIPL_LIBDIR"

          # Create bundle directory
          mkdir -p swipl-runtime-aarch64/lib
          mkdir -p swipl-runtime-aarch64/home

          # Copy libswipl.so
          cp -L "$SWIPL_LIBDIR"/libswipl.so* swipl-runtime-aarch64/lib/

          # Copy the SWI-Prolog home directory
          cp -r "$SWIPL_HOME"/* swipl-runtime-aarch64/home/

          # Collect ALL library dependencies from tea binary and SWI-Prolog extensions
          echo "Collecting all library dependencies..."

          # System libraries to exclude (linuxdeploy blacklists these)
          BLACKLIST="linux-vdso|ld-linux|libc.so|libm.so|libdl.so|libpthread.so|librt.so|libgcc_s|libstdc++|libz.so|libgmp.so"

          # Collect deps from tea binary and all SWI-Prolog .so extensions into a file
          : > /tmp/all_deps.txt
          ldd tea-rust-linux-arm64-prolog 2>/dev/null | grep "=>" | awk '{print $3}' | grep -v "not found" >> /tmp/all_deps.txt || true
          for so in swipl-runtime-aarch64/home/lib/aarch64-linux/*.so; do
            if [ -f "$so" ]; then
              ldd "$so" 2>/dev/null | grep "=>" | awk '{print $3}' | grep -v "not found" >> /tmp/all_deps.txt || true
            fi
          done

          # Remove duplicates, filter blacklist, and copy libraries
          sort -u /tmp/all_deps.txt | grep -v -E "$BLACKLIST" | while read lib; do
            if [ -n "$lib" ] && [ -f "$lib" ]; then
              BASENAME=$(basename "$lib")
              if [ ! -f "swipl-runtime-aarch64/lib/$BASENAME" ]; then
                echo "Bundling: $lib"
                cp -L "$lib" swipl-runtime-aarch64/lib/ || true
              fi
            fi
          done

          # Create tarball
          tar -czf swipl-runtime-aarch64.tar.gz swipl-runtime-aarch64

          echo "Bundle contents:"
          ls -la swipl-runtime-aarch64/lib/
          echo "---"
          ls -la swipl-runtime-aarch64/home/ | head -10

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-tea-rust-linux-arm64-prolog
          path: tea-rust-linux-arm64-prolog
          retention-days: 1

      - name: Upload SWI-Prolog runtime
        uses: actions/upload-artifact@v4
        with:
          name: swipl-runtime-aarch64
          path: swipl-runtime-aarch64.tar.gz
          retention-days: 1

  # ============================================================
  # AppImage Distribution (Linux only - self-contained with Prolog)
  # Uses linuxdeploy for automatic dependency bundling
  # ============================================================
  build-appimage-x86_64:
    runs-on: ubuntu-22.04
    needs: [build-rust-prolog-linux-x86_64]
    name: Rust AppImage x86_64 with Prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          # libfuse2: Required for running AppImages
          # libossp-uuid16: Required by SWI-Prolog uuid.so module
          sudo apt-get install -y file libfuse2 libossp-uuid16

      - name: Download Prolog binary
        uses: actions/download-artifact@v4
        with:
          name: rust-tea-rust-linux-x86_64-prolog
          path: .

      - name: Download SWI-Prolog runtime from build job
        uses: actions/download-artifact@v4
        with:
          name: swipl-runtime-x86_64
          path: .

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Create .desktop file
        run: |
          cat > tea.desktop << 'EOF'
          [Desktop Entry]
          Name=The Edge Agent
          Comment=Lightweight state graph workflow engine
          Exec=tea
          Icon=tea
          Type=Application
          Categories=Development;
          Terminal=true
          EOF
          sed -i 's/^[[:space:]]*//' tea.desktop

      - name: Create placeholder icon
        run: |
          # Create a simple placeholder SVG icon (256x256)
          cat > tea.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="#2d3748"/>
            <text x="128" y="160" font-family="monospace" font-size="120" fill="#48bb78" text-anchor="middle">t</text>
          </svg>
          EOF

      - name: Create AppDir structure
        run: |
          mkdir -p tea.AppDir/usr/bin
          mkdir -p tea.AppDir/usr/lib/swipl
          chmod +x tea-rust-linux-x86_64-prolog
          cp tea-rust-linux-x86_64-prolog tea.AppDir/usr/bin/tea

      - name: Bundle SWI-Prolog runtime
        run: |
          # Extract the SWI-Prolog runtime bundled from the build job
          # This ensures we use the EXACT same version that the binary was compiled against
          tar -xzf swipl-runtime-x86_64.tar.gz

          echo "Bundling SWI-Prolog runtime from build job artifact"

          # Copy home directory contents
          cp -r swipl-runtime-x86_64/home/* tea.AppDir/usr/lib/swipl/

          # Copy libswipl.so to usr/lib
          mkdir -p tea.AppDir/usr/lib
          cp -L swipl-runtime-x86_64/lib/libswipl.so* tea.AppDir/usr/lib/

          # Ensure proper symlink chain exists (libswipl.so.9 -> libswipl.so.9.x.x)
          cd tea.AppDir/usr/lib
          # Find the full versioned library (e.g., libswipl.so.9.2.9)
          FULL_LIB=$(ls libswipl.so.*.*.* 2>/dev/null | head -1 || true)
          if [ -n "$FULL_LIB" ]; then
            # Extract major version (e.g., 9 from libswipl.so.9.2.9)
            MAJOR_VERSION=$(echo "$FULL_LIB" | sed 's/libswipl.so.\([0-9]*\).*/\1/')
            # Create symlinks if they don't exist
            [ ! -e "libswipl.so.${MAJOR_VERSION}" ] && ln -sf "$FULL_LIB" "libswipl.so.${MAJOR_VERSION}"
            [ ! -e "libswipl.so" ] && ln -sf "libswipl.so.${MAJOR_VERSION}" "libswipl.so"
          fi
          cd ../../..

          # Verify boot.prc exists (critical for VM initialization)
          if [ ! -f "tea.AppDir/usr/lib/swipl/boot.prc" ]; then
            echo "ERROR: boot.prc not found after copy"
            ls -la tea.AppDir/usr/lib/swipl/
            exit 1
          fi

          echo "Bundled SWI-Prolog contents:"
          ls -la tea.AppDir/usr/lib/swipl/
          ls -la tea.AppDir/usr/lib/libswipl*

      - name: Run linuxdeploy
        run: |
          # linuxdeploy bundles shared libraries automatically
          # Set LD_LIBRARY_PATH so linuxdeploy can find libswipl.so in our AppDir
          export LD_LIBRARY_PATH="$(pwd)/tea.AppDir/usr/lib:${LD_LIBRARY_PATH}"

          ./linuxdeploy-x86_64.AppImage \
            --appdir tea.AppDir \
            --executable tea.AppDir/usr/bin/tea \
            --desktop-file tea.desktop \
            --icon-file tea.svg \
            --output appimage

      - name: Create custom AppRun
        run: |
          # Replace default AppRun with custom one that sets SWI_HOME_DIR
          rm -f tea.AppDir/AppRun
          cat > tea.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export SWI_HOME_DIR="${HERE}/usr/lib/swipl"
          exec "${HERE}/usr/bin/tea" "$@"
          EOF
          chmod +x tea.AppDir/AppRun

      - name: Rebuild AppImage with custom AppRun
        run: |
          # Get version from tag or use 'dev'
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi

          # Download appimagetool for final packaging
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # Create final AppImage with proper naming
          ARCH=x86_64 ./appimagetool-x86_64.AppImage tea.AppDir "tea-${VERSION}-x86_64.AppImage"

      - name: Smoke test AppImage
        run: |
          chmod +x tea-*-x86_64.AppImage
          ./tea-*-x86_64.AppImage --version
          impl=$(./tea-*-x86_64.AppImage --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi

      - name: Test AppImage on clean Ubuntu container
        run: |
          docker run --rm -v $(pwd):/work ubuntu:24.04 bash -c '
            chmod +x /work/tea-*-x86_64.AppImage
            # Use --appimage-extract-and-run to avoid FUSE requirement in Docker
            # Only test --version here; full agent test runs natively with FUSE in smoke test
            /work/tea-*-x86_64.AppImage --appimage-extract-and-run --version
          '

      - name: Check AppImage size
        run: |
          size=$(stat -c%s tea-*-x86_64.AppImage)
          size_mb=$((size / 1024 / 1024))
          echo "AppImage size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: appimage-x86_64
          path: tea-*-x86_64.AppImage
          retention-days: 1

  build-appimage-aarch64:
    runs-on: ubuntu-24.04-arm
    needs: [build-rust-prolog-linux-arm64]
    name: Rust AppImage aarch64 with Prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          # libfuse2: Required for running AppImages
          # libossp-uuid16: Required by SWI-Prolog uuid.so module
          sudo apt-get install -y file libfuse2 libossp-uuid16

      - name: Download Prolog binary
        uses: actions/download-artifact@v4
        with:
          name: rust-tea-rust-linux-arm64-prolog
          path: .

      - name: Download SWI-Prolog runtime from build job
        uses: actions/download-artifact@v4
        with:
          name: swipl-runtime-aarch64
          path: .

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
          chmod +x linuxdeploy-aarch64.AppImage

      - name: Create .desktop file
        run: |
          cat > tea.desktop << 'EOF'
          [Desktop Entry]
          Name=The Edge Agent
          Comment=Lightweight state graph workflow engine
          Exec=tea
          Icon=tea
          Type=Application
          Categories=Development;
          Terminal=true
          EOF
          sed -i 's/^[[:space:]]*//' tea.desktop

      - name: Create placeholder icon
        run: |
          # Create a simple placeholder SVG icon (256x256)
          cat > tea.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="#2d3748"/>
            <text x="128" y="160" font-family="monospace" font-size="120" fill="#48bb78" text-anchor="middle">t</text>
          </svg>
          EOF

      - name: Create AppDir structure
        run: |
          mkdir -p tea.AppDir/usr/bin
          mkdir -p tea.AppDir/usr/lib/swipl
          chmod +x tea-rust-linux-arm64-prolog
          cp tea-rust-linux-arm64-prolog tea.AppDir/usr/bin/tea

      - name: Bundle SWI-Prolog runtime
        run: |
          # Extract the SWI-Prolog runtime bundled from the build job
          # This ensures we use the EXACT same version that the binary was compiled against
          tar -xzf swipl-runtime-aarch64.tar.gz

          echo "Bundling SWI-Prolog runtime from build job artifact"

          # Copy home directory contents
          cp -r swipl-runtime-aarch64/home/* tea.AppDir/usr/lib/swipl/

          # Copy libswipl.so to usr/lib
          mkdir -p tea.AppDir/usr/lib
          cp -L swipl-runtime-aarch64/lib/libswipl.so* tea.AppDir/usr/lib/

          # Ensure proper symlink chain exists (libswipl.so.9 -> libswipl.so.9.x.x)
          cd tea.AppDir/usr/lib
          # Find the full versioned library (e.g., libswipl.so.9.2.9)
          FULL_LIB=$(ls libswipl.so.*.*.* 2>/dev/null | head -1 || true)
          if [ -n "$FULL_LIB" ]; then
            # Extract major version (e.g., 9 from libswipl.so.9.2.9)
            MAJOR_VERSION=$(echo "$FULL_LIB" | sed 's/libswipl.so.\([0-9]*\).*/\1/')
            # Create symlinks if they don't exist
            [ ! -e "libswipl.so.${MAJOR_VERSION}" ] && ln -sf "$FULL_LIB" "libswipl.so.${MAJOR_VERSION}"
            [ ! -e "libswipl.so" ] && ln -sf "libswipl.so.${MAJOR_VERSION}" "libswipl.so"
          fi
          cd ../../..

          # Verify boot.prc exists (critical for VM initialization)
          if [ ! -f "tea.AppDir/usr/lib/swipl/boot.prc" ]; then
            echo "ERROR: boot.prc not found after copy"
            ls -la tea.AppDir/usr/lib/swipl/
            exit 1
          fi

          echo "Bundled SWI-Prolog contents:"
          ls -la tea.AppDir/usr/lib/swipl/
          ls -la tea.AppDir/usr/lib/libswipl*

      - name: Run linuxdeploy
        run: |
          # linuxdeploy bundles shared libraries automatically
          # Set LD_LIBRARY_PATH so linuxdeploy can find libswipl.so in our AppDir
          export LD_LIBRARY_PATH="$(pwd)/tea.AppDir/usr/lib:${LD_LIBRARY_PATH}"

          ./linuxdeploy-aarch64.AppImage \
            --appdir tea.AppDir \
            --executable tea.AppDir/usr/bin/tea \
            --desktop-file tea.desktop \
            --icon-file tea.svg \
            --output appimage

      - name: Create custom AppRun
        run: |
          # Replace default AppRun with custom one that sets SWI_HOME_DIR
          rm -f tea.AppDir/AppRun
          cat > tea.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export SWI_HOME_DIR="${HERE}/usr/lib/swipl"
          exec "${HERE}/usr/bin/tea" "$@"
          EOF
          chmod +x tea.AppDir/AppRun

      - name: Rebuild AppImage with custom AppRun
        run: |
          # Get version from tag or use 'dev'
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi

          # Download appimagetool for final packaging
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
          chmod +x appimagetool-aarch64.AppImage

          # Create final AppImage with proper naming
          ARCH=aarch64 ./appimagetool-aarch64.AppImage tea.AppDir "tea-${VERSION}-aarch64.AppImage"

      - name: Smoke test AppImage
        run: |
          chmod +x tea-*-aarch64.AppImage
          ./tea-*-aarch64.AppImage --version
          impl=$(./tea-*-aarch64.AppImage --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi

      - name: Test AppImage in Docker container
        run: |
          # Note: Can't run aarch64 Docker images on aarch64 native runners easily
          # Just verify the AppImage runs natively
          ./tea-*-aarch64.AppImage run examples/prolog/simple-prolog-agent.yaml

      - name: Check AppImage size
        run: |
          size=$(stat -c%s tea-*-aarch64.AppImage)
          size_mb=$((size / 1024 / 1024))
          echo "AppImage size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: appimage-aarch64
          path: tea-*-aarch64.AppImage
          retention-days: 1

  # ============================================================
  # Rust LLM AppImage Distribution (TEA-RELEASE-004.1)
  # Self-contained AppImages with bundled GGUF models
  # Variants: Gemma (~5GB, best quality) and Phi-4-mini (~2.5GB, compact)
  # ============================================================

  # Build Rust binary with llm-local feature for x86_64
  build-rust-llm-linux-x86_64:
    runs-on: ubuntu-22.04
    name: Rust linux-x86_64-llm

    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-x86_64-llm-cargo-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-x86_64-llm-cargo-

      - name: Build release binary with LLM feature
        run: |
          cd rust
          cargo build --release --features llm-local --bin tea

      - name: Copy binary
        run: |
          cp rust/target/release/tea tea-rust-linux-x86_64-llm

      - name: Set executable permission
        run: chmod +x tea-rust-linux-x86_64-llm

      - name: Smoke test - version
        run: ./tea-rust-linux-x86_64-llm --version

      - name: Smoke test - impl
        run: |
          impl=$(./tea-rust-linux-x86_64-llm --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -c%s "tea-rust-linux-x86_64-llm")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-tea-rust-linux-x86_64-llm
          path: tea-rust-linux-x86_64-llm
          retention-days: 1

  # Build Rust binary with llm-local feature for ARM64
  build-rust-llm-linux-arm64:
    runs-on: ubuntu-24.04-arm
    name: Rust linux-arm64-llm

    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-arm64-llm-cargo-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-arm64-llm-cargo-

      - name: Build release binary with LLM feature
        run: |
          cd rust
          cargo build --release --features llm-local --bin tea

      - name: Copy binary
        run: |
          cp rust/target/release/tea tea-rust-linux-arm64-llm

      - name: Set executable permission
        run: chmod +x tea-rust-linux-arm64-llm

      - name: Smoke test - version
        run: ./tea-rust-linux-arm64-llm --version

      - name: Smoke test - impl
        run: |
          impl=$(./tea-rust-linux-arm64-llm --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -c%s "tea-rust-linux-arm64-llm")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-tea-rust-linux-arm64-llm
          path: tea-rust-linux-arm64-llm
          retention-days: 1

  # Gemma LLM AppImage for x86_64 (~5GB, best quality)
  build-rust-llm-gemma-appimage-x86_64:
    runs-on: ubuntu-22.04
    needs: [build-rust-llm-linux-x86_64]
    name: Rust LLM AppImage x86_64 (Gemma)

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y file libfuse2

      - name: Download LLM binary
        uses: actions/download-artifact@v4
        with:
          name: rust-tea-rust-linux-x86_64-llm
          path: .

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Download Gemma model from HuggingFace
        run: |
          mkdir -p models
          # Download Gemma 3n E4B Instruct Q4_K_M (~4.2GB)
          wget -q --show-progress -O models/gemma-3n-E4B-it-Q4_K_M.gguf \
            "https://huggingface.co/bartowski/google_gemma-3n-E4B-it-GGUF/resolve/main/gemma-3n-E4B-it-Q4_K_M.gguf" || {
            echo "Primary download failed, trying mirror..."
            wget -q --show-progress -O models/gemma-3n-E4B-it-Q4_K_M.gguf \
              "https://huggingface.co/unsloth/gemma-3n-E4B-it-GGUF/resolve/main/gemma-3n-E4B-it-Q4_K_M.gguf"
          }
          ls -lh models/

      - name: Create .desktop file
        run: |
          cat > tea-llm.desktop << 'EOF'
          [Desktop Entry]
          Name=The Edge Agent (LLM)
          Comment=Lightweight state graph workflow engine with local LLM
          Exec=tea
          Icon=tea
          Type=Application
          Categories=Development;
          Terminal=true
          EOF
          sed -i 's/^[[:space:]]*//' tea-llm.desktop

      - name: Create placeholder icon
        run: |
          cat > tea.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="#2d3748"/>
            <text x="128" y="160" font-family="monospace" font-size="120" fill="#48bb78" text-anchor="middle">t</text>
          </svg>
          EOF

      - name: Create AppDir structure
        run: |
          mkdir -p tea-llm.AppDir/usr/bin
          mkdir -p tea-llm.AppDir/usr/lib
          mkdir -p tea-llm.AppDir/usr/share/models
          chmod +x tea-rust-linux-x86_64-llm
          cp tea-rust-linux-x86_64-llm tea-llm.AppDir/usr/bin/tea
          cp models/gemma-3n-E4B-it-Q4_K_M.gguf tea-llm.AppDir/usr/share/models/

      - name: Run linuxdeploy
        run: |
          ./linuxdeploy-x86_64.AppImage \
            --appdir tea-llm.AppDir \
            --executable tea-llm.AppDir/usr/bin/tea \
            --desktop-file tea-llm.desktop \
            --icon-file tea.svg \
            --output appimage

      - name: Create custom AppRun
        run: |
          rm -f tea-llm.AppDir/AppRun
          cat > tea-llm.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          # Auto-detect model in bundled models directory
          if [ -z "$TEA_MODEL_PATH" ]; then
            MODEL_FILE=$(find "${HERE}/usr/share/models" -name "*.gguf" -type f | head -1)
            if [ -n "$MODEL_FILE" ]; then
              export TEA_MODEL_PATH="$MODEL_FILE"
            fi
          fi
          exec "${HERE}/usr/bin/tea" "$@"
          EOF
          chmod +x tea-llm.AppDir/AppRun

      - name: Rebuild AppImage with custom AppRun
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage tea-llm.AppDir "tea-rust-llm-gemma-${VERSION}-x86_64.AppImage"

      - name: Smoke test AppImage
        run: |
          chmod +x tea-rust-llm-gemma-*-x86_64.AppImage
          ./tea-rust-llm-gemma-*-x86_64.AppImage --version
          impl=$(./tea-rust-llm-gemma-*-x86_64.AppImage --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi

      - name: Check AppImage size
        run: |
          size=$(stat -c%s tea-rust-llm-gemma-*-x86_64.AppImage)
          size_mb=$((size / 1024 / 1024))
          echo "AppImage size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: llm-appimage-gemma-x86_64
          path: tea-rust-llm-gemma-*-x86_64.AppImage
          retention-days: 1

  # Phi-4-mini LLM AppImage for x86_64 (~2.5GB, compact)
  build-rust-llm-phi4-appimage-x86_64:
    runs-on: ubuntu-22.04
    needs: [build-rust-llm-linux-x86_64]
    name: Rust LLM AppImage x86_64 (Phi-4)

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y file libfuse2

      - name: Download LLM binary
        uses: actions/download-artifact@v4
        with:
          name: rust-tea-rust-linux-x86_64-llm
          path: .

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Download Phi-4-mini model from HuggingFace
        run: |
          mkdir -p models
          echo "Downloading Phi-4-mini Q3_K_S model (~1.9GB)..."
          wget -q --show-progress \
            "https://huggingface.co/bartowski/microsoft_Phi-4-mini-instruct-GGUF/resolve/main/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf" \
            -O models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf
          ls -lh models/

      - name: Create .desktop file
        run: |
          cat > tea-llm.desktop << 'EOF'
          [Desktop Entry]
          Name=The Edge Agent (LLM Phi-4)
          Comment=Lightweight state graph workflow engine with local LLM
          Exec=tea
          Icon=tea
          Type=Application
          Categories=Development;
          Terminal=true
          EOF
          sed -i 's/^[[:space:]]*//' tea-llm.desktop

      - name: Create placeholder icon
        run: |
          cat > tea.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="#2d3748"/>
            <text x="128" y="160" font-family="monospace" font-size="120" fill="#48bb78" text-anchor="middle">t</text>
          </svg>
          EOF

      - name: Create AppDir structure
        run: |
          mkdir -p tea-llm.AppDir/usr/bin
          mkdir -p tea-llm.AppDir/usr/lib
          mkdir -p tea-llm.AppDir/usr/share/models
          chmod +x tea-rust-linux-x86_64-llm
          cp tea-rust-linux-x86_64-llm tea-llm.AppDir/usr/bin/tea
          cp models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf tea-llm.AppDir/usr/share/models/

      - name: Run linuxdeploy
        run: |
          ./linuxdeploy-x86_64.AppImage \
            --appdir tea-llm.AppDir \
            --executable tea-llm.AppDir/usr/bin/tea \
            --desktop-file tea-llm.desktop \
            --icon-file tea.svg \
            --output appimage

      - name: Create custom AppRun
        run: |
          rm -f tea-llm.AppDir/AppRun
          cat > tea-llm.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          # Auto-detect model in bundled models directory
          if [ -z "$TEA_MODEL_PATH" ]; then
            MODEL_FILE=$(find "${HERE}/usr/share/models" -name "*.gguf" -type f | head -1)
            if [ -n "$MODEL_FILE" ]; then
              export TEA_MODEL_PATH="$MODEL_FILE"
            fi
          fi
          exec "${HERE}/usr/bin/tea" "$@"
          EOF
          chmod +x tea-llm.AppDir/AppRun

      - name: Rebuild AppImage with custom AppRun
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage tea-llm.AppDir "tea-rust-llm-phi4-${VERSION}-x86_64.AppImage"

      - name: Smoke test AppImage
        run: |
          chmod +x tea-rust-llm-phi4-*-x86_64.AppImage
          ./tea-rust-llm-phi4-*-x86_64.AppImage --version
          impl=$(./tea-rust-llm-phi4-*-x86_64.AppImage --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi

      - name: Check AppImage size
        run: |
          size=$(stat -c%s tea-rust-llm-phi4-*-x86_64.AppImage)
          size_mb=$((size / 1024 / 1024))
          echo "AppImage size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: llm-appimage-phi4-x86_64
          path: tea-rust-llm-phi4-*-x86_64.AppImage
          retention-days: 1

  # Phi-4-mini LLM AppImage for ARM64 (~2.5GB, compact)
  build-rust-llm-phi4-appimage-aarch64:
    runs-on: ubuntu-24.04-arm
    needs: [build-rust-llm-linux-arm64]
    name: Rust LLM AppImage aarch64 (Phi-4)

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y file libfuse2

      - name: Download LLM binary
        uses: actions/download-artifact@v4
        with:
          name: rust-tea-rust-linux-arm64-llm
          path: .

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
          chmod +x linuxdeploy-aarch64.AppImage

      - name: Download Phi-4-mini model from HuggingFace
        run: |
          mkdir -p models
          echo "Downloading Phi-4-mini Q3_K_S model (~1.9GB)..."
          wget -q --show-progress \
            "https://huggingface.co/bartowski/microsoft_Phi-4-mini-instruct-GGUF/resolve/main/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf" \
            -O models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf
          ls -lh models/

      - name: Create .desktop file
        run: |
          cat > tea-llm.desktop << 'EOF'
          [Desktop Entry]
          Name=The Edge Agent (LLM Phi-4)
          Comment=Lightweight state graph workflow engine with local LLM
          Exec=tea
          Icon=tea
          Type=Application
          Categories=Development;
          Terminal=true
          EOF
          sed -i 's/^[[:space:]]*//' tea-llm.desktop

      - name: Create placeholder icon
        run: |
          cat > tea.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="#2d3748"/>
            <text x="128" y="160" font-family="monospace" font-size="120" fill="#48bb78" text-anchor="middle">t</text>
          </svg>
          EOF

      - name: Create AppDir structure
        run: |
          mkdir -p tea-llm.AppDir/usr/bin
          mkdir -p tea-llm.AppDir/usr/lib
          mkdir -p tea-llm.AppDir/usr/share/models
          chmod +x tea-rust-linux-arm64-llm
          cp tea-rust-linux-arm64-llm tea-llm.AppDir/usr/bin/tea
          cp models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf tea-llm.AppDir/usr/share/models/

      - name: Run linuxdeploy
        run: |
          ./linuxdeploy-aarch64.AppImage \
            --appdir tea-llm.AppDir \
            --executable tea-llm.AppDir/usr/bin/tea \
            --desktop-file tea-llm.desktop \
            --icon-file tea.svg \
            --output appimage

      - name: Create custom AppRun
        run: |
          rm -f tea-llm.AppDir/AppRun
          cat > tea-llm.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          # Auto-detect model in bundled models directory
          if [ -z "$TEA_MODEL_PATH" ]; then
            MODEL_FILE=$(find "${HERE}/usr/share/models" -name "*.gguf" -type f | head -1)
            if [ -n "$MODEL_FILE" ]; then
              export TEA_MODEL_PATH="$MODEL_FILE"
            fi
          fi
          exec "${HERE}/usr/bin/tea" "$@"
          EOF
          chmod +x tea-llm.AppDir/AppRun

      - name: Rebuild AppImage with custom AppRun
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
          chmod +x appimagetool-aarch64.AppImage
          ARCH=aarch64 ./appimagetool-aarch64.AppImage tea-llm.AppDir "tea-rust-llm-phi4-${VERSION}-aarch64.AppImage"

      - name: Smoke test AppImage
        run: |
          chmod +x tea-rust-llm-phi4-*-aarch64.AppImage
          ./tea-rust-llm-phi4-*-aarch64.AppImage --version
          impl=$(./tea-rust-llm-phi4-*-aarch64.AppImage --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi

      - name: Check AppImage size
        run: |
          size=$(stat -c%s tea-rust-llm-phi4-*-aarch64.AppImage)
          size_mb=$((size / 1024 / 1024))
          echo "AppImage size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: llm-appimage-phi4-aarch64
          path: tea-rust-llm-phi4-*-aarch64.AppImage
          retention-days: 1

  # ============================================================
  # Python AppImage Distribution (Linux only - self-contained with Prolog)
  # Uses tea-python-linux-{arch}-full-prolog as base binary
  # Bundles ALL optional dependencies + janus-swi + libswipl.so + SWI-Prolog runtime
  # ============================================================
  build-python-appimage-x86_64:
    runs-on: ubuntu-22.04
    needs: [build-python-linux-full-prolog-x86_64]
    name: Python AppImage x86_64 with Prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          # libfuse2: Required for running AppImages
          # libossp-uuid16: Required by SWI-Prolog uuid.so module
          sudo apt-get install -y file libfuse2 libossp-uuid16

      - name: Download Python Full Prolog binary
        uses: actions/download-artifact@v4
        with:
          name: python-linux-x86_64-full-prolog
          path: .

      - name: Download SWI-Prolog runtime from build job
        uses: actions/download-artifact@v4
        with:
          name: python-swipl-runtime-x86_64-full
          path: .

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Create .desktop file
        run: |
          cat > tea-python.desktop << 'EOF'
          [Desktop Entry]
          Name=The Edge Agent (Python)
          Comment=Lightweight state graph workflow engine - Python implementation
          Exec=tea
          Icon=tea-python
          Type=Application
          Categories=Development;
          Terminal=true
          EOF
          sed -i 's/^[[:space:]]*//' tea-python.desktop

      - name: Create placeholder icon
        run: |
          # Create a simple placeholder SVG icon (256x256) with Python colors
          cat > tea-python.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="#306998"/>
            <text x="128" y="160" font-family="monospace" font-size="100" fill="#FFD43B" text-anchor="middle">py</text>
          </svg>
          EOF

      - name: Create AppDir structure
        run: |
          mkdir -p tea-python.AppDir/usr/bin
          mkdir -p tea-python.AppDir/usr/lib/swipl
          chmod +x tea-python-linux-x86_64-full-prolog
          cp tea-python-linux-x86_64-full-prolog tea-python.AppDir/usr/bin/tea

      - name: Bundle SWI-Prolog runtime
        run: |
          # Extract the SWI-Prolog runtime bundled from the build job
          # This ensures we use the EXACT same version that the binary was compiled against
          tar -xzf python-swipl-runtime-x86_64-full.tar.gz

          echo "Bundling SWI-Prolog runtime from build job artifact"

          # Copy home directory contents
          cp -r python-swipl-runtime-x86_64-full/home/* tea-python.AppDir/usr/lib/swipl/

          # Copy libswipl.so to usr/lib
          mkdir -p tea-python.AppDir/usr/lib
          cp -L python-swipl-runtime-x86_64-full/lib/libswipl.so* tea-python.AppDir/usr/lib/

          # Ensure proper symlink chain exists (libswipl.so.9 -> libswipl.so.9.x.x)
          cd tea-python.AppDir/usr/lib
          # Find the full versioned library (e.g., libswipl.so.9.2.9)
          FULL_LIB=$(ls libswipl.so.*.*.* 2>/dev/null | head -1 || true)
          if [ -n "$FULL_LIB" ]; then
            # Extract major version (e.g., 9 from libswipl.so.9.2.9)
            MAJOR_VERSION=$(echo "$FULL_LIB" | sed 's/libswipl.so.\([0-9]*\).*/\1/')
            # Create symlinks if they don't exist
            [ ! -e "libswipl.so.${MAJOR_VERSION}" ] && ln -sf "$FULL_LIB" "libswipl.so.${MAJOR_VERSION}"
            [ ! -e "libswipl.so" ] && ln -sf "libswipl.so.${MAJOR_VERSION}" "libswipl.so"
          fi
          cd ../../..

          # Verify boot.prc exists (critical for VM initialization)
          if [ ! -f "tea-python.AppDir/usr/lib/swipl/boot.prc" ]; then
            echo "ERROR: boot.prc not found after copy"
            ls -la tea-python.AppDir/usr/lib/swipl/
            exit 1
          fi

          echo "Bundled SWI-Prolog contents:"
          ls -la tea-python.AppDir/usr/lib/swipl/
          ls -la tea-python.AppDir/usr/lib/libswipl*

      - name: Run linuxdeploy
        run: |
          # linuxdeploy bundles shared libraries automatically
          # Set LD_LIBRARY_PATH so linuxdeploy can find libswipl.so in our AppDir
          export LD_LIBRARY_PATH="$(pwd)/tea-python.AppDir/usr/lib:${LD_LIBRARY_PATH}"

          ./linuxdeploy-x86_64.AppImage \
            --appdir tea-python.AppDir \
            --executable tea-python.AppDir/usr/bin/tea \
            --desktop-file tea-python.desktop \
            --icon-file tea-python.svg \
            --output appimage

      - name: Create custom AppRun
        run: |
          # Replace default AppRun with custom one that sets SWI_HOME_DIR and Python env
          rm -f tea-python.AppDir/AppRun
          cat > tea-python.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export SWI_HOME_DIR="${HERE}/usr/lib/swipl"
          # Python-specific settings
          export PYTHONDONTWRITEBYTECODE=1
          export PYTHONUNBUFFERED=1
          exec "${HERE}/usr/bin/tea" "$@"
          EOF
          chmod +x tea-python.AppDir/AppRun

      - name: Rebuild AppImage with custom AppRun
        run: |
          # Get version from tag or use 'dev'
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi

          # Download appimagetool for final packaging
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # Create final AppImage with proper naming
          ARCH=x86_64 ./appimagetool-x86_64.AppImage tea-python.AppDir "tea-python-${VERSION}-x86_64.AppImage"

      - name: Smoke test AppImage
        run: |
          chmod +x tea-python-*-x86_64.AppImage
          ./tea-python-*-x86_64.AppImage --version
          impl=$(./tea-python-*-x86_64.AppImage --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Test AppImage on clean Ubuntu container
        run: |
          docker run --rm -v $(pwd):/work ubuntu:24.04 bash -c '
            chmod +x /work/tea-python-*-x86_64.AppImage
            # Use --appimage-extract-and-run to avoid FUSE requirement in Docker
            /work/tea-python-*-x86_64.AppImage --appimage-extract-and-run --version
            # Functional test: Run Prolog example (same as aarch64)
            /work/tea-python-*-x86_64.AppImage --appimage-extract-and-run run /work/examples/prolog/simple-prolog-agent.yaml --input "{\"value\": 21}"
          '

      - name: Check AppImage size
        run: |
          size=$(stat -c%s tea-python-*-x86_64.AppImage)
          size_mb=$((size / 1024 / 1024))
          echo "AppImage size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-appimage-x86_64
          path: tea-python-*-x86_64.AppImage
          retention-days: 1

  build-python-appimage-aarch64:
    runs-on: ubuntu-24.04-arm
    needs: [build-python-linux-full-prolog-arm64]
    name: Python AppImage aarch64 with Prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          # libfuse2: Required for running AppImages
          # libossp-uuid16: Required by SWI-Prolog uuid.so module
          sudo apt-get install -y file libfuse2 libossp-uuid16

      - name: Download Python Full Prolog binary
        uses: actions/download-artifact@v4
        with:
          name: python-linux-arm64-full-prolog
          path: .

      - name: Download SWI-Prolog runtime from build job
        uses: actions/download-artifact@v4
        with:
          name: python-swipl-runtime-aarch64-full
          path: .

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
          chmod +x linuxdeploy-aarch64.AppImage

      - name: Create .desktop file
        run: |
          cat > tea-python.desktop << 'EOF'
          [Desktop Entry]
          Name=The Edge Agent (Python)
          Comment=Lightweight state graph workflow engine - Python implementation
          Exec=tea
          Icon=tea-python
          Type=Application
          Categories=Development;
          Terminal=true
          EOF
          sed -i 's/^[[:space:]]*//' tea-python.desktop

      - name: Create placeholder icon
        run: |
          # Create a simple placeholder SVG icon (256x256) with Python colors
          cat > tea-python.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="#306998"/>
            <text x="128" y="160" font-family="monospace" font-size="100" fill="#FFD43B" text-anchor="middle">py</text>
          </svg>
          EOF

      - name: Create AppDir structure
        run: |
          mkdir -p tea-python.AppDir/usr/bin
          mkdir -p tea-python.AppDir/usr/lib/swipl
          chmod +x tea-python-linux-arm64-full-prolog
          cp tea-python-linux-arm64-full-prolog tea-python.AppDir/usr/bin/tea

      - name: Bundle SWI-Prolog runtime
        run: |
          # Extract the SWI-Prolog runtime bundled from the build job
          # This ensures we use the EXACT same version that the binary was compiled against
          tar -xzf python-swipl-runtime-aarch64-full.tar.gz

          echo "Bundling SWI-Prolog runtime from build job artifact"

          # Copy home directory contents
          cp -r python-swipl-runtime-aarch64-full/home/* tea-python.AppDir/usr/lib/swipl/

          # Copy libswipl.so to usr/lib
          mkdir -p tea-python.AppDir/usr/lib
          cp -L python-swipl-runtime-aarch64-full/lib/libswipl.so* tea-python.AppDir/usr/lib/

          # Ensure proper symlink chain exists (libswipl.so.9 -> libswipl.so.9.x.x)
          cd tea-python.AppDir/usr/lib
          # Find the full versioned library (e.g., libswipl.so.9.2.9)
          FULL_LIB=$(ls libswipl.so.*.*.* 2>/dev/null | head -1 || true)
          if [ -n "$FULL_LIB" ]; then
            # Extract major version (e.g., 9 from libswipl.so.9.2.9)
            MAJOR_VERSION=$(echo "$FULL_LIB" | sed 's/libswipl.so.\([0-9]*\).*/\1/')
            # Create symlinks if they don't exist
            [ ! -e "libswipl.so.${MAJOR_VERSION}" ] && ln -sf "$FULL_LIB" "libswipl.so.${MAJOR_VERSION}"
            [ ! -e "libswipl.so" ] && ln -sf "libswipl.so.${MAJOR_VERSION}" "libswipl.so"
          fi
          cd ../../..

          # Verify boot.prc exists (critical for VM initialization)
          if [ ! -f "tea-python.AppDir/usr/lib/swipl/boot.prc" ]; then
            echo "ERROR: boot.prc not found after copy"
            ls -la tea-python.AppDir/usr/lib/swipl/
            exit 1
          fi

          echo "Bundled SWI-Prolog contents:"
          ls -la tea-python.AppDir/usr/lib/swipl/
          ls -la tea-python.AppDir/usr/lib/libswipl*

      - name: Run linuxdeploy
        run: |
          # linuxdeploy bundles shared libraries automatically
          # Set LD_LIBRARY_PATH so linuxdeploy can find libswipl.so in our AppDir
          export LD_LIBRARY_PATH="$(pwd)/tea-python.AppDir/usr/lib:${LD_LIBRARY_PATH}"

          ./linuxdeploy-aarch64.AppImage \
            --appdir tea-python.AppDir \
            --executable tea-python.AppDir/usr/bin/tea \
            --desktop-file tea-python.desktop \
            --icon-file tea-python.svg \
            --output appimage

      - name: Create custom AppRun
        run: |
          # Replace default AppRun with custom one that sets SWI_HOME_DIR and Python env
          rm -f tea-python.AppDir/AppRun
          cat > tea-python.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export SWI_HOME_DIR="${HERE}/usr/lib/swipl"
          # Python-specific settings
          export PYTHONDONTWRITEBYTECODE=1
          export PYTHONUNBUFFERED=1
          exec "${HERE}/usr/bin/tea" "$@"
          EOF
          chmod +x tea-python.AppDir/AppRun

      - name: Rebuild AppImage with custom AppRun
        run: |
          # Get version from tag or use 'dev'
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi

          # Download appimagetool for final packaging
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
          chmod +x appimagetool-aarch64.AppImage

          # Create final AppImage with proper naming
          ARCH=aarch64 ./appimagetool-aarch64.AppImage tea-python.AppDir "tea-python-${VERSION}-aarch64.AppImage"

      - name: Smoke test AppImage
        run: |
          chmod +x tea-python-*-aarch64.AppImage
          ./tea-python-*-aarch64.AppImage --version
          impl=$(./tea-python-*-aarch64.AppImage --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Test AppImage - run Prolog example
        run: |
          # Verify the AppImage runs natively with Prolog support
          ./tea-python-*-aarch64.AppImage run examples/prolog/simple-prolog-agent.yaml --input '{"value": 21}'

      - name: Check AppImage size
        run: |
          size=$(stat -c%s tea-python-*-aarch64.AppImage)
          size_mb=$((size / 1024 / 1024))
          echo "AppImage size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-appimage-aarch64
          path: tea-python-*-aarch64.AppImage
          retention-days: 1


  # ============================================================
  # Python LLM AppImages - Phi-4-mini Model (TEA-RELEASE-004.2)
  # Self-contained with bundled Phi-4-mini Q3_K_S GGUF model (~1.9GB)
  # ============================================================
  build-python-llm-phi4-x86_64:
    runs-on: ubuntu-22.04
    needs: [build-python-linux-full-prolog-x86_64]
    name: Python LLM AppImage x86_64 (Phi-4-mini)

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y file libfuse2 libossp-uuid16 wget

      - name: Download Python Full Prolog binary
        uses: actions/download-artifact@v4
        with:
          name: python-linux-x86_64-full-prolog
          path: .

      - name: Download SWI-Prolog runtime from build job
        uses: actions/download-artifact@v4
        with:
          name: python-swipl-runtime-x86_64-full
          path: .

      - name: Download Phi-4-mini Q3_K_S model from Hugging Face
        run: |
          mkdir -p models
          # Download Phi-4-mini Q3_K_S (~1.9GB)
          wget -q --show-progress -O models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf \
            "https://huggingface.co/bartowski/microsoft_Phi-4-mini-instruct-GGUF/resolve/main/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf" || {
            echo "Primary download failed, trying mirror..."
            wget -q --show-progress -O models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf \
              "https://huggingface.co/second-state/Phi-4-mini-instruct-GGUF/resolve/main/Phi-4-mini-instruct-Q3_K_S.gguf"
          }
          ls -lh models/

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Create .desktop file
        run: |
          cat > tea-python-llm.desktop << 'EOF'
          [Desktop Entry]
          Name=The Edge Agent LLM (Python/Phi-4)
          Comment=Lightweight state graph workflow engine with bundled Phi-4 LLM
          Exec=tea
          Icon=tea-python-llm
          Type=Application
          Categories=Development;
          Terminal=true
          EOF
          sed -i 's/^[[:space:]]*//' tea-python-llm.desktop

      - name: Create placeholder icon
        run: |
          cat > tea-python-llm.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="#1E90FF"/>
            <text x="128" y="140" font-family="monospace" font-size="50" fill="#FFFFFF" text-anchor="middle">Phi-4</text>
            <text x="128" y="200" font-family="monospace" font-size="40" fill="#FFFFFF" text-anchor="middle">py</text>
          </svg>
          EOF
          sed -i 's/^[[:space:]]*//' tea-python-llm.svg

      - name: Create AppDir structure
        run: |
          mkdir -p tea-python-llm.AppDir/usr/bin
          mkdir -p tea-python-llm.AppDir/usr/lib/swipl
          mkdir -p tea-python-llm.AppDir/usr/share/models
          chmod +x tea-python-linux-x86_64-full-prolog
          cp tea-python-linux-x86_64-full-prolog tea-python-llm.AppDir/usr/bin/tea
          cp models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf tea-python-llm.AppDir/usr/share/models/

      - name: Bundle SWI-Prolog runtime
        run: |
          tar -xzf python-swipl-runtime-x86_64-full.tar.gz
          cp -r python-swipl-runtime-x86_64-full/home/* tea-python-llm.AppDir/usr/lib/swipl/
          mkdir -p tea-python-llm.AppDir/usr/lib
          cp -L python-swipl-runtime-x86_64-full/lib/libswipl.so* tea-python-llm.AppDir/usr/lib/

          cd tea-python-llm.AppDir/usr/lib
          FULL_LIB=$(ls libswipl.so.*.*.* 2>/dev/null | head -1 || true)
          if [ -n "$FULL_LIB" ]; then
            MAJOR_VERSION=$(echo "$FULL_LIB" | sed 's/libswipl.so.\([0-9]*\).*/\1/')
            [ ! -e "libswipl.so.${MAJOR_VERSION}" ] && ln -sf "$FULL_LIB" "libswipl.so.${MAJOR_VERSION}"
            [ ! -e "libswipl.so" ] && ln -sf "libswipl.so.${MAJOR_VERSION}" "libswipl.so"
          fi
          cd ../../..

      - name: Run linuxdeploy
        run: |
          export LD_LIBRARY_PATH="$(pwd)/tea-python-llm.AppDir/usr/lib:${LD_LIBRARY_PATH}"
          ./linuxdeploy-x86_64.AppImage \
            --appdir tea-python-llm.AppDir \
            --executable tea-python-llm.AppDir/usr/bin/tea \
            --desktop-file tea-python-llm.desktop \
            --icon-file tea-python-llm.svg \
            --output appimage

      - name: Create custom AppRun with LLM model path
        run: |
          rm -f tea-python-llm.AppDir/AppRun
          cat > tea-python-llm.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export SWI_HOME_DIR="${HERE}/usr/lib/swipl"
          export PYTHONDONTWRITEBYTECODE=1
          export PYTHONUNBUFFERED=1
          export TEA_MODEL_PATH="${HERE}/usr/share/models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf"
          exec "${HERE}/usr/bin/tea" "$@"
          EOF
          chmod +x tea-python-llm.AppDir/AppRun

      - name: Rebuild AppImage with custom AppRun
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage tea-python-llm.AppDir "tea-python-llm-phi4-${VERSION}-x86_64.AppImage"

      - name: Smoke test AppImage
        run: |
          chmod +x tea-python-llm-phi4-*-x86_64.AppImage
          ./tea-python-llm-phi4-*-x86_64.AppImage --version
          impl=$(./tea-python-llm-phi4-*-x86_64.AppImage --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Functional test - verify model is bundled
        run: |
          ./tea-python-llm-phi4-*-x86_64.AppImage --appimage-extract
          if [ ! -f squashfs-root/usr/share/models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf ]; then
            echo "Error: Model file not found in AppImage"
            exit 1
          fi
          model_size=$(stat -c%s "squashfs-root/usr/share/models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf")
          model_size_mb=$((model_size / 1024 / 1024))
          echo "Bundled model size: ${model_size_mb}MB"
          rm -rf squashfs-root

      - name: Check AppImage size
        run: |
          size=$(stat -c%s tea-python-llm-phi4-*-x86_64.AppImage)
          size_mb=$((size / 1024 / 1024))
          echo "AppImage size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-llm-phi4-appimage-x86_64
          path: tea-python-llm-phi4-*-x86_64.AppImage
          retention-days: 1

  build-python-llm-phi4-aarch64:
    runs-on: ubuntu-24.04-arm
    needs: [build-python-linux-full-prolog-arm64]
    name: Python LLM AppImage aarch64 (Phi-4-mini)

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y file libfuse2 libossp-uuid16 wget

      - name: Download Python Full Prolog binary
        uses: actions/download-artifact@v4
        with:
          name: python-linux-arm64-full-prolog
          path: .

      - name: Download SWI-Prolog runtime from build job
        uses: actions/download-artifact@v4
        with:
          name: python-swipl-runtime-aarch64-full
          path: .

      - name: Download Phi-4-mini Q3_K_S model from Hugging Face
        run: |
          mkdir -p models
          # Download Phi-4-mini Q3_K_S (~1.9GB)
          wget -q --show-progress -O models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf \
            "https://huggingface.co/bartowski/microsoft_Phi-4-mini-instruct-GGUF/resolve/main/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf" || {
            echo "Primary download failed, trying mirror..."
            wget -q --show-progress -O models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf \
              "https://huggingface.co/second-state/Phi-4-mini-instruct-GGUF/resolve/main/Phi-4-mini-instruct-Q3_K_S.gguf"
          }
          ls -lh models/

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
          chmod +x linuxdeploy-aarch64.AppImage

      - name: Create .desktop file
        run: |
          cat > tea-python-llm.desktop << 'EOF'
          [Desktop Entry]
          Name=The Edge Agent LLM (Python/Phi-4)
          Comment=Lightweight state graph workflow engine with bundled Phi-4 LLM
          Exec=tea
          Icon=tea-python-llm
          Type=Application
          Categories=Development;
          Terminal=true
          EOF
          sed -i 's/^[[:space:]]*//' tea-python-llm.desktop

      - name: Create placeholder icon
        run: |
          cat > tea-python-llm.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="#1E90FF"/>
            <text x="128" y="140" font-family="monospace" font-size="50" fill="#FFFFFF" text-anchor="middle">Phi-4</text>
            <text x="128" y="200" font-family="monospace" font-size="40" fill="#FFFFFF" text-anchor="middle">py</text>
          </svg>
          EOF
          sed -i 's/^[[:space:]]*//' tea-python-llm.svg

      - name: Create AppDir structure
        run: |
          mkdir -p tea-python-llm.AppDir/usr/bin
          mkdir -p tea-python-llm.AppDir/usr/lib/swipl
          mkdir -p tea-python-llm.AppDir/usr/share/models
          chmod +x tea-python-linux-arm64-full-prolog
          cp tea-python-linux-arm64-full-prolog tea-python-llm.AppDir/usr/bin/tea
          cp models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf tea-python-llm.AppDir/usr/share/models/

      - name: Bundle SWI-Prolog runtime
        run: |
          tar -xzf python-swipl-runtime-aarch64-full.tar.gz
          cp -r python-swipl-runtime-aarch64-full/home/* tea-python-llm.AppDir/usr/lib/swipl/
          mkdir -p tea-python-llm.AppDir/usr/lib
          cp -L python-swipl-runtime-aarch64-full/lib/libswipl.so* tea-python-llm.AppDir/usr/lib/

          cd tea-python-llm.AppDir/usr/lib
          FULL_LIB=$(ls libswipl.so.*.*.* 2>/dev/null | head -1 || true)
          if [ -n "$FULL_LIB" ]; then
            MAJOR_VERSION=$(echo "$FULL_LIB" | sed 's/libswipl.so.\([0-9]*\).*/\1/')
            [ ! -e "libswipl.so.${MAJOR_VERSION}" ] && ln -sf "$FULL_LIB" "libswipl.so.${MAJOR_VERSION}"
            [ ! -e "libswipl.so" ] && ln -sf "libswipl.so.${MAJOR_VERSION}" "libswipl.so"
          fi
          cd ../../..

      - name: Run linuxdeploy
        run: |
          export LD_LIBRARY_PATH="$(pwd)/tea-python-llm.AppDir/usr/lib:${LD_LIBRARY_PATH}"
          ./linuxdeploy-aarch64.AppImage \
            --appdir tea-python-llm.AppDir \
            --executable tea-python-llm.AppDir/usr/bin/tea \
            --desktop-file tea-python-llm.desktop \
            --icon-file tea-python-llm.svg \
            --output appimage

      - name: Create custom AppRun with LLM model path
        run: |
          rm -f tea-python-llm.AppDir/AppRun
          cat > tea-python-llm.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export SWI_HOME_DIR="${HERE}/usr/lib/swipl"
          export PYTHONDONTWRITEBYTECODE=1
          export PYTHONUNBUFFERED=1
          export TEA_MODEL_PATH="${HERE}/usr/share/models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf"
          exec "${HERE}/usr/bin/tea" "$@"
          EOF
          chmod +x tea-python-llm.AppDir/AppRun

      - name: Rebuild AppImage with custom AppRun
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
          chmod +x appimagetool-aarch64.AppImage
          ARCH=aarch64 ./appimagetool-aarch64.AppImage tea-python-llm.AppDir "tea-python-llm-phi4-${VERSION}-aarch64.AppImage"

      - name: Smoke test AppImage
        run: |
          chmod +x tea-python-llm-phi4-*-aarch64.AppImage
          ./tea-python-llm-phi4-*-aarch64.AppImage --version
          impl=$(./tea-python-llm-phi4-*-aarch64.AppImage --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Functional test - verify model is bundled
        run: |
          ./tea-python-llm-phi4-*-aarch64.AppImage --appimage-extract
          if [ ! -f squashfs-root/usr/share/models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf ]; then
            echo "Error: Model file not found in AppImage"
            exit 1
          fi
          model_size=$(stat -c%s "squashfs-root/usr/share/models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf")
          model_size_mb=$((model_size / 1024 / 1024))
          echo "Bundled model size: ${model_size_mb}MB"
          rm -rf squashfs-root

      - name: Check AppImage size
        run: |
          size=$(stat -c%s tea-python-llm-phi4-*-aarch64.AppImage)
          size_mb=$((size / 1024 / 1024))
          echo "AppImage size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-llm-phi4-appimage-aarch64
          path: tea-python-llm-phi4-*-aarch64.AppImage
          retention-days: 1

  # ============================================================
  # Python Wheel (existing)
  # ============================================================
  build-wheel:
    runs-on: ubuntu-latest
    name: Python Wheel

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build wheel
        run: |
          cd python
          pip install build
          python -m build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-wheel
          path: python/dist/*.whl
          retention-days: 1

  # ============================================================
  # WASM LLM Package (TEA-RELEASE-004.3c)
  # Builds WASM package with model for browser LLM inference
  # ============================================================
  build-wasm-llm:
    runs-on: ubuntu-latest
    name: WASM LLM Package

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build WASM package
        run: |
          cd rust/tea-wasm-llm
          wasm-pack build --target web --release

      - name: Compile TypeScript wrapper
        run: |
          cd rust/tea-wasm-llm
          npm install typescript
          # Create tsconfig if not exists
          if [ ! -f tsconfig.json ]; then
            cat > tsconfig.json << 'EOF'
          {
            "compilerOptions": {
              "target": "ESNext",
              "module": "ESNext",
              "moduleResolution": "node",
              "declaration": true,
              "declarationMap": true,
              "strict": true,
              "esModuleInterop": true,
              "skipLibCheck": true,
              "outDir": "./pkg"
            },
            "include": ["js/**/*.ts"],
            "exclude": ["node_modules", "pkg"]
          }
          EOF
          fi
          npx tsc --project tsconfig.json || echo "TypeScript compilation had warnings"

      - name: Download model
        run: |
          cd rust/tea-wasm-llm
          chmod +x scripts/download-model.sh
          ./scripts/download-model.sh

      - name: Check model size
        run: |
          size=$(stat -c%s "rust/tea-wasm-llm/models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf")
          size_mb=$((size / 1024 / 1024))
          echo "Model size: ${size_mb}MB"
          # Verify it's under GitHub's 2GB limit
          if [ $size -gt 2147483648 ]; then
            echo "ERROR: Model exceeds 2GB limit"
            exit 1
          fi

      - name: Create release tarball
        run: |
          cd rust/tea-wasm-llm
          # Get version from tag
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi

          # Create tarball with pkg and js directories
          tar -czvf "tea-wasm-llm-${VERSION}.tar.gz" pkg/ js/

          echo "Created tea-wasm-llm-${VERSION}.tar.gz"
          ls -lh "tea-wasm-llm-${VERSION}.tar.gz"

      - name: Generate WASM SHA256SUMS
        run: |
          cd rust/tea-wasm-llm
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi

          # Generate checksums for all WASM release assets
          sha256sum "tea-wasm-llm-${VERSION}.tar.gz" \
                    models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf \
                    models/manifest.json > SHA256SUMS.wasm

          echo "SHA256SUMS.wasm contents:"
          cat SHA256SUMS.wasm

      - name: Upload WASM package artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm-llm-package
          path: |
            rust/tea-wasm-llm/tea-wasm-llm-*.tar.gz
            rust/tea-wasm-llm/SHA256SUMS.wasm
          retention-days: 1

      - name: Upload model artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm-llm-model
          path: |
            rust/tea-wasm-llm/models/microsoft_Phi-4-mini-instruct-Q3_K_S.gguf
            rust/tea-wasm-llm/models/manifest.json
          retention-days: 1

  # ============================================================
  # Create Release
  # ============================================================
  release:
    needs:
      # Python binaries (base)
      - build-python-linux
      - build-python-linux-full
      - build-python-linux-arm64
      - build-python-linux-arm64-full
      - build-python-windows
      - build-python-windows-full
      - build-python-macos
      - build-python-macos-full
      # Python binaries (with Prolog)
      - build-python-linux-prolog-x86_64
      - build-python-linux-prolog-arm64
      - build-python-linux-full-prolog-x86_64
      - build-python-linux-full-prolog-arm64
      # Python AppImages (self-contained with Prolog)
      - build-python-appimage-x86_64
      - build-python-appimage-aarch64
      # Rust binaries (base)
      - build-rust
      # Rust binaries (with Prolog)
      - build-rust-prolog-linux-x86_64
      - build-rust-prolog-linux-arm64
      # Rust AppImages (self-contained with Prolog)
      - build-appimage-x86_64
      - build-appimage-aarch64
      # Rust LLM AppImages (self-contained with bundled GGUF models)
      - build-rust-llm-gemma-appimage-x86_64
      - build-rust-llm-phi4-appimage-x86_64
      - build-rust-llm-phi4-appimage-aarch64
      # Python LLM AppImages (self-contained with bundled GGUF models) - TEA-RELEASE-004.2
      - build-python-llm-phi4-x86_64
      - build-python-llm-phi4-aarch64
      # Python wheel
      - build-wheel
      # WASM LLM package
      - build-wasm-llm
    runs-on: ubuntu-latest
    name: Create Release

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for release notes

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten artifacts
        run: |
          mkdir -p release
          find dist -type f -exec mv {} release/ \;
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
