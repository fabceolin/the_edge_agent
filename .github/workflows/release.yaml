# =============================================================================
# Release Orchestrator - Main Workflow
# =============================================================================
# Purpose: Orchestrates all build workflows and creates GitHub releases
#
# This workflow coordinates 10 reusable workflow files:
#   1. build-python-base.yaml    - 8 Python standalone binaries
#   2. build-python-prolog.yaml  - 4 Python binaries with Prolog support
#   3. build-python-appimage.yaml- 2 Python AppImages with Prolog
#   4. build-python-llm.yaml     - 2 Python LLM AppImages (Gemma 3 1B)
#   5. build-rust-base.yaml      - 5 Rust binaries + 2 Prolog variants
#   6. build-rust-appimage.yaml  - 2 Rust AppImages with Prolog
#   7. build-rust-llm.yaml       - 2 LLM binaries + 4 LLM AppImages
#   8. build-wasm.yaml           - WASM LLM package
#   9. build-wheel.yaml          - Python wheel package
#
# Trigger: Pushes to version tags (v*.*.*)
#
# Part of Story: TEA-RELEASE-005 (Workflow Modularization)
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================
  # Stage 1: Base builds (no dependencies)
  # ============================================================
  python-base:
    name: Python Base Builds
    uses: ./.github/workflows/build-python-base.yaml
    with:
      ref: ${{ github.ref }}

  python-prolog:
    name: Python Prolog Builds
    uses: ./.github/workflows/build-python-prolog.yaml
    with:
      ref: ${{ github.ref }}

  rust-base:
    name: Rust Base Builds
    uses: ./.github/workflows/build-rust-base.yaml
    with:
      ref: ${{ github.ref }}

  rust-llm-binaries:
    name: Rust LLM Binaries
    uses: ./.github/workflows/build-rust-llm.yaml
    with:
      ref: ${{ github.ref }}

  wasm:
    name: WASM Build
    uses: ./.github/workflows/build-wasm.yaml
    with:
      ref: ${{ github.ref }}

  wheel:
    name: Python Wheel
    uses: ./.github/workflows/build-wheel.yaml
    with:
      ref: ${{ github.ref }}

  # ============================================================
  # Stage 2: AppImage builds (depend on base builds for artifacts)
  # ============================================================
  python-appimage:
    name: Python AppImage Builds
    needs: [python-prolog]
    uses: ./.github/workflows/build-python-appimage.yaml
    with:
      ref: ${{ github.ref }}

  python-llm:
    name: Python LLM Builds
    needs: [python-prolog]
    uses: ./.github/workflows/build-python-llm.yaml
    with:
      ref: ${{ github.ref }}

  rust-appimage:
    name: Rust AppImage Builds
    needs: [rust-base]
    uses: ./.github/workflows/build-rust-appimage.yaml
    with:
      ref: ${{ github.ref }}

  # ============================================================
  # Stage 3: Create Release
  # ============================================================
  release:
    needs:
      # Python binaries (base)
      - python-base
      # Python binaries (with Prolog)
      - python-prolog
      # Python AppImages (self-contained with Prolog)
      - python-appimage
      # Python LLM AppImages (Gemma 3 1B)
      - python-llm
      # Rust binaries (base + Prolog)
      - rust-base
      # Rust AppImages (self-contained with Prolog)
      - rust-appimage
      # Rust LLM binaries and AppImages
      - rust-llm-binaries
      # Python wheel
      - wheel
      # WASM LLM package
      - wasm
    runs-on: ubuntu-24.04
    name: Create Release

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for release notes

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten artifacts
        run: |
          mkdir -p release
          find dist -type f -exec mv {} release/ \;
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
