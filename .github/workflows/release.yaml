# Multi-Platform Binary Release Pipeline
# Story: TEA-RELEASE-001
#
# Triggers on tag push (v*) and builds:
# - Python standalone binaries (PyInstaller) for 8 variants:
#   - Linux x86_64: Docker (batonogov/pyinstaller-linux) - core deps only
#   - Linux x86_64 Full: Docker with all optional dependencies
#   - Linux ARM64: Native runner (ubuntu-24.04-arm) - core deps only
#   - Linux ARM64 Full: Native runner with all optional dependencies
#   - Windows x86_64: Native runner (windows-latest) - core deps only
#   - Windows x86_64 Full: Native runner with all optional dependencies
#   - macOS ARM64: Native runner (macos-latest) - core deps only
#   - macOS ARM64 Full: Native runner with all optional dependencies
# - Rust binaries for 5 platforms (native compilation)
# - Python wheel (.whl) files
#
# Full builds include: openai, numpy, chromadb, requests, RestrictedPython,
# pycozo, pandas, s3fs, gcsfs, adlfs, lupa, kuzu
#
# All artifacts are published to GitHub Releases with SHA256 checksums.

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.11'
  RUST_VERSION: 'stable'

jobs:
  # ============================================================
  # Python Standalone Binaries - Linux (Docker-based)
  # ============================================================
  build-python-linux:
    runs-on: ubuntu-latest
    name: Python linux-x86_64

    steps:
      - uses: actions/checkout@v4

      - name: Build with PyInstaller Docker
        run: |
          docker run --rm -v "$(pwd):/src" --entrypoint /bin/bash batonogov/pyinstaller-linux:latest -c \
            "cd /src/python && \
             pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer && \
             pip install -e . --no-deps && \
             pyinstaller --onefile --name tea-python-linux-x86_64 \
               --hidden-import=the_edge_agent \
               --hidden-import=the_edge_agent.yaml_engine \
               --hidden-import=the_edge_agent.stategraph \
               --hidden-import=yaml \
               --hidden-import=json \
               --hidden-import=jinja2 \
               --hidden-import=typer \
               --collect-all the_edge_agent \
               --exclude-module tkinter \
               --exclude-module matplotlib \
               --exclude-module numpy \
               --exclude-module pandas \
               --strip \
               src/the_edge_agent/cli.py"

      - name: Smoke test
        run: |
          sudo chmod +x python/dist/tea-python-linux-x86_64
          ./python/dist/tea-python-linux-x86_64 --version
          impl=$(./python/dist/tea-python-linux-x86_64 --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-x86_64")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-x86_64
          path: python/dist/tea-python-linux-x86_64
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Linux x86_64 Full (Docker-based)
  # Includes all optional dependencies: LLM, RAG, web, code, graph, storage
  # ============================================================
  build-python-linux-full:
    runs-on: ubuntu-latest
    name: Python linux-x86_64-full

    steps:
      - uses: actions/checkout@v4

      - name: Build with PyInstaller Docker (full dependencies)
        run: |
          docker run --rm -v "$(pwd):/src" --entrypoint /bin/bash batonogov/pyinstaller-linux:latest -c \
            "cd /src/python && \
             pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer \
                         openai 'numpy<2' chromadb requests RestrictedPython \
                         'pycozo[embedded]' pandas \
                         s3fs gcsfs adlfs lupa kuzu && \
             pip install -e . --no-deps && \
             pyinstaller --onefile --name tea-python-linux-x86_64-full \
               --hidden-import=the_edge_agent \
               --hidden-import=the_edge_agent.yaml_engine \
               --hidden-import=the_edge_agent.stategraph \
               --hidden-import=yaml \
               --hidden-import=json \
               --hidden-import=jinja2 \
               --hidden-import=typer \
               --hidden-import=openai \
               --hidden-import=numpy \
               --hidden-import=chromadb \
               --hidden-import=requests \
               --hidden-import=RestrictedPython \
               --hidden-import=pycozo \
               --hidden-import=pandas \
               --hidden-import=s3fs \
               --hidden-import=gcsfs \
               --hidden-import=adlfs \
               --hidden-import=lupa \
               --hidden-import=kuzu \
               --collect-all the_edge_agent \
               --collect-all numpy \
               --collect-all pandas \
               --exclude-module tkinter \
               --exclude-module matplotlib \
               --strip \
               src/the_edge_agent/cli.py"

      - name: Smoke test
        run: |
          sudo chmod +x python/dist/tea-python-linux-x86_64-full
          ./python/dist/tea-python-linux-x86_64-full --version
          impl=$(./python/dist/tea-python-linux-x86_64-full --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-x86_64-full")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-x86_64-full
          path: python/dist/tea-python-linux-x86_64-full
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Linux ARM64 (Native runner)
  # ============================================================
  build-python-linux-arm64:
    runs-on: ubuntu-24.04-arm
    name: Python linux-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary
        run: |
          cd python
          pyinstaller --onefile --name tea-python-linux-arm64 \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --collect-all the_edge_agent \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --exclude-module numpy \
            --exclude-module pandas \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          ./python/dist/tea-python-linux-arm64 --version
          impl=$(./python/dist/tea-python-linux-arm64 --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-arm64")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-arm64
          path: python/dist/tea-python-linux-arm64
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Linux ARM64 Full (Native runner)
  # Includes all optional dependencies: LLM, RAG, web, code, graph, storage
  # ============================================================
  build-python-linux-arm64-full:
    runs-on: ubuntu-24.04-arm
    name: Python linux-arm64-full

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies (full)
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer \
                      openai 'numpy<2' chromadb requests RestrictedPython \
                      'pycozo[embedded]' pandas \
                      s3fs gcsfs adlfs lupa kuzu
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary (full)
        run: |
          cd python
          pyinstaller --onefile --name tea-python-linux-arm64-full \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --hidden-import=openai \
            --hidden-import=numpy \
            --hidden-import=chromadb \
            --hidden-import=requests \
            --hidden-import=RestrictedPython \
            --hidden-import=pycozo \
            --hidden-import=pandas \
            --hidden-import=s3fs \
            --hidden-import=gcsfs \
            --hidden-import=adlfs \
            --hidden-import=lupa \
            --hidden-import=kuzu \
            --collect-all the_edge_agent \
            --collect-all numpy \
            --collect-all pandas \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          ./python/dist/tea-python-linux-arm64-full --version
          impl=$(./python/dist/tea-python-linux-arm64-full --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -c%s "python/dist/tea-python-linux-arm64-full")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-linux-arm64-full
          path: python/dist/tea-python-linux-arm64-full
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Windows (Native runner)
  # ============================================================
  build-python-windows:
    runs-on: windows-latest
    name: Python windows-x86_64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary
        run: |
          cd python
          pyinstaller --onefile --name tea-python-windows-x86_64 `
            --hidden-import=the_edge_agent `
            --hidden-import=the_edge_agent.yaml_engine `
            --hidden-import=the_edge_agent.stategraph `
            --hidden-import=yaml `
            --hidden-import=json `
            --hidden-import=jinja2 `
            --hidden-import=typer `
            --collect-all the_edge_agent `
            --exclude-module tkinter `
            --exclude-module matplotlib `
            --exclude-module numpy `
            --exclude-module pandas `
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          ./python/dist/tea-python-windows-x86_64.exe --version
          $impl = ./python/dist/tea-python-windows-x86_64.exe --impl
          if ($impl -ne "python") {
            Write-Error "Error: Expected 'python', got '$impl'"
            exit 1
          }

      - name: Check binary size
        run: |
          $size = (Get-Item "python/dist/tea-python-windows-x86_64.exe").Length
          $size_mb = [math]::Floor($size / 1024 / 1024)
          Write-Host "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-windows-x86_64
          path: python/dist/tea-python-windows-x86_64.exe
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - Windows Full (Native runner)
  # Includes all optional dependencies: LLM, RAG, web, code, graph, storage
  # ============================================================
  build-python-windows-full:
    runs-on: windows-latest
    name: Python windows-x86_64-full

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies (full)
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer `
                      openai "numpy<2" chromadb requests RestrictedPython `
                      "pycozo[embedded]" pandas `
                      s3fs gcsfs adlfs lupa kuzu
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary (full)
        run: |
          cd python
          pyinstaller --onefile --name tea-python-windows-x86_64-full `
            --hidden-import=the_edge_agent `
            --hidden-import=the_edge_agent.yaml_engine `
            --hidden-import=the_edge_agent.stategraph `
            --hidden-import=yaml `
            --hidden-import=json `
            --hidden-import=jinja2 `
            --hidden-import=typer `
            --hidden-import=openai `
            --hidden-import=numpy `
            --hidden-import=chromadb `
            --hidden-import=requests `
            --hidden-import=RestrictedPython `
            --hidden-import=pycozo `
            --hidden-import=pandas `
            --hidden-import=s3fs `
            --hidden-import=gcsfs `
            --hidden-import=adlfs `
            --hidden-import=lupa `
            --hidden-import=kuzu `
            --collect-all the_edge_agent `
            --collect-all numpy `
            --collect-all pandas `
            --exclude-module tkinter `
            --exclude-module matplotlib `
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          ./python/dist/tea-python-windows-x86_64-full.exe --version
          $impl = ./python/dist/tea-python-windows-x86_64-full.exe --impl
          if ($impl -ne "python") {
            Write-Error "Error: Expected 'python', got '$impl'"
            exit 1
          }

      - name: Check binary size
        run: |
          $size = (Get-Item "python/dist/tea-python-windows-x86_64-full.exe").Length
          $size_mb = [math]::Floor($size / 1024 / 1024)
          Write-Host "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-windows-x86_64-full
          path: python/dist/tea-python-windows-x86_64-full.exe
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - macOS (Native runners)
  # ============================================================
  build-python-macos:
    runs-on: macos-latest
    name: Python darwin-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary
        run: |
          cd python
          pyinstaller --onefile --name tea-python-darwin-arm64 \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --collect-all the_edge_agent \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --exclude-module numpy \
            --exclude-module pandas \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          ./python/dist/tea-python-darwin-arm64 --version
          impl=$(./python/dist/tea-python-darwin-arm64 --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -f%z "python/dist/tea-python-darwin-arm64")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-darwin-arm64
          path: python/dist/tea-python-darwin-arm64
          retention-days: 1

  # ============================================================
  # Python Standalone Binaries - macOS Full (Native runners)
  # Includes all optional dependencies: LLM, RAG, web, code, graph, storage
  # ============================================================
  build-python-macos-full:
    runs-on: macos-latest
    name: Python darwin-arm64-full

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies (full)
        run: |
          cd python
          pip install networkx==3.3 pyyaml jinja2 jmespath jsonschema fsspec typer \
                      openai 'numpy<2' chromadb requests RestrictedPython \
                      'pycozo[embedded]' pandas \
                      s3fs gcsfs adlfs lupa kuzu
          pip install -e . --no-deps
          pip install pyinstaller

      - name: Build standalone binary (full)
        run: |
          cd python
          pyinstaller --onefile --name tea-python-darwin-arm64-full \
            --hidden-import=the_edge_agent \
            --hidden-import=the_edge_agent.yaml_engine \
            --hidden-import=the_edge_agent.stategraph \
            --hidden-import=yaml \
            --hidden-import=json \
            --hidden-import=jinja2 \
            --hidden-import=typer \
            --hidden-import=openai \
            --hidden-import=numpy \
            --hidden-import=chromadb \
            --hidden-import=requests \
            --hidden-import=RestrictedPython \
            --hidden-import=pycozo \
            --hidden-import=pandas \
            --hidden-import=s3fs \
            --hidden-import=gcsfs \
            --hidden-import=adlfs \
            --hidden-import=lupa \
            --hidden-import=kuzu \
            --collect-all the_edge_agent \
            --collect-all numpy \
            --collect-all pandas \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --strip \
            src/the_edge_agent/cli.py

      - name: Smoke test
        run: |
          ./python/dist/tea-python-darwin-arm64-full --version
          impl=$(./python/dist/tea-python-darwin-arm64-full --impl)
          if [ "$impl" != "python" ]; then
            echo "Error: Expected 'python', got '$impl'"
            exit 1
          fi

      - name: Check binary size
        run: |
          size=$(stat -f%z "python/dist/tea-python-darwin-arm64-full")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-darwin-arm64-full
          path: python/dist/tea-python-darwin-arm64-full
          retention-days: 1

  # ============================================================
  # Rust Binaries
  # ============================================================
  build-rust:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact: tea-rust-linux-x86_64
            ext: ''
            use_cross: false
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-musl
            artifact: tea-rust-linux-arm64
            ext: ''
            use_cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: tea-rust-windows-x86_64
            ext: '.exe'
            use_cross: false
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: tea-rust-darwin-arm64
            ext: ''
            use_cross: false
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: tea-rust-darwin-x86_64
            ext: ''
            use_cross: false

    runs-on: ${{ matrix.os }}
    name: Rust ${{ matrix.artifact }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      - name: Install musl tools (Linux x86_64)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Install musl tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools gcc-aarch64-linux-gnu

      - name: Build release binary
        run: |
          cd rust
          cargo build --release --target ${{ matrix.target }} --bin tea

      - name: Copy binary
        run: |
          cp rust/target/${{ matrix.target }}/release/tea${{ matrix.ext }} ${{ matrix.artifact }}${{ matrix.ext }}
        shell: bash

      - name: Smoke test - version
        if: matrix.target != 'x86_64-apple-darwin'
        run: |
          ./${{ matrix.artifact }}${{ matrix.ext }} --version
        shell: bash

      - name: Smoke test - version (x86_64 on ARM64 macOS)
        if: matrix.target == 'x86_64-apple-darwin'
        run: |
          arch -x86_64 ./${{ matrix.artifact }}${{ matrix.ext }} --version
        shell: bash

      - name: Smoke test - impl
        if: matrix.target != 'x86_64-apple-darwin'
        run: |
          impl=$(./${{ matrix.artifact }}${{ matrix.ext }} --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi
        shell: bash

      - name: Smoke test - impl (x86_64 on ARM64 macOS)
        if: matrix.target == 'x86_64-apple-darwin'
        run: |
          impl=$(arch -x86_64 ./${{ matrix.artifact }}${{ matrix.ext }} --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi
        shell: bash

      - name: Verify version matches tag
        if: matrix.target != 'x86_64-apple-darwin'
        run: |
          version=$(./${{ matrix.artifact }}${{ matrix.ext }} --version | awk '{print $2}')
          tag="${GITHUB_REF_NAME#v}"
          if [ "$version" != "$tag" ]; then
            echo "Warning: Binary version ($version) does not match tag ($tag)"
          fi
        shell: bash

      - name: Verify version matches tag (x86_64 on ARM64 macOS)
        if: matrix.target == 'x86_64-apple-darwin'
        run: |
          version=$(arch -x86_64 ./${{ matrix.artifact }}${{ matrix.ext }} --version | awk '{print $2}')
          tag="${GITHUB_REF_NAME#v}"
          if [ "$version" != "$tag" ]; then
            echo "Warning: Binary version ($version) does not match tag ($tag)"
          fi
        shell: bash

      - name: Check binary size
        run: |
          size=$(stat -f%z "${{ matrix.artifact }}${{ matrix.ext }}" 2>/dev/null || stat -c%s "${{ matrix.artifact }}${{ matrix.ext }}")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"
          if [ $size_mb -gt 20 ]; then
            echo "Warning: Binary exceeds 20MB target (${size_mb}MB)"
          fi
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-${{ matrix.artifact }}
          path: ${{ matrix.artifact }}${{ matrix.ext }}
          retention-days: 1

  # ============================================================
  # Rust Prolog Binaries (glibc dynamic linking)
  # These require SWI-Prolog installed on the system
  # ============================================================
  build-rust-prolog-linux-x86_64:
    runs-on: ubuntu-latest
    name: Rust linux-x86_64-prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install SWI-Prolog
        run: |
          sudo apt-get update
          # On Ubuntu 24.04, swi-prolog-nox includes headers and libs (no separate libswipl-dev)
          sudo apt-get install -y swi-prolog-nox pkg-config
          # Fix pkg-config path mismatch: pkg-config reports /usr/lib/swi-prolog/lib/x86_64-linux
          # but library is at /usr/lib/x86_64-linux-gnu/
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libswipl.so /usr/lib/swi-prolog/lib/x86_64-linux/libswipl.so

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-x86_64-prolog-cargo-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-x86_64-prolog-cargo-

      - name: Build release binary with Prolog feature
        run: |
          cd rust
          cargo build --release --features prolog --bin tea

      - name: Copy binary
        run: |
          cp rust/target/release/tea tea-rust-linux-x86_64-prolog

      - name: Smoke test - version
        run: ./tea-rust-linux-x86_64-prolog --version

      - name: Smoke test - impl
        run: |
          impl=$(./tea-rust-linux-x86_64-prolog --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi

      - name: Functional test - run Prolog example
        run: ./tea-rust-linux-x86_64-prolog run examples/prolog/simple-prolog-agent.yaml

      - name: Check binary size
        run: |
          size=$(stat -c%s "tea-rust-linux-x86_64-prolog")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-tea-rust-linux-x86_64-prolog
          path: tea-rust-linux-x86_64-prolog
          retention-days: 1

  build-rust-prolog-linux-arm64:
    runs-on: ubuntu-24.04-arm
    name: Rust linux-arm64-prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install SWI-Prolog
        run: |
          sudo apt-get update
          # On Ubuntu 24.04, swi-prolog-nox includes headers and libs (no separate libswipl-dev)
          sudo apt-get install -y swi-prolog-nox pkg-config
          # Fix pkg-config path mismatch: pkg-config reports /usr/lib/swi-prolog/lib/aarch64-linux
          # but library is at /usr/lib/aarch64-linux-gnu/
          sudo ln -sf /usr/lib/aarch64-linux-gnu/libswipl.so /usr/lib/swi-prolog/lib/aarch64-linux/libswipl.so

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-aarch64-prolog-cargo-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-aarch64-prolog-cargo-

      - name: Build release binary with Prolog feature
        run: |
          cd rust
          cargo build --release --features prolog --bin tea

      - name: Copy binary
        run: |
          cp rust/target/release/tea tea-rust-linux-arm64-prolog

      - name: Smoke test - version
        run: ./tea-rust-linux-arm64-prolog --version

      - name: Smoke test - impl
        run: |
          impl=$(./tea-rust-linux-arm64-prolog --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi

      - name: Functional test - run Prolog example
        run: ./tea-rust-linux-arm64-prolog run examples/prolog/simple-prolog-agent.yaml

      - name: Check binary size
        run: |
          size=$(stat -c%s "tea-rust-linux-arm64-prolog")
          size_mb=$((size / 1024 / 1024))
          echo "Binary size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-tea-rust-linux-arm64-prolog
          path: tea-rust-linux-arm64-prolog
          retention-days: 1

  # ============================================================
  # AppImage Distribution (Linux only - self-contained with Prolog)
  # Uses linuxdeploy for automatic dependency bundling
  # ============================================================
  build-appimage-x86_64:
    runs-on: ubuntu-latest
    needs: [build-rust-prolog-linux-x86_64]
    name: Rust AppImage x86_64 with Prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install SWI-Prolog and dependencies
        run: |
          sudo apt-get update
          # On Ubuntu 24.04, swi-prolog-nox includes headers and libs (no separate libswipl-dev)
          sudo apt-get install -y swi-prolog-nox file libfuse2

      - name: Download Prolog binary
        uses: actions/download-artifact@v4
        with:
          name: rust-tea-rust-linux-x86_64-prolog
          path: .

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Create .desktop file
        run: |
          cat > tea.desktop << 'EOF'
          [Desktop Entry]
          Name=The Edge Agent
          Comment=Lightweight state graph workflow engine
          Exec=tea
          Icon=tea
          Type=Application
          Categories=Development;
          Terminal=true
          EOF

      - name: Create placeholder icon
        run: |
          # Create a simple placeholder SVG icon (256x256)
          cat > tea.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="#2d3748"/>
            <text x="128" y="160" font-family="monospace" font-size="120" fill="#48bb78" text-anchor="middle">t</text>
          </svg>
          EOF

      - name: Create AppDir structure
        run: |
          mkdir -p tea.AppDir/usr/bin
          mkdir -p tea.AppDir/usr/lib/swipl
          chmod +x tea-rust-linux-x86_64-prolog
          cp tea-rust-linux-x86_64-prolog tea.AppDir/usr/bin/tea

      - name: Bundle SWI-Prolog runtime
        run: |
          # Copy SWI-Prolog runtime directory (required for SWI_HOME_DIR)
          cp -r /usr/lib/swi-prolog/* tea.AppDir/usr/lib/swipl/ || true
          # Also try alternative location
          if [ -d "/usr/share/swi-prolog" ]; then
            cp -r /usr/share/swi-prolog/* tea.AppDir/usr/lib/swipl/ || true
          fi

      - name: Run linuxdeploy
        run: |
          # linuxdeploy bundles shared libraries automatically
          ./linuxdeploy-x86_64.AppImage \
            --appdir tea.AppDir \
            --executable tea.AppDir/usr/bin/tea \
            --desktop-file tea.desktop \
            --icon-file tea.svg \
            --output appimage

      - name: Create custom AppRun
        run: |
          # Replace default AppRun with custom one that sets SWI_HOME_DIR
          rm -f tea.AppDir/AppRun
          cat > tea.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export SWI_HOME_DIR="${HERE}/usr/lib/swipl"
          exec "${HERE}/usr/bin/tea" "$@"
          EOF
          chmod +x tea.AppDir/AppRun

      - name: Rebuild AppImage with custom AppRun
        run: |
          # Get version from tag or use 'dev'
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi

          # Download appimagetool for final packaging
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # Create final AppImage with proper naming
          ARCH=x86_64 ./appimagetool-x86_64.AppImage tea.AppDir "tea-${VERSION}-x86_64.AppImage"

      - name: Smoke test AppImage
        run: |
          chmod +x tea-*-x86_64.AppImage
          ./tea-*-x86_64.AppImage --version
          impl=$(./tea-*-x86_64.AppImage --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi

      - name: Test AppImage on clean Ubuntu container
        run: |
          docker run --rm -v $(pwd):/work ubuntu:22.04 bash -c '
            chmod +x /work/tea-*-x86_64.AppImage
            # Use --appimage-extract-and-run to avoid FUSE requirement in Docker
            /work/tea-*-x86_64.AppImage --appimage-extract-and-run --version
            # Use Lua example for Docker test (Prolog requires FUSE for SWI_HOME_DIR resolution)
            /work/tea-*-x86_64.AppImage --appimage-extract-and-run run /work/examples/while-loop-parity-test.yaml
          '

      - name: Check AppImage size
        run: |
          size=$(stat -c%s tea-*-x86_64.AppImage)
          size_mb=$((size / 1024 / 1024))
          echo "AppImage size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: appimage-x86_64
          path: tea-*-x86_64.AppImage
          retention-days: 1

  build-appimage-aarch64:
    runs-on: ubuntu-24.04-arm
    needs: [build-rust-prolog-linux-arm64]
    name: Rust AppImage aarch64 with Prolog

    steps:
      - uses: actions/checkout@v4

      - name: Install SWI-Prolog and dependencies
        run: |
          sudo apt-get update
          # On Ubuntu 24.04, swi-prolog-nox includes headers and libs (no separate libswipl-dev)
          sudo apt-get install -y swi-prolog-nox file libfuse2

      - name: Download Prolog binary
        uses: actions/download-artifact@v4
        with:
          name: rust-tea-rust-linux-arm64-prolog
          path: .

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
          chmod +x linuxdeploy-aarch64.AppImage

      - name: Create .desktop file
        run: |
          cat > tea.desktop << 'EOF'
          [Desktop Entry]
          Name=The Edge Agent
          Comment=Lightweight state graph workflow engine
          Exec=tea
          Icon=tea
          Type=Application
          Categories=Development;
          Terminal=true
          EOF

      - name: Create placeholder icon
        run: |
          # Create a simple placeholder SVG icon (256x256)
          cat > tea.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="#2d3748"/>
            <text x="128" y="160" font-family="monospace" font-size="120" fill="#48bb78" text-anchor="middle">t</text>
          </svg>
          EOF

      - name: Create AppDir structure
        run: |
          mkdir -p tea.AppDir/usr/bin
          mkdir -p tea.AppDir/usr/lib/swipl
          chmod +x tea-rust-linux-arm64-prolog
          cp tea-rust-linux-arm64-prolog tea.AppDir/usr/bin/tea

      - name: Bundle SWI-Prolog runtime
        run: |
          # Copy SWI-Prolog runtime directory (required for SWI_HOME_DIR)
          cp -r /usr/lib/swi-prolog/* tea.AppDir/usr/lib/swipl/ || true
          # Also try alternative location
          if [ -d "/usr/share/swi-prolog" ]; then
            cp -r /usr/share/swi-prolog/* tea.AppDir/usr/lib/swipl/ || true
          fi

      - name: Run linuxdeploy
        run: |
          # linuxdeploy bundles shared libraries automatically
          ./linuxdeploy-aarch64.AppImage \
            --appdir tea.AppDir \
            --executable tea.AppDir/usr/bin/tea \
            --desktop-file tea.desktop \
            --icon-file tea.svg \
            --output appimage

      - name: Create custom AppRun
        run: |
          # Replace default AppRun with custom one that sets SWI_HOME_DIR
          rm -f tea.AppDir/AppRun
          cat > tea.AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export SWI_HOME_DIR="${HERE}/usr/lib/swipl"
          exec "${HERE}/usr/bin/tea" "$@"
          EOF
          chmod +x tea.AppDir/AppRun

      - name: Rebuild AppImage with custom AppRun
        run: |
          # Get version from tag or use 'dev'
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION="dev"
          fi

          # Download appimagetool for final packaging
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
          chmod +x appimagetool-aarch64.AppImage

          # Create final AppImage with proper naming
          ARCH=aarch64 ./appimagetool-aarch64.AppImage tea.AppDir "tea-${VERSION}-aarch64.AppImage"

      - name: Smoke test AppImage
        run: |
          chmod +x tea-*-aarch64.AppImage
          ./tea-*-aarch64.AppImage --version
          impl=$(./tea-*-aarch64.AppImage --impl)
          if [ "$impl" != "rust" ]; then
            echo "Error: Expected 'rust', got '$impl'"
            exit 1
          fi

      - name: Test AppImage in Docker container
        run: |
          # Note: Can't run aarch64 Docker images on aarch64 native runners easily
          # Just verify the AppImage runs natively
          ./tea-*-aarch64.AppImage run examples/prolog/simple-prolog-agent.yaml

      - name: Check AppImage size
        run: |
          size=$(stat -c%s tea-*-aarch64.AppImage)
          size_mb=$((size / 1024 / 1024))
          echo "AppImage size: ${size_mb}MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: appimage-aarch64
          path: tea-*-aarch64.AppImage
          retention-days: 1

  # ============================================================
  # Python Wheel (existing)
  # ============================================================
  build-wheel:
    runs-on: ubuntu-latest
    name: Python Wheel

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build wheel
        run: |
          cd python
          pip install build
          python -m build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-wheel
          path: python/dist/*.whl
          retention-days: 1

  # ============================================================
  # Create Release
  # ============================================================
  release:
    needs:
      # Python binaries
      - build-python-linux
      - build-python-linux-full
      - build-python-linux-arm64
      - build-python-linux-arm64-full
      - build-python-windows
      - build-python-windows-full
      - build-python-macos
      - build-python-macos-full
      # Rust binaries (base)
      - build-rust
      # Rust binaries (with Prolog)
      - build-rust-prolog-linux-x86_64
      - build-rust-prolog-linux-arm64
      # AppImages (self-contained with Prolog)
      - build-appimage-x86_64
      - build-appimage-aarch64
      # Python wheel
      - build-wheel
    runs-on: ubuntu-latest
    name: Create Release

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for release notes

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten artifacts
        run: |
          mkdir -p release
          find dist -type f -exec mv {} release/ \;
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
