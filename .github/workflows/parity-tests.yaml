name: Parity Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'python/src/the_edge_agent/report*.py'
      - 'rust/src/report/**'
      - 'tests/report/**'
      - '.github/workflows/parity-tests.yaml'
  pull_request:
    paths:
      - 'python/src/the_edge_agent/report*.py'
      - 'rust/src/report/**'
      - 'tests/report/**'
      - '.github/workflows/parity-tests.yaml'
  workflow_dispatch:

jobs:
  parity:
    name: Python/Rust Parity Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Rust
      uses: dtolnay/rust-action@stable
      with:
        components: clippy

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          rust/target/
        key: ${{ runner.os }}-cargo-parity-${{ hashFiles('**/Cargo.lock') }}

    - name: Install Python package
      run: |
        python -m pip install --upgrade pip
        cd python && pip install -e .

    - name: Build Rust release
      run: |
        cd rust && cargo build --release

    - name: Run Python parity tests
      run: |
        cd tests/report/parity && python -m pytest -v

    - name: Run Rust encoder tests
      run: |
        cd rust && cargo test --release report:: -- --nocapture

  cross-language:
    name: Cross-Language Decoder Tests
    runs-on: ubuntu-latest
    needs: parity

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Python package
      run: |
        python -m pip install --upgrade pip
        cd python && pip install -e .

    - name: Install pako (JS inflate)
      run: npm install pako

    - name: Run cross-language tests
      run: |
        cd tests/report/parity && python -m pytest test_cross_language.py -v
