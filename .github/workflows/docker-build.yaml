# TEA-DIST-001: Docker Image Build and Push
#
# This workflow builds and pushes TEA Docker images to GitHub Container Registry.
# Supports multi-architecture builds (amd64, arm64) and multiple variants.
#
# Variants:
#   - base (~400MB) - Minimal core dependencies only
#   - full (~772MB) - All features (Prolog, Lua, Opik) - default "latest"
#   - gemma3-1b (~2GB) - Full + bundled Gemma 3 1B model
#   - gemma3-4b (~5GB) - Full + bundled Gemma 3 4B model
#   - phi4-mini (~5GB) - Full + bundled Phi-4 mini model
#
# Triggers:
# - Push to main branch (builds base + full only)
# - Version tags (builds all variants)
# - Manual workflow dispatch (selectable variants)

name: Docker Build

on:
  push:
    branches: [main]
    tags: ['v*']
    paths:
      - 'docker/**'
      - 'python/**'
      - '.github/workflows/docker-build.yaml'
  workflow_dispatch:
    inputs:
      push:
        description: 'Push to registry'
        type: boolean
        default: false
      variants:
        description: 'Variants to build'
        type: choice
        options:
          - 'base,full'
          - 'all'
          - 'base'
          - 'full'
          - 'gemma3-1b'
          - 'gemma3-4b'
          - 'phi4-mini'
        default: 'base,full'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/tea

jobs:
  # =============================================================================
  # Build Base and Full variants (fast, always run)
  # =============================================================================
  build-core:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - variant: base
            dockerfile: docker/Dockerfile.base
            suffix: -base
          - variant: full
            dockerfile: docker/Dockerfile.full
            suffix: ''
    # Always run on push/tag events; for workflow_dispatch, run when base,full or all is selected
    # Note: Cannot use matrix.variant in job-level if, so we run both variants together
    if: |
      github.event_name != 'workflow_dispatch' ||
      inputs.variants == 'all' ||
      inputs.variants == 'base,full' ||
      inputs.variants == 'base' ||
      inputs.variants == 'full'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Tag with variant name for main branch
            type=raw,value=${{ matrix.variant }},enable={{is_default_branch}}
            # Tag with 'latest' for full variant on main branch
            type=raw,value=latest,enable=${{ matrix.variant == 'full' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
            # Tag with version-variant (v1.2.3 -> 1.2.3-base, 1.2.3 for full)
            type=semver,pattern={{version}}${{ matrix.suffix }}
            # Tag with major.minor-variant
            type=semver,pattern={{major}}.{{minor}}${{ matrix.suffix }}
            # Tag with short SHA-variant
            type=sha,prefix=sha-,suffix=${{ matrix.suffix }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' && (github.event_name != 'workflow_dispatch' || inputs.push) }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=${{ matrix.variant }}

      - name: Test Docker image (amd64)
        if: success()
        run: |
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.variant }} --version

      - name: Output image info
        if: success()
        run: |
          echo "## Docker Image Built: ${{ matrix.variant }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Variant:** ${{ matrix.variant }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Build LLM variants (large, only on release tags or manual)
  # =============================================================================
  build-llm:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: gemma3-1b
            dockerfile: docker/Dockerfile.gemma3-1b
            model_size: '2GB'
          - variant: gemma3-4b
            dockerfile: docker/Dockerfile.gemma3-4b
            model_size: '5GB'
          - variant: phi4-mini
            dockerfile: docker/Dockerfile.phi4-mini
            model_size: '5GB'
    # Only run on release tags or manual dispatch with LLM variant selected
    # Note: Cannot use matrix.variant in job-level if, so all LLM variants run together
    if: |
      startsWith(github.ref, 'refs/tags/v') ||
      (github.event_name == 'workflow_dispatch' && (
        inputs.variants == 'all' ||
        inputs.variants == 'gemma3-1b' ||
        inputs.variants == 'gemma3-4b' ||
        inputs.variants == 'phi4-mini'
      ))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space for large model builds
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Tag with variant name
            type=raw,value=${{ matrix.variant }},enable={{is_default_branch}}
            type=raw,value=${{ matrix.variant }},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            # Tag with version-variant (v1.2.3 -> 1.2.3-gemma3-1b)
            type=semver,pattern={{version}}-${{ matrix.variant }}
            # Tag with short SHA-variant
            type=sha,prefix=sha-,suffix=-${{ matrix.variant }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'workflow_dispatch' || inputs.push }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=${{ matrix.variant }}

      - name: Test Docker image (amd64)
        if: success()
        run: |
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.variant }} --version
          # Verify model path is set
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.variant }} \
            python -c "import os; print(f'TEA_MODEL_PATH={os.environ.get(\"TEA_MODEL_PATH\", \"NOT SET\")}')"

      - name: Output image info
        if: success()
        run: |
          echo "## Docker Image Built: ${{ matrix.variant }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Variant:** ${{ matrix.variant }}" >> $GITHUB_STEP_SUMMARY
          echo "**Model Size:** ~${{ matrix.model_size }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
