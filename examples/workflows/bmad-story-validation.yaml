name: bmad-story-validation
description: |
  BMad Story Validation Workflow - Sequential QA and SM checks using BMad slash commands.

  Sequence:
  1. QA risk-profile → update story QA notes
  2. QA nfr-assess → update story QA notes
  3. QA test-design → update story QA notes
  4. SM story-checklist → update story status

  Uses BMad agents directly via slash commands for simplified context loading.

state_schema:
  arg: str
  story_path: str
  risk_profile_output: str
  nfr_assess_output: str
  test_design_output: str
  sm_checklist_output: str

# TEA-RALPHY-002.3: Enable verbose output for Claude Code shell provider
settings:
  shell_providers:
    claude:
      command: claude
      args: ["-p", "{prompt}", "--dangerously-skip-permissions"]
      verbose: true
      timeout: 108000

nodes:
  # ============================================================================
  # NODE 0: Resolve story path from arg (handles both short labels and full paths)
  # ============================================================================
  - name: resolve_story_path
    description: Convert short label to full story path if needed
    run: |
      import os
      import glob

      arg = state.get("arg", "")

      # If arg is already a full path that exists, use it directly
      if os.path.isfile(arg):
          return {"story_path": arg}

      # Otherwise, search for matching story file
      # arg could be: "PIR.1.person-table-row-level-accept-reject" or "PIR.1"
      stories_dir = "docs/stories"

      # Try exact match first
      pattern = os.path.join(stories_dir, f"{arg}.md")
      matches = glob.glob(pattern)
      if matches:
          return {"story_path": matches[0]}

      # Try prefix match (e.g., "PIR.1" matches "PIR.1.person-table-row-level-accept-reject.md")
      pattern = os.path.join(stories_dir, f"{arg}*.md")
      matches = glob.glob(pattern)
      if matches:
          return {"story_path": matches[0]}

      # Fallback: return arg as-is and let downstream handle the error
      return {"story_path": arg}

  # ============================================================================
  # NODE 1: QA risk-profile using BMad slash command
  # ============================================================================
  - name: qa_risk_profile
    description: Execute QA risk-profile and update story QA notes
    uses: llm.call
    with:
      provider: shell
      shell_provider: claude
      model: claude
      timeout: 3600
      messages:
        - role: user
          content: |
            /BMad:agents:qa *risk-profile {{ state.story_path }} YOLO mode

            AFTER completing the risk-profile analysis, you MUST:
            1. Append a "## QA Notes - Risk Profile" section to the story file {{ state.story_path }}
            2. Include: Risk level, identified risks, mitigations, testing priorities
            3. VERIFY the section was written by reading the file

            When done print: RISK_PROFILE_COMPLETED
    output: risk_profile_output

  # ============================================================================
  # NODE 2: QA nfr-assess using BMad slash command
  # ============================================================================
  - name: qa_nfr_assess
    description: Execute QA NFR assessment and update story QA notes
    uses: llm.call
    with:
      provider: shell
      shell_provider: claude
      model: claude
      timeout: 3600
      messages:
        - role: user
          content: |
            /BMad:agents:qa *nfr-assess {{ state.story_path }} YOLO mode

            AFTER completing the NFR assessment, you MUST:
            1. Append a "## QA Notes - NFR Assessment" section to the story file {{ state.story_path }}
            2. Include: NFR coverage, missing considerations, test recommendations, acceptance criteria
            3. VERIFY the section was written by reading the file

            When done print: NFR_ASSESS_COMPLETED
    output: nfr_assess_output

  # ============================================================================
  # NODE 3: QA test-design using BMad slash command
  # ============================================================================
  - name: qa_test_design
    description: Execute QA test-design and update story QA notes
    uses: llm.call
    with:
      provider: shell
      shell_provider: claude
      model: claude
      timeout: 3600
      messages:
        - role: user
          content: |
            /BMad:agents:qa *test-design {{ state.story_path }} YOLO mode

            AFTER completing the test design, you MUST:
            1. Append a "## QA Notes - Test Design" section to the story file {{ state.story_path }}
            2. Include: Test coverage matrix, scenarios with expected results, test data/environment requirements
            3. VERIFY the section was written by reading the file

            When done print: TEST_DESIGN_COMPLETED
    output: test_design_output

  # ============================================================================
  # NODE 4: SM story validation using BMad slash command
  # ============================================================================
  - name: sm_story_checklist
    description: Execute SM story-checklist and update story status
    uses: llm.call
    with:
      provider: shell
      shell_provider: claude
      model: claude
      timeout: 3600
      messages:
        - role: user
          content: |
            /BMad:agents:sm YOLO mode

            Execute the story validation checklist for {{ state.story_path }}

            Validate against Definition of Ready:
            - Story has clear title and description
            - Acceptance criteria are defined and testable
            - Dependencies are identified
            - Technical approach is documented
            - Story is properly sized
            - QA notes sections are present (Risk Profile, NFR, Test Design)
            - No blocking issues or unknowns

            AFTER completing validation, you MUST update the story file {{ state.story_path }}:
            1. Add "## SM Validation" section with checklist results
            2. Update "## Status" section:
               - If ALL criteria passed: Set to "Ready for Development"
               - If ANY criteria failed: Set to "Needs Revision" with notes
            3. VERIFY the sections were written by reading the file

            When done print: SM_CHECKLIST_COMPLETED
    output: sm_checklist_output

edges:
  - from: __start__
    to: resolve_story_path
  - from: resolve_story_path
    to: qa_risk_profile
  - from: qa_risk_profile
    to: qa_nfr_assess
  - from: qa_nfr_assess
    to: qa_test_design
  - from: qa_test_design
    to: sm_story_checklist
  - from: sm_story_checklist
    to: __end__
