# Cross-Runtime Parity Test: Parallel State Isolation
# Tests that thread-local state/2 provides isolation in parallel branches
# Expected: Each parallel branch sees its own state without interference
#
# Both runtimes declare state/2 as thread_local, ensuring isolation.
#
# NOTE: Parallel edges still require the edges section with type: parallel

name: parity-parallel-isolation
description: Verify thread-local state isolation in parallel Prolog branches

state_schema:
  branch_id: int
  value: int
  computed: int

nodes:
  - name: setup
    language: lua
    run: |
      return { branch_id = 0, value = 100, computed = 0 }

  - name: branch_a
    language: prolog
    run: |
      % Branch A reads value and computes A-specific result
      state(value, V),
      Result is V + 1,
      return(branch, "a"),
      return(computed, Result).

  - name: branch_b
    language: prolog
    run: |
      % Branch B reads value and computes B-specific result
      state(value, V),
      Result is V + 2,
      return(branch, "b"),
      return(computed, Result).

  - name: branch_c
    language: prolog
    run: |
      % Branch C reads value and computes C-specific result
      state(value, V),
      Result is V + 3,
      return(branch, "c"),
      return(computed, Result).

  - name: fan_in
    fan_in: true
    run: |
      # parallel_results contains ParallelFlowResult objects with .branch and .state
      results = []
      for r in parallel_results:
          state_dict = r.state if hasattr(r, 'state') else r
          results.append(state_dict)
      return {"parallel_count": len(results), "results": results}

# Parallel edges require type: parallel and explicit edges to fan_in node
edges:
  - from: __start__
    to: setup
  - from: setup
    to: branch_a
    type: parallel
    fan_in: fan_in
  - from: setup
    to: branch_b
    type: parallel
    fan_in: fan_in
  - from: setup
    to: branch_c
    type: parallel
    fan_in: fan_in
  - from: branch_a
    to: fan_in
  - from: branch_b
    to: fan_in
  - from: branch_c
    to: fan_in
  - from: fan_in
    to: __end__

# Implicit flow: __start__ -> setup (via node order)
# Implicit flow: fan_in -> __end__ (via last node)

initial_state:
  branch_id: 0
  value: 100
  computed: 0
