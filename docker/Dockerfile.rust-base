# TEA-DIST-002: Docker Rust Base Image - Minimal Dependencies
#
# Minimal TEA Rust image with only default features (memory, trace, data, llm,
# agent, reflection, reasoning, planning). No Prolog, no LTM backends.
#
# Build: docker build -t tea:rust-base -f docker/Dockerfile.rust-base .
# Size: ~50MB target
#
# Rust Variants:
#   - tea:rust-base (~50MB) - Minimal default features only
#   - tea:rust-full (~100MB) - All features (Scryer Prolog, DuckDB, Cozo)
#   - tea:rust-gemma3-1b (~1.6GB) - Full + bundled Gemma 3 1B model
#   - tea:rust-gemma3-4b (~4.5GB) - Full + bundled Gemma 3 4B model
#   - tea:rust-gemma3n-e4b (~8.5GB) - Full + bundled Gemma 3N E4B model
#   - tea:rust-phi4-mini (~3.5GB) - Full + bundled Phi-4 mini model
#
# OPTIMIZATION: Uses cargo-chef for efficient Docker layer caching.

# =============================================================================
# Stage 1: Chef - Prepare dependency recipe
# =============================================================================
FROM rust:latest AS chef
RUN cargo install cargo-chef --locked
WORKDIR /build

# =============================================================================
# Stage 2: Planner - Analyze dependencies
# =============================================================================
FROM chef AS planner
COPY rust/ ./
RUN cargo chef prepare --recipe-path recipe.json

# =============================================================================
# Stage 3: Builder - Build dependencies (cached) then source
# =============================================================================
FROM chef AS builder

# Install build dependencies for mlua (Lua bindings)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    pkg-config \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# Build dependencies first (this layer is cached if dependencies don't change)
COPY --from=planner /build/recipe.json recipe.json
RUN cargo chef cook --release --recipe-path recipe.json

# Now copy source and build (only this layer rebuilds on code changes)
COPY rust/ ./
RUN cargo build --release

# Verify binary was built
RUN ls -lh target/release/tea && \
    ./target/release/tea --version

# =============================================================================
# Stage 2: Runtime - Minimal container with static binary
# =============================================================================
FROM debian:bookworm-slim

# Install minimal runtime dependencies
# - ca-certificates: for HTTPS connections
# - libssl3: for TLS support in reqwest
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    libssl3 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /var/cache/apt/archives/*

# Copy the compiled binary
COPY --from=builder /build/target/release/tea /usr/local/bin/tea

# Verify binary works
RUN tea --version

# Create non-root user for security
RUN useradd -m -s /bin/bash tea \
    && mkdir -p /home/tea/.tea \
    && chown -R tea:tea /home/tea

# Switch to non-root user
USER tea

# Set working directory for mounted volumes
WORKDIR /work

# Labels for container registry
LABEL org.opencontainers.image.source="https://github.com/fabceolin/the_edge_agent"
LABEL org.opencontainers.image.description="TEA Rust Base - Minimal default features"
LABEL org.opencontainers.image.licenses="MIT"
LABEL tea.variant="rust-base"
LABEL tea.runtime="rust"

# Entrypoint is the tea CLI
ENTRYPOINT ["tea"]

# Default command shows help
CMD ["--help"]
