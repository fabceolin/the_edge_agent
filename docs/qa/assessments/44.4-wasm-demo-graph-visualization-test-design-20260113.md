# Test Design: Story 44.4 - WASM Demo Graph Visualization

Date: 2026-01-13
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 34
- Unit tests: 8 (24%)
- Integration tests: 10 (29%)
- E2E tests: 16 (47%)
- Priority distribution: P0: 10, P1: 16, P2: 8

**Note:** This story is frontend-heavy (HTML/CSS/JS) requiring higher E2E test ratio for browser validation.

## Test Scenarios by Acceptance Criteria

### AC1: Graph Display - WASM demo shows Mermaid graph when agent executed

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.4-E2E-001 | E2E | P0 | Graph panel visible in Opik tab after execution | Core feature visibility |
| 44.4-E2E-002 | E2E | P0 | Graph content rendered (not empty) after valid YAML | Content validation |
| 44.4-INT-001 | Integration | P0 | WASM `get_mermaid_graph()` callable from JS | WASM-JS bridge |
| 44.4-INT-002 | Integration | P1 | Graph updates on re-execution with different YAML | State refresh |

### AC2: Client-Side Rendering - Mermaid.js library renders diagrams

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.4-E2E-003 | E2E | P0 | Mermaid SVG inserted into DOM container | Render verification |
| 44.4-E2E-004 | E2E | P1 | Rendered graph contains expected nodes | Content accuracy |
| 44.4-E2E-005 | E2E | P1 | Rendered graph contains expected edges | Content accuracy |
| 44.4-UNIT-001 | Unit | P1 | `mermaid.render()` called with correct syntax | API usage |

### AC3: Dynamic Loading - Mermaid library loaded dynamically

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.4-UNIT-002 | Unit | P0 | `loadMermaid()` adds script tag to document head | Dynamic loading |
| 44.4-UNIT-003 | Unit | P1 | Mermaid cached after first load (no duplicate scripts) | Performance |
| 44.4-E2E-006 | E2E | P1 | Page loads without mermaid.js initially | Lazy loading |
| 44.4-E2E-007 | E2E | P1 | Mermaid loaded only on first graph render | On-demand loading |
| 44.4-INT-003 | Integration | P2 | CDN failure handled gracefully | Error resilience |

### AC4: Graph Topologies - Correctly renders linear, conditional, parallel

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.4-E2E-008 | E2E | P0 | Linear workflow renders `A --> B --> C` | Basic topology |
| 44.4-E2E-009 | E2E | P0 | Conditional edges show labels | Branch visualization |
| 44.4-E2E-010 | E2E | P1 | Parallel fan-out renders all branches | Parallel topology |
| 44.4-E2E-011 | E2E | P1 | Fan-in merges shown correctly | Parallel convergence |
| 44.4-E2E-012 | E2E | P2 | Mixed topology (parallel + conditional) renders | Complex workflow |
| 44.4-E2E-013 | E2E | P2 | Single-node workflow renders | Minimal case |

### AC5: Theme Consistency - Styling matches Opik dashboard dark theme

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.4-E2E-014 | E2E | P1 | Dark background on graph panel | Theme consistency |
| 44.4-UNIT-004 | Unit | P1 | Mermaid initialized with dark theme config | Config correctness |
| 44.4-E2E-015 | E2E | P2 | Node colors match CSS variables | Color scheme |
| 44.4-E2E-016 | E2E | P2 | Edge colors consistent with theme | Visual cohesion |

### AC6: Graceful Fallback - "Graph unavailable" message on failure

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.4-INT-004 | Integration | P0 | `get_mermaid_graph()` returning null shows fallback | Null handling |
| 44.4-INT-005 | Integration | P0 | Invalid Mermaid syntax shows fallback | Parse error handling |
| 44.4-E2E-017 | E2E | P1 | Error message displays icon and text | UX clarity |
| 44.4-INT-006 | Integration | P2 | Error logged to console for debugging | Developer experience |

### AC7: Layout Integration - Collapsible panel alongside trace timeline

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.4-E2E-018 | E2E | P1 | Graph panel positioned correctly in layout | Layout integration |
| 44.4-E2E-019 | E2E | P1 | Graph panel doesn't overlap trace timeline | Layout correctness |
| 44.4-E2E-020 | E2E | P2 | Responsive layout on narrow viewport | Mobile support |

### AC8: Interactive Features - Click to expand/collapse

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.4-UNIT-005 | Unit | P0 | `toggleGraphPanel()` toggles `expanded` class | Toggle functionality |
| 44.4-E2E-021 | E2E | P0 | Click header expands collapsed panel | Core interaction |
| 44.4-E2E-022 | E2E | P0 | Click header collapses expanded panel | Core interaction |
| 44.4-UNIT-006 | Unit | P1 | Panel state saved to localStorage | Persistence |
| 44.4-E2E-023 | E2E | P1 | Panel state restored on page reload | State restoration |
| 44.4-UNIT-007 | Unit | P2 | Panel defaults to collapsed | Default state |
| 44.4-E2E-024 | E2E | P2 | CSS transition animates expand/collapse | Visual polish |

## Browser Compatibility Tests

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.4-INT-007 | Integration | P1 | Chrome (latest) renders correctly | Primary browser |
| 44.4-INT-008 | Integration | P1 | Firefox (latest) renders correctly | Cross-browser |
| 44.4-INT-009 | Integration | P2 | Safari (latest) renders correctly | MacOS support |
| 44.4-INT-010 | Integration | P2 | Edge (latest) renders correctly | Windows support |

## Risk Coverage

| Risk | Mitigating Tests |
|------|------------------|
| Mermaid.js CDN unavailable | 44.4-INT-003 |
| Invalid Mermaid syntax crashes page | 44.4-INT-005, 44.4-E2E-017 |
| WASM-JS bridge failure | 44.4-INT-001 |
| Layout broken on mobile | 44.4-E2E-020 |
| localStorage not available | 44.4-UNIT-006 (graceful degradation) |
| Cross-browser rendering differences | 44.4-INT-007-010 |

## Recommended Execution Order

1. **P0 E2E tests** - Core graph display and interaction
2. **P0 Unit/Integration tests** - WASM bridge and dynamic loading
3. **P1 E2E tests** - Topology coverage and theme
4. **P1 Integration tests** - Browser compatibility
5. **P2 tests** - Edge cases and polish

## Test Implementation Notes

### E2E Test Setup Pattern (Playwright)

```typescript
// tests/wasm-demo-graph.spec.ts
import { test, expect } from '@playwright/test';

test.describe('WASM Demo Graph Visualization', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/docs/extra/wasm-demo/index.html');
  });

  test('AC1: Graph panel visible after execution', async ({ page }) => {
    // Enter YAML
    await page.fill('#yaml-editor', `
      name: test
      nodes:
        - name: process
          run: return state
      edges:
        - from: __start__
          to: process
        - from: process
          to: __end__
    `);

    // Execute
    await page.click('#run-opik-btn');
    await page.waitForSelector('#graph-panel');

    // Verify panel visible
    const panel = page.locator('#graph-panel');
    await expect(panel).toBeVisible();
  });

  test('AC4: Linear workflow renders correctly', async ({ page }) => {
    await page.fill('#yaml-editor', linearWorkflowYaml);
    await page.click('#run-opik-btn');

    // Expand panel
    await page.click('#graph-panel .panel-header');

    // Verify SVG contains expected nodes
    const svg = page.locator('#mermaid-container svg');
    await expect(svg).toContainText('Start');
    await expect(svg).toContainText('End');
    await expect(svg).toContainText('process');
  });

  test('AC8: Toggle expand/collapse', async ({ page }) => {
    await page.fill('#yaml-editor', simpleWorkflowYaml);
    await page.click('#run-opik-btn');

    const panel = page.locator('#graph-panel');
    const content = page.locator('#graph-content');

    // Initially collapsed
    await expect(panel).not.toHaveClass(/expanded/);

    // Click to expand
    await page.click('#graph-panel .panel-header');
    await expect(panel).toHaveClass(/expanded/);

    // Click to collapse
    await page.click('#graph-panel .panel-header');
    await expect(panel).not.toHaveClass(/expanded/);
  });
});
```

### Unit Test Pattern (JavaScript)

```javascript
// tests/graph-panel.test.js
describe('Graph Panel', () => {
  beforeEach(() => {
    document.body.innerHTML = `
      <div id="graph-panel">
        <div class="panel-header"></div>
        <div id="graph-content"></div>
      </div>
    `;
  });

  test('toggleGraphPanel adds expanded class', () => {
    const panel = document.getElementById('graph-panel');
    expect(panel.classList.contains('expanded')).toBe(false);

    toggleGraphPanel();

    expect(panel.classList.contains('expanded')).toBe(true);
  });

  test('toggleGraphPanel saves state to localStorage', () => {
    localStorage.clear();

    toggleGraphPanel();

    expect(localStorage.getItem('graphPanelExpanded')).toBe('true');

    toggleGraphPanel();

    expect(localStorage.getItem('graphPanelExpanded')).toBe('false');
  });
});
```

### Integration Test Pattern (WASM Bridge)

```typescript
// tests/wasm-mermaid-bridge.spec.ts
test('WASM get_mermaid_graph() returns valid string', async ({ page }) => {
  await page.goto('/docs/extra/wasm-demo/index.html');

  // Load YAML and wait for compilation
  await page.fill('#yaml-editor', validYaml);
  await page.click('#compile-btn');

  // Call WASM function directly
  const mermaid = await page.evaluate(() => {
    return window.getMermaidGraph();
  });

  expect(mermaid).not.toBeNull();
  expect(mermaid).toContain('graph TD');
});

test('WASM get_mermaid_graph() returns null before compilation', async ({ page }) => {
  await page.goto('/docs/extra/wasm-demo/index.html');

  const mermaid = await page.evaluate(() => {
    return window.getMermaidGraph();
  });

  expect(mermaid).toBeNull();
});
```

### Mermaid Loading Test Pattern

```typescript
test('Mermaid loaded dynamically on first render', async ({ page }) => {
  await page.goto('/docs/extra/wasm-demo/index.html');

  // Check no mermaid script initially
  let scripts = await page.locator('script[src*="mermaid"]').count();
  expect(scripts).toBe(0);

  // Execute YAML
  await page.fill('#yaml-editor', validYaml);
  await page.click('#run-opik-btn');

  // Expand panel to trigger render
  await page.click('#graph-panel .panel-header');

  // Wait for mermaid to load
  await page.waitForFunction(() => window.mermaid !== undefined);

  // Verify script added
  scripts = await page.locator('script[src*="mermaid"]').count();
  expect(scripts).toBe(1);
});
```

### Fallback Test Pattern

```typescript
test('AC6: Invalid Mermaid shows fallback message', async ({ page }) => {
  await page.goto('/docs/extra/wasm-demo/index.html');

  // Inject invalid mermaid directly (bypass WASM)
  await page.evaluate(() => {
    window.renderAgentGraph('invalid {{{{ mermaid syntax');
  });

  // Verify error message shown
  const errorDiv = page.locator('#graph-error');
  await expect(errorDiv).toBeVisible();
  await expect(errorDiv).toContainText('Graph unavailable');

  // Verify console error logged
  const logs = [];
  page.on('console', msg => logs.push(msg.text()));
  expect(logs.some(log => log.includes('[Graph] Render error'))).toBe(true);
});
```

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (E2E-heavy for frontend)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (core display = P0)
- [x] Test IDs follow naming convention (44.4-LEVEL-SEQ)
- [x] Scenarios are atomic and independent

## Manual Testing Checklist

For visual/interactive elements that require human verification:

- [ ] Graph styling matches Opik dashboard screenshots
- [ ] Expand/collapse animation is smooth (300ms)
- [ ] Graph readable at various zoom levels
- [ ] Touch interactions work on tablet
- [ ] No layout shifts during graph loading
- [ ] Status badge (check/X) clearly visible
- [ ] Icon rotation animation on expand

## Test Data (YAML Fixtures)

### Linear Workflow

```yaml
name: linear_test
nodes:
  - name: step1
    run: return state
  - name: step2
    run: return state
edges:
  - from: __start__
    to: step1
  - from: step1
    to: step2
  - from: step2
    to: __end__
```

### Conditional Workflow

```yaml
name: conditional_test
nodes:
  - name: check
    run: return {"path": "a"}
  - name: path_a
    run: return state
  - name: path_b
    run: return state
edges:
  - from: __start__
    to: check
  - from: check
    to: path_a
    condition: state.path == "a"
  - from: check
    to: path_b
    condition: state.path == "b"
  - from: path_a
    to: __end__
  - from: path_b
    to: __end__
```

### Parallel Workflow

```yaml
name: parallel_test
nodes:
  - name: fan_out
    run: return state
  - name: branch1
    run: return state
  - name: branch2
    run: return state
  - name: fan_in
    run: return state
edges:
  - from: __start__
    to: fan_out
  - from: fan_out
    to: [branch1, branch2]
    parallel: true
    fan_in: fan_in
  - from: fan_in
    to: __end__
```
