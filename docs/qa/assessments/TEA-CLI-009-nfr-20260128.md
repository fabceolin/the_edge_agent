# NFR Assessment: TEA-CLI-009

Date: 2026-01-28
Reviewer: Quinn (Test Architect)

## Summary

- Security: PASS - CLI input validation with clear boundaries
- Performance: PASS - O(1) skip logic, no re-execution overhead
- Reliability: CONCERNS - Off-by-one risk in 1-based indexing needs defensive coding
- Maintainability: CONCERNS - Test coverage target requires comprehensive boundary tests

## Assessment Details

### Security

**Status: PASS**

| Check | Finding | Evidence |
|-------|---------|----------|
| Input validation | Present | Wave/step bounds checked before execution |
| Label sanitization | Required | `--dot-start-from` label lookup must handle special chars |
| No command injection | Safe | Labels used for lookup, not shell execution |
| Error exposure | Low risk | Error messages show wave/step counts (non-sensitive) |

**Notes:**
- CLI options use typer's built-in type validation (int for wave/step)
- Label-based selection (`--dot-start-from`) uses dictionary lookup, not shell interpolation
- Error messages exposing wave/step counts and available labels are acceptable (non-sensitive operational data)

### Performance

**Status: PASS**

| Check | Finding | Evidence |
|-------|---------|----------|
| Skip efficiency | O(1) | Index-based skip with `continue` statement |
| Memory overhead | Minimal | No data structures for skipped phases |
| Execution plan | Already exists | `--dot-dry-run` infrastructure reused |
| Label lookup | O(n) build, O(1) query | Dictionary built once at start |

**Notes:**
- Skipping waves/steps is a simple index comparison - no wasted cycles
- The proposed implementation sketch in Dev Notes shows correct O(1) skip pattern
- Label-to-location mapping is built once and queried once per execution

### Reliability

**Status: CONCERNS**

| Check | Finding | Evidence |
|-------|---------|----------|
| Off-by-one errors | High risk | 1-based user facing vs 0-based internal indexing |
| Boundary validation | Required | Wave 0, step 0, N+1 cases need explicit checks |
| Mutual exclusivity | Missing | `--dot-start-from` vs wave/step conflict not yet implemented |
| Error handling | Adequate | Pattern follows existing typer.Exit(1) with console.print |
| State consistency | Good | Skip logic is pure (no side effects on skipped items) |

**Critical Issues:**

1. **Off-by-one Risk (TECH-001 from Risk Profile)**
   - Risk: User specifies `--dot-start-wave 1` expecting wave 1, code uses 0-based index
   - Mitigation: Use `enumerate(levels, 1)` consistently as shown in Dev Notes
   - Testing: Boundary tests for wave 1, N, N+1 are mandatory

2. **Label Lookup Robustness (DATA-001 from Risk Profile)**
   - Risk: DOT node labels may contain special characters that get transformed
   - Mitigation: Build label map with both original and normalized keys
   - Testing: Test with labels containing dots, spaces, quotes

### Maintainability

**Status: CONCERNS**

| Check | Finding | Evidence |
|-------|---------|----------|
| Code structure | Good | Follows existing `--dot-*` pattern in cli.py |
| Test coverage | Target 80% | Story requires comprehensive tests (Task 5) |
| Documentation | Required | AC-19, AC-20 specify doc updates |
| Code locality | Good | Changes concentrated in cli.py lines ~700-839 |
| Error messages | Clear | Specified in Dev Notes with exact format |

**Concerns:**

1. **Test Coverage Target**
   - 9 unit tests specified in Tasks section
   - Boundary conditions (0, 1, N, N+1) multiply test scenarios
   - Integration test with real DOT file required
   - Risk: Insufficient coverage of combined wave+step scenarios

2. **Documentation Debt**
   - `DOT_WORKFLOW_ORCHESTRATION_LLM_GUIDE.md` update required
   - CLI help text must match documented behavior exactly

## Critical Issues

1. **Off-by-one Indexing Risk** (Reliability/TECH-001)
   - Risk: Common developer error mixing 1-based user input with 0-based iteration
   - Fix: Add explicit assertion at validation boundary:
     ```python
     assert start_wave >= 1, "Wave number must be 1-based"
     if start_wave > len(levels):
         raise ValueError(f"Invalid wave {start_wave}. This DOT has {len(levels)} waves.")
     ```
   - Testing: Parameterized tests covering [0, 1, N-1, N, N+1] for both wave and step

2. **Mutual Exclusivity Enforcement** (Reliability/TECH-003)
   - Risk: Confusing behavior if user provides both `--dot-start-from` and `--dot-start-wave`
   - Fix: Add explicit check early in command handler (as noted in Dev Notes)
   - Testing: Test that error is raised with clear message

## Quick Wins

- Add assertions at validation boundaries (prevents off-by-one bugs)
- Normalize label keys in lookup map (handles special character edge cases)
- Parameterized pytest tests cover boundaries efficiently

## Gate YAML Block

```yaml
# Gate YAML (copy/paste):
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: PASS
    notes: 'CLI input validation present, no command injection vectors'
  performance:
    status: PASS
    notes: 'O(1) skip logic, no re-execution overhead'
  reliability:
    status: CONCERNS
    notes: 'Off-by-one indexing risk (TECH-001) requires defensive coding and boundary tests'
  maintainability:
    status: CONCERNS
    notes: 'Test coverage target 80%, comprehensive boundary tests required'
```

## Quality Score

```
quality_score = 100
- 10 for reliability CONCERNS
- 10 for maintainability CONCERNS
= 80/100
```

---

NFR assessment: docs/qa/assessments/TEA-CLI-009-nfr-20260128.md

Gate NFR block ready â†’ paste into docs/qa/gates/TEA-CLI-009-dot-wave-step-selection.yml under nfr_validation
