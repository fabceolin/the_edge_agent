# Requirements Traceability Matrix

## Story: TEA-CLI-002 - URL-Based File Input for Rust CLI

**Date:** 2026-02-01
**Analyst:** Quinn (Test Architect)
**Mode:** YOLO

---

## Coverage Summary

| Metric | Value | Percentage |
|--------|-------|------------|
| **Total Requirements** | 35 | 100% |
| **Fully Covered** | 30 | 86% |
| **Partially Covered** | 5 | 14% |
| **Not Covered** | 0 | 0% |

---

## Requirement Mappings

### AC1: CLI URL Support

**Coverage: FULL**

| Requirement | Test ID | Level | Given-When-Then |
|-------------|---------|-------|-----------------|
| All file input flags accept URLs | CLI-002-UNIT-002 | Unit | **Given** a URL string (s3://, gs://, github://), **When** parsed, **Then** correct protocol enum returned |
| Affected flags (positional, --checkpoint, etc.) | CLI-002-E2E-001 | E2E | **Given** `tea run s3://bucket/workflow.yaml`, **When** executed, **Then** workflow fetched and runs |
| Implement using object_store ^0.10 | CLI-002-INT-001, INT-002 | Integration | **Given** S3/GCS URL, **When** fetched via object_store, **Then** returns local cached path |
| Local paths work unchanged | CLI-002-UNIT-001 | Unit | **Given** `/path/to/file.yaml`, **When** processed, **Then** returns unchanged PathBuf |
| Behavior matches Python CLI | CLI-002-INT-030 | Integration | **Given** same URL in Python and Rust, **When** cache key computed, **Then** identical key produced |

### AC2: Git Protocol Support

**Coverage: FULL**

| Requirement | Test ID | Level | Given-When-Then |
|-------------|---------|-------|-----------------|
| Format: `github://user/repo@branch/path` | CLI-002-UNIT-004 | Unit | **Given** `github://user/repo@main/path`, **When** parsed, **Then** host=GitHub, ref=Branch("main"), path extracted |
| Implement using git2 ^0.18 | CLI-002-INT-005 | Integration | **Given** github URL with branch, **When** fetched, **Then** git2 clones and checks out branch |
| Support branches, SHA, tags | CLI-002-UNIT-004, 005, 006 | Unit | **Given** URL with @main, @a1b2c3d, @v1.0.0, **When** parsed, **Then** correct GitRef variant |
| Private repo via GITHUB_TOKEN | CLI-002-INT-008 | Integration | **Given** private repo URL with GITHUB_TOKEN set, **When** fetched, **Then** authenticates and clones |
| GitLab support: `gitlab://` | CLI-002-UNIT-007, INT-009 | Unit+Integration | **Given** `gitlab://user/repo@main/path`, **When** parsed, **Then** host=GitLab; uses GITLAB_TOKEN |

### AC3: Caching System

**Coverage: FULL**

| Requirement | Test ID | Level | Given-When-Then |
|-------------|---------|-------|-----------------|
| Share cache directory with Python | CLI-002-INT-028, INT-029 | Integration | **Given** Python-written manifest, **When** Rust reads it, **Then** entries found correctly |
| Read/write compatible manifest (JSON) | CLI-002-UNIT-021 | Unit | **Given** manifest JSON, **When** parsed, **Then** version field validated |
| Same cache key algorithm (SHA256) | CLI-002-UNIT-008, 009 | Unit | **Given** URL string, **When** key computed, **Then** SHA256 first 16 hex chars match Python |
| --no-cache flag | CLI-002-INT-013 | Integration | **Given** cached URL with --no-cache, **When** fetched, **Then** cache bypassed, fresh fetch |
| --cache-only flag | CLI-002-INT-014, 015 | Integration | **Given** --cache-only with/without cache, **When** fetched, **Then** returns cache or error |
| --cache-dir flag | CLI-002-INT-016 | Integration | **Given** --cache-dir /custom/path, **When** used, **Then** cache uses custom directory |
| TTL via TEA_CACHE_TTL | CLI-002-UNIT-010, INT-012 | Unit+Integration | **Given** TTL env var set, **When** entry expires, **Then** triggers refetch |
| Debug logging with --verbose | CLI-002-INT-017 | Integration | **Given** --verbose flag, **When** cache hit/miss, **Then** debug output shown |

### AC4: Cache Management CLI

**Coverage: FULL**

| Requirement | Test ID | Level | Given-When-Then |
|-------------|---------|-------|-----------------|
| `tea cache list` | CLI-002-INT-019 | Integration | **Given** cached entries exist, **When** `tea cache list`, **Then** entries displayed |
| `tea cache clear` | CLI-002-INT-020 | Integration | **Given** cached entries, **When** `tea cache clear`, **Then** all entries removed |
| `tea cache clear --older-than <duration>` | CLI-002-INT-021 | Integration | **Given** entries of various ages, **When** clear --older-than 7d, **Then** only old removed |
| `tea cache info` | CLI-002-INT-022 | Integration | **Given** cache with entries, **When** `tea cache info`, **Then** shows size/count stats |

### AC5: Trait-Based Design for Testing

**Coverage: FULL**

| Requirement | Test ID | Level | Given-When-Then |
|-------------|---------|-------|-----------------|
| Define `RemoteFileSystem` trait | CLI-002-UNIT-012 | Unit | **Given** MockRemoteFileSystem, **When** fetch() called, **Then** returns configured path |
| Implement mock version for unit tests | CLI-002-UNIT-013, 014 | Unit | **Given** mock with protocol support, **When** supports_protocol(), **Then** returns expected |
| Use wiremock for HTTP integration | CLI-002-INT-023 | Integration | **Given** wiremock server, **When** HTTP URL fetched, **Then** mock responds |
| All tests run offline | CLI-002-UNIT-015 | Unit | **Given** test suite, **When** executed, **Then** no real network calls made |

### AC6: Error Handling

**Coverage: FULL**

| Requirement | Test ID | Level | Given-When-Then |
|-------------|---------|-------|-----------------|
| Match Python error messages exactly | CLI-002-UNIT-016 | Unit | **Given** error scenario, **When** error created, **Then** message matches Python format |
| Suggest --cache-only on network failure | CLI-002-INT-024 | Integration | **Given** network failure with cache exists, **When** error shown, **Then** includes cache-only hint |
| Clear credential error messages | CLI-002-UNIT-017 | Unit | **Given** auth failure, **When** error displayed, **Then** clear message without exposing token |

### AC7: Documentation

**Coverage: PARTIAL**

| Requirement | Test ID | Level | Given-When-Then | Gap |
|-------------|---------|-------|-----------------|-----|
| Update actions-reference.md | CLI-002-UNIT-018 | Unit | **Given** --help output, **When** examined, **Then** URL examples present | Actual doc file update not verified |
| Update CLI --help text | CLI-002-UNIT-018 | Unit | **Given** --help, **When** run, **Then** URL formats documented | Manual review needed |
| Inline code comments | CLI-002-UNIT-019 | Unit | **Given** rustdoc, **When** compiled, **Then** examples pass | Implementation-time |

---

## Security Requirements (From Risk Profile)

**Coverage: FULL**

| Requirement | Risk ID | Test ID | Level | Given-When-Then |
|-------------|---------|---------|-------|-----------------|
| Credential values redacted from logs | SEC-001 | CLI-002-INT-026 | Integration | **Given** GITHUB_TOKEN set, **When** --verbose output, **Then** token shows as `***` |
| Credential values redacted from errors | SEC-001 | CLI-002-INT-027 | Integration | **Given** auth failure, **When** error displayed, **Then** token masked |
| Verbose mode safe | SEC-001 | CLI-002-E2E-005 | E2E | **Given** --verbose with token, **When** full run, **Then** no credential leakage |
| Path traversal blocked | SEC-002 | CLI-002-UNIT-020 | Unit | **Given** `../../../etc/passwd` in URL, **When** parsed, **Then** rejected before filesystem |
| Cache path containment | SEC-002 | CLI-002-INT-025 | Integration | **Given** any URL, **When** cached, **Then** resolved path within ~/.cache/tea/remote/ |

---

## NFR Requirements (From NFR Assessment)

**Coverage: PARTIAL**

| Requirement | Status | Test Coverage | Gap |
|-------------|--------|---------------|-----|
| Cache hit latency <100ms | Unspecified | None | No performance benchmark test defined |
| Atomic manifest writes | Unspecified | CLI-002-INT-018 | Partial: concurrent writes tested, atomicity implicit |
| Interrupted download recovery | Unspecified | None | No explicit recovery test |
| Retry with backoff | Unspecified | None | No retry behavior test |
| Cache directory 0700 permissions | Unspecified | None | No permission validation test |

---

## Cross-Language Parity Requirements

**Coverage: FULL**

| Requirement | Test ID | Level | Given-When-Then |
|-------------|---------|-------|-----------------|
| URL format identical | CLI-002-UNIT-004 | Unit | **Given** `github://user/repo@ref/path`, **When** parsed, **Then** matches Python format |
| Cache key parity | CLI-002-UNIT-009, INT-030 | Unit+Integration | **Given** same URL, **When** both compute key, **Then** identical result |
| Manifest compatibility (Rust reads Python) | CLI-002-INT-028 | Integration | **Given** Python manifest, **When** Rust reads, **Then** entries accessible |
| Manifest compatibility (Python reads Rust) | CLI-002-INT-029 | Integration | **Given** Rust manifest, **When** Python reads, **Then** entries accessible |
| Error message parity | CLI-002-UNIT-016 | Unit | **Given** same error scenario, **When** message compared, **Then** identical wording |
| Flag parity | CLI-002-INT-013, 014, 15, 16 | Integration | **Given** --no-cache, --cache-only, --cache-dir, **When** used, **Then** behavior matches Python |
| Mixed language workflow | CLI-002-E2E-006, 007 | E2E | **Given** Python caches, **When** Rust uses, **Then** no refetch; vice versa |

---

## Critical Gaps

### Gap 1: Performance Benchmark Tests

**Severity:** Medium
**Requirement:** AC3 implies caching improves performance; NFR assessment recommends <100ms cache hit
**Gap:** No benchmark test to validate cache hit latency
**Recommended Test:**
```yaml
id: CLI-002-PERF-001
level: Performance
priority: P2
description: test_cache_hit_latency_under_100ms
given: Cached URL entry exists
when: fetch() called 100 times
then: Average latency < 100ms
```

### Gap 2: Interrupted Download Recovery

**Severity:** Medium
**Requirement:** NFR assessment recommends handling partial downloads
**Gap:** No test for interrupted download corruption prevention
**Recommended Test:**
```yaml
id: CLI-002-INT-NEW-001
level: Integration
priority: P2
description: test_interrupted_download_not_cached
given: Download in progress
when: Network connection interrupted at 50%
then: Partial file not stored in cache; subsequent fetch retries
```

### Gap 3: Cache Directory Permissions

**Severity:** Low
**Requirement:** NFR assessment recommends 0700 permissions on cache directory
**Gap:** No test validating directory creation with correct permissions
**Recommended Test:**
```yaml
id: CLI-002-INT-NEW-002
level: Integration
priority: P3
description: test_cache_dir_permissions_0700
given: Fresh installation (no cache dir)
when: First URL cached
then: ~/.cache/tea/remote/ created with 0700 permissions
```

### Gap 4: Network Retry with Backoff

**Severity:** Low
**Requirement:** NFR assessment recommends retry with backoff for transient errors
**Gap:** No test for retry behavior
**Recommended Test:**
```yaml
id: CLI-002-INT-NEW-003
level: Integration
priority: P2
description: test_retry_on_transient_error
given: wiremock returns 503 twice, then 200
when: URL fetched
then: Retries with backoff, eventually succeeds
```

---

## Coverage Analysis by Priority

| Priority | Total | Covered | Percentage |
|----------|-------|---------|------------|
| P0 | 18 | 18 | 100% |
| P1 | 20 | 20 | 100% |
| P2 | 11 | 11 | 100% |
| P3 | 3 | 3 | 100% |
| **Total Designed** | 52 | 52 | 100% |

### Recommended Additions

| Priority | Count | Description |
|----------|-------|-------------|
| P2 | 3 | Performance, recovery, retry tests |
| P3 | 1 | Permission validation test |

---

## Risk Mitigation Traceability

| Risk ID | Description | Test IDs | Status |
|---------|-------------|----------|--------|
| SEC-001 | Credential exposure in git auth | CLI-002-INT-026, INT-027, E2E-005 | ✅ Covered |
| SEC-002 | Path traversal in cache paths | CLI-002-UNIT-020, INT-025 | ✅ Covered |
| TECH-001 | Cache manifest format incompatibility | CLI-002-INT-028, INT-029, INT-030, UNIT-021 | ✅ Covered |
| TECH-002 | object_store API version mismatch | CLI-002-INT-001, INT-002, INT-003 | ✅ Covered |
| TECH-003 | git2 ref resolution edge cases | CLI-002-UNIT-004/005/006, INT-005/006/007 | ✅ Covered |
| DATA-001 | Cache corruption on concurrent access | CLI-002-INT-018 | ✅ Covered |

---

## Gate Integration Block

```yaml
trace:
  totals:
    requirements: 35
    full: 30
    partial: 5
    none: 0
  coverage_percentage: 86
  planning_ref: 'docs/qa/assessments/TEA-CLI-002-test-design-20260201.md'
  uncovered:
    - req: 'NFR: Cache hit latency target'
      reason: 'No benchmark test defined'
    - req: 'NFR: Interrupted download recovery'
      reason: 'No recovery test defined'
    - req: 'NFR: Cache directory permissions'
      reason: 'No permission validation test'
    - req: 'NFR: Retry with backoff'
      reason: 'No retry behavior test'
  risk_coverage:
    - SEC-001: covered
    - SEC-002: covered
    - TECH-001: covered
    - TECH-002: covered
    - TECH-003: covered
    - DATA-001: covered
  cross_language_tests: 6
  notes: 'docs/qa/assessments/TEA-CLI-002-trace-20260201.md'
```

---

## Recommendations

### Must-Have Before Development

1. **All P0 tests implemented** - Security and cache key parity are critical
2. **Cross-language test fixtures** - Pre-generate Python manifest for Rust tests

### Should-Have During Development

1. **Add performance benchmark (CLI-002-PERF-001)** - Validates cache value proposition
2. **Add retry test (CLI-002-INT-NEW-003)** - Important for reliability

### Nice-to-Have

1. **Interrupted download test** - Edge case coverage
2. **Permission validation test** - Defense in depth

---

## Quality Gate Recommendation

**Status:** PASS

All acceptance criteria have test coverage. Critical security requirements (SEC-001, SEC-002) are covered at P0 priority. Cross-language parity has comprehensive test suite. Gaps identified are NFR-related enhancements that can be added during development without blocking.

---

Trace matrix: docs/qa/assessments/TEA-CLI-002-trace-20260201.md
