# Risk Profile: Story TEA-CLI-002

Date: 2026-02-01
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 1
- High Risks: 2
- Risk Score: 55/100 (moderate-high risk)

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: Credential Exposure in Git Authentication

**Score: 9 (Critical)**
**Probability**: High (3) - Environment variables are standard practice but easily mishandled
**Impact**: High (3) - Token exposure could compromise private repositories and potentially organization-wide access

**Mitigation**:
- Never log or display tokens in verbose mode
- Use secure credential storage patterns (git2's credential helpers)
- Implement token redaction in all error messages and logs
- Consider supporting SSH keys as alternative authentication

**Testing Focus**:
- Credential handling unit tests
- Log output scanning for token leakage
- Error message review for credential exposure

## Risk Distribution

### By Category

- Security: 2 risks (1 critical, 1 high)
- Technical: 3 risks (1 high, 2 medium)
- Data: 1 risk (medium)
- Performance: 1 risk (low)
- Operational: 1 risk (low)

### By Component

- Git Module: 3 risks
- Cache Module: 2 risks
- Cloud Storage: 2 risks
- CLI Integration: 1 risk

## Detailed Risk Register

| Risk ID   | Description                              | Probability | Impact     | Score | Priority |
|-----------|------------------------------------------|-------------|------------|-------|----------|
| SEC-001   | Credential exposure in git auth          | High (3)    | High (3)   | 9     | Critical |
| SEC-002   | Path traversal in cache paths            | Medium (2)  | High (3)   | 6     | High     |
| TECH-001  | Cache manifest format incompatibility    | Medium (2)  | High (3)   | 6     | High     |
| TECH-002  | object_store API version mismatch        | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-003  | git2 ref resolution edge cases           | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-001  | Cache corruption on concurrent access    | Low (1)     | High (3)   | 3     | Low      |
| PERF-001  | Large repo clone blocking execution      | Low (1)     | Medium (2) | 2     | Low      |
| OPS-001   | Missing cache cleanup on error paths     | Low (1)     | Low (1)    | 1     | Minimal  |

## Risk Details

### SEC-001: Credential Exposure in Git Authentication
- **Category**: Security
- **Affected Components**: `rust/src/remote/git.rs`
- **Detection Method**: Design review
- **Mitigation Strategy**: Preventive
  - Implement token redaction in all logging
  - Use memory-safe credential handling
  - Add credential exposure tests
- **Residual Risk**: Low after mitigation

### SEC-002: Path Traversal in Cache Paths
- **Category**: Security
- **Affected Components**: `rust/src/remote/cache.rs`
- **Detection Method**: Design review of cache key mechanism
- **Mitigation Strategy**: Preventive
  - Validate all paths are within cache directory
  - Use canonicalization before file operations
  - Reject URLs with path traversal sequences
- **Residual Risk**: Minimal after mitigation

### TECH-001: Cache Manifest Format Incompatibility
- **Category**: Technical
- **Affected Components**: `rust/src/remote/cache.rs`
- **Detection Method**: Cross-language integration requirements
- **Mitigation Strategy**: Preventive
  - Implement manifest version checking
  - Add Python-Rust interoperability tests
  - Use property-based testing for edge cases
- **Residual Risk**: Low with comprehensive testing

### TECH-002: object_store API Version Mismatch
- **Category**: Technical
- **Affected Components**: `rust/src/remote/cloud.rs`
- **Detection Method**: Dependency analysis (object_store ^0.10 specified)
- **Mitigation Strategy**: Detective
  - Pin exact version in Cargo.toml
  - Add integration tests for each cloud provider
- **Residual Risk**: Low

### TECH-003: git2 Ref Resolution Edge Cases
- **Category**: Technical
- **Affected Components**: `rust/src/remote/git.rs`
- **Detection Method**: Code review of GitRef enum design
- **Mitigation Strategy**: Preventive
  - Test branch vs tag vs SHA disambiguation
  - Handle detached HEAD states
  - Test refs with special characters
- **Residual Risk**: Low with thorough testing

### DATA-001: Cache Corruption on Concurrent Access
- **Category**: Data
- **Affected Components**: `rust/src/remote/cache.rs`
- **Detection Method**: Design review
- **Mitigation Strategy**: Preventive
  - Use file locking for manifest updates
  - Atomic file writes with rename
  - Implement cache integrity checks
- **Residual Risk**: Minimal

### PERF-001: Large Repo Clone Blocking Execution
- **Category**: Performance
- **Affected Components**: `rust/src/remote/git.rs`
- **Detection Method**: Design review
- **Mitigation Strategy**: Detective
  - Consider sparse checkout or shallow clone
  - Add progress indicators
  - Document expected behavior
- **Residual Risk**: Acceptable for MVP

### OPS-001: Missing Cache Cleanup on Error Paths
- **Category**: Operational
- **Affected Components**: `rust/src/remote/cache.rs`
- **Detection Method**: Code review
- **Mitigation Strategy**: Corrective
  - Implement RAII cleanup patterns
  - Add error path tests
- **Residual Risk**: Minimal

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (SEC-001)
- [ ] Verify tokens never appear in logs at any verbosity level
- [ ] Test credential helper fallback paths
- [ ] Verify error messages don't expose credentials
- [ ] Security audit of git2 credential callback implementation

### Priority 2: High Risk Tests (SEC-002, TECH-001)
- [ ] Path traversal attack vectors in cache key generation
- [ ] Python-Rust cache manifest round-trip tests
- [ ] Manifest version migration scenarios
- [ ] Cross-process cache access tests

### Priority 3: Medium Risk Tests (TECH-002, TECH-003)
- [ ] object_store mock tests for S3, GCS, Azure
- [ ] Git ref resolution: branches, tags, SHAs, detached HEAD
- [ ] Special characters in branch names

### Priority 4: Low Risk Tests
- [ ] Large repository clone behavior
- [ ] Concurrent cache access
- [ ] Error path cleanup verification

## Risk Acceptance Criteria

### Must Fix Before Production
- SEC-001: Credential exposure (score 9)
- SEC-002: Path traversal (score 6)
- TECH-001: Cache compatibility (score 6)

### Can Deploy with Mitigation
- TECH-002: API version (with pinned dependencies)
- TECH-003: Ref resolution (with documented limitations)

### Accepted Risks
- DATA-001: Cache corruption (low probability, recovery possible)
- PERF-001: Large repo clone (documented limitation)
- OPS-001: Cleanup (minor impact)

## Monitoring Requirements

Post-deployment monitoring for:
- Authentication failure rates
- Cache hit/miss ratios
- Clone operation durations
- Error rate by URL protocol

## Risk Review Triggers

Review and update risk profile when:
- object_store or git2 major version changes
- New authentication methods added
- Cache format changes
- Security vulnerabilities discovered in dependencies
