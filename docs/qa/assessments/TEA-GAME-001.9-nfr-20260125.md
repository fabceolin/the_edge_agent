# NFR Assessment: TEA-GAME-001.9

**Date**: 2026-01-25
**Reviewer**: Quinn (Test Architect)
**Story**: Phrase Database Integration - Brownfield Addition
**Mode**: YOLO (Non-Interactive)

## Summary

| NFR | Status | Notes |
|-----|--------|-------|
| Security | PASS | No new attack surfaces; compile-time JSON embed is safe |
| Performance | CONCERNS | WASM bundle size increase not yet measured; DuckDB query perf target unknown |
| Reliability | CONCERNS | Phrase exhaustion edge case handling unclear |
| Maintainability | PASS | Clean separation of concerns; existing test patterns followed |

**Quality Score**: 80/100 (2 CONCERNS × 10 = -20)

## Detailed Assessment

### Security: PASS

**Evidence Present:**
- Phrase data is embedded at compile-time via `include_str!` - no runtime file access required
- No user-generated content in phrase database (curated 1039 phrases)
- No SQL injection risk - data loaded directly into DuckDB via Rust structs
- `game.js:695` implements `escapeHtml()` for XSS prevention when rendering usernames

**No New Attack Surfaces:**
- Phrase loading uses serde_json deserialization with strong typing
- DuckDB schema uses parameterized queries (existing pattern in `duckdb.rs`)
- No external network calls for phrase fetching (compile-time embed)

**Validation:**
- Input validation present via struct typing (`Phrase` struct with typed fields)
- No hardcoded secrets in phrase data or loading logic

### Performance: CONCERNS

**Target Unknown:**
- No explicit response time target for phrase selection
- No explicit bundle size limit for WASM increase

**Risk Areas:**
1. **WASM Bundle Size** (Identified in Risk Profile TECH-001)
   - 1039 phrases × ~200 bytes average = ~200KB JSON overhead
   - Compressed may reduce to ~50-100KB but impact on `tea_wasm_llm_bg.wasm` unknown
   - **Recommendation**: Measure before/after; fail CI if >500KB increase

2. **DuckDB Query Performance**
   - `get_random_phrase(min, max, exclude_ids)` requires:
     - Range query on `difficulty` index
     - Exclusion of `used_phrase_ids` (up to 50+ IDs in long sessions)
     - Random selection from result set
   - **Mitigation**: Story specifies DuckDB index on difficulty column (AC-1)
   - **Target**: Query should complete <10ms (no explicit target in story)

3. **Phrase Loading on Init**
   - 1039 phrases inserted into DuckDB on WASM init
   - One-time cost but could delay game start
   - **Target Unknown**: No startup time requirement specified

**Positive Evidence:**
- Removes LLM call from round generation (major performance improvement)
- Phrase selection is O(1) vs O(LLM latency) for previous approach

### Reliability: CONCERNS

**Evidence Present:**
- Error handling follows existing pattern in `game.rs` (Result<T, (String, GameErrorType)>)
- Timeout handling in `game.js` (90s LLM timeout, 15s warning)
- Session state tracking with `used_phrase_ids` prevents duplicates

**Edge Cases with Unclear Handling:**
1. **Phrase Exhaustion** (DATA-001 in Risk Profile)
   - 1039 phrases with difficulty range ±0.15
   - At difficulty 0.9, only ~147 hard phrases available
   - Long session (50+ rounds) could exhaust phrases in difficulty band
   - **Question**: What happens when `get_random_phrase()` returns empty?
   - Story T3 mentions "Handle case when all phrases at difficulty used" but no fallback specified

2. **DuckDB Initialization Failure**
   - Story doesn't specify recovery if phrase table creation fails
   - Existing error types include `GameErrorType::DbError` but flow unclear

3. **JSON Parse Failure**
   - Compile-time `include_str!` with `serde_json::from_str` could panic on invalid JSON
   - **Mitigation**: Static JSON generated by script should be valid

**Retry Logic:**
- `game.js` has `retryLastAction()` for user-initiated retry
- No automatic retry for transient failures

### Maintainability: PASS

**Evidence Present:**
- Test coverage explicitly required (AC-10, AC-11, AC-12)
- Task T6 specifies: phrase loading test, random selection test, regression test
- Follows existing `game.rs` patterns (22 unit tests already present)

**Code Structure:**
- New `Phrase` and `PhrasesFile` structs follow existing style
- `get_random_phrase()` encapsulates selection logic
- DuckDB schema change is additive (new table, no ALTER)

**Documentation:**
- Story contains detailed technical notes with code examples
- Integration diagram provided
- Change log maintained

**Test Design Alignment:**
- AC maps to specific test requirements:
  - AC-10 → Test phrase loading with sample data
  - AC-11 → Test random selection with exclusion
  - AC-12 → No regression (existing tests pass)

## Critical Issues

1. **No Performance Targets Defined** (Performance)
   - Risk: Cannot objectively validate success
   - Fix: Define thresholds:
     - WASM bundle increase: <500KB
     - Phrase query latency: <10ms
     - Game startup time: <1s additional

2. **Phrase Exhaustion Fallback Undefined** (Reliability)
   - Risk: Game could freeze or crash on long sessions
   - Fix: Specify fallback behavior:
     - Option A: Expand difficulty range when exhausted
     - Option B: Allow phrase repetition after full cycle
     - Option C: End game with "out of phrases" message

## Quick Wins

1. **Add bundle size check to CI** (~1 hour)
   - Compare `wasm-pack build` output size before/after
   - Fail if delta >500KB

2. **Define phrase exhaustion fallback** (~2 hours)
   - Add to AC-3: "If no phrases available, expand range by 0.1 and retry"
   - Test with small phrase subset

3. **Add startup time logging** (~30 min)
   - Log phrase table population time
   - Baseline for future optimization

## Gate YAML Block

```yaml
# Gate NFR block - paste into docs/qa/gates/TEA-GAME-001.9-phrase-database.yml
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: PASS
    notes: 'Compile-time JSON embed; no new attack surfaces; XSS prevention in UI'
  performance:
    status: CONCERNS
    notes: 'Bundle size and query latency targets undefined; measure before/after'
  reliability:
    status: CONCERNS
    notes: 'Phrase exhaustion fallback not specified; edge case handling unclear'
  maintainability:
    status: PASS
    notes: 'Test requirements explicit; follows existing patterns; additive changes'
```

---

**NFR assessment**: docs/qa/assessments/TEA-GAME-001.9-nfr-20260125.md

**Gate NFR block ready** → paste into docs/qa/gates/TEA-GAME-001.9-phrase-database.yml under nfr_validation
