# Test Design: Story 44.1 - Mermaid Graph Export

Date: 2026-01-13
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 28
- Unit tests: 18 (64%)
- Integration tests: 8 (29%)
- E2E tests: 2 (7%)
- Priority distribution: P0: 10, P1: 12, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: Mermaid Method - `StateGraph::to_mermaid()` returns valid Mermaid `graph TD` syntax

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.1-UNIT-001 | Unit | P0 | `to_mermaid()` returns string starting with `graph TD` | Core output format validation |
| 44.1-UNIT-002 | Unit | P0 | Empty graph returns valid minimal Mermaid (header only) | Edge case - prevent panic |
| 44.1-UNIT-003 | Unit | P1 | Single node graph produces valid syntax | Minimal graph validation |
| 44.1-UNIT-004 | Unit | P1 | Complex graph with 10+ nodes produces valid syntax | Scalability validation |

### AC2: Simple Edges - Rendered as `A-->B`

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.1-UNIT-005 | Unit | P0 | Linear graph `A --> B --> C` produces correct edge syntax | Core edge rendering |
| 44.1-UNIT-006 | Unit | P1 | Multiple edges from single node rendered correctly | Fan-out without labels |
| 44.1-UNIT-007 | Unit | P1 | Self-loop edge `A --> A` handled correctly | Edge case for while loops |

### AC3: Conditional Edges - Show labels `A-->|condition|B`

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.1-UNIT-008 | Unit | P0 | Conditional edge with Lua expression shows label | Core conditional rendering |
| 44.1-UNIT-009 | Unit | P0 | True/false trivial conditions use descriptive labels | User experience - readable graphs |
| 44.1-UNIT-010 | Unit | P1 | Multi-branch conditional (3+ targets) renders all branches | Complex conditional support |
| 44.1-UNIT-011 | Unit | P2 | Long condition text truncated appropriately | Visual readability |

### AC4: Parallel Edges - Show fan-in notation `A-->|parallel->fan_in|B`

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.1-UNIT-012 | Unit | P0 | Parallel edge shows branch name and fan-in target | Core parallel rendering |
| 44.1-UNIT-013 | Unit | P1 | Multiple parallel branches from same source rendered | Fan-out correctness |
| 44.1-UNIT-014 | Unit | P1 | Nested parallel (parallel within parallel) handled | Complex workflow support |
| 44.1-INT-001 | Integration | P1 | Parallel flow with real graph execution matches rendered structure | Execution-rendering parity |

### AC5: Special Nodes - Start/End rendered as circles `((label))`

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.1-UNIT-015 | Unit | P0 | `__start__` rendered as `__start__((Start))` | Visual distinction for start |
| 44.1-UNIT-016 | Unit | P0 | `__end__` rendered as `__end__((End))` | Visual distinction for end |
| 44.1-UNIT-017 | Unit | P1 | Regular nodes rendered as rectangles `[label]` | Standard node shape |

### AC6: Node Escaping - Special characters replaced with underscores

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.1-UNIT-018 | Unit | P0 | Spaces in node names replaced with underscores | Mermaid syntax compliance |
| 44.1-UNIT-019 | Unit | P1 | Dots, hyphens, parentheses escaped | Full special character handling |
| 44.1-UNIT-020 | Unit | P2 | Pipe characters `|` escaped (Mermaid label delimiter) | Edge case - prevents syntax errors |
| 44.1-UNIT-021 | Unit | P2 | Unicode characters handled without crash | Internationalization support |

### AC7: YAML Engine Access - `YamlEngine::get_mermaid_graph()` accessor

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.1-INT-002 | Integration | P0 | `get_mermaid_graph()` returns valid Mermaid from compiled YAML | End-to-end YAML integration |
| 44.1-INT-003 | Integration | P0 | `get_mermaid_graph()` returns `None` before compilation | Correct pre-compile state |
| 44.1-INT-004 | Integration | P1 | Graph accessible after execution completes | Post-execution access |

### AC8: Opik Integration - `_opik_graph_definition` metadata

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.1-INT-005 | Integration | P0 | OpikHandler sends `_opik_graph_definition` with format and data | Opik protocol compliance |
| 44.1-INT-006 | Integration | P1 | Graph only sent on first trace event | Bandwidth optimization |
| 44.1-INT-007 | Integration | P2 | Graph omitted if Mermaid generation fails | Graceful degradation |

### AC9: No New Dependencies - Pure string generation

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.1-INT-008 | Integration | P1 | `to_mermaid()` works without external crates | Dependency isolation |

### AC10: Unit Tests - Verification coverage

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 44.1-E2E-001 | E2E | P1 | Linear workflow YAML → Mermaid → validates in mermaid.live | Full roundtrip validation |
| 44.1-E2E-002 | E2E | P2 | Complex mixed workflow validates in mermaid.live | Complex topology validation |

## Risk Coverage

| Risk | Mitigating Tests |
|------|------------------|
| Invalid Mermaid syntax breaks Opik UI | 44.1-UNIT-001, 44.1-E2E-001, 44.1-E2E-002 |
| Panic on edge cases (empty graph, special chars) | 44.1-UNIT-002, 44.1-UNIT-018-021 |
| Performance on large graphs | 44.1-UNIT-004 |
| Incorrect parallel flow representation | 44.1-UNIT-012-014, 44.1-INT-001 |
| YAML engine returns stale/null graph | 44.1-INT-002-004 |

## Recommended Execution Order

1. **P0 Unit tests** (44.1-UNIT-001, 002, 005, 008, 009, 012, 015, 016, 018) - Core correctness
2. **P0 Integration tests** (44.1-INT-002, 003, 005) - Component integration
3. **P1 Unit tests** - Extended coverage
4. **P1 Integration/E2E tests** - Full workflow validation
5. **P2 tests** - Edge cases and polish

## Test Implementation Notes

### Unit Test Setup Pattern

```rust
#[cfg(test)]
mod mermaid_tests {
    use super::*;

    fn create_linear_graph() -> StateGraph {
        let mut graph = StateGraph::new();
        graph.add_node("a", Node::default());
        graph.add_node("b", Node::default());
        graph.set_entry_point("a");
        graph.set_finish_point("b");
        graph.add_edge("a", "b", Edge::simple());
        graph
    }

    #[test]
    fn test_mermaid_contains_graph_header() {
        let graph = create_linear_graph();
        let mermaid = graph.to_mermaid();
        assert!(mermaid.starts_with("graph TD"));
    }
}
```

### Integration Test Pattern (YAML Engine)

```rust
#[test]
fn test_yaml_engine_mermaid_access() {
    let yaml = r#"
        name: test
        nodes:
          - name: process
            run: return state
        edges:
          - from: __start__
            to: process
          - from: process
            to: __end__
    "#;

    let engine = YamlEngine::from_yaml(yaml).unwrap();
    let graph = engine.get_mermaid_graph();
    assert!(graph.is_some());
    assert!(graph.unwrap().contains("process"));
}
```

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (unit for logic, integration for component interaction)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (Opik integration is P0)
- [x] Test IDs follow naming convention (44.1-LEVEL-SEQ)
- [x] Scenarios are atomic and independent
