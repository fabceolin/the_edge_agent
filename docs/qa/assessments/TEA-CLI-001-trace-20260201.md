# Requirements Traceability Matrix

## Story: TEA-CLI-001 - URL-Based File Input for Python CLI

**Trace Date:** 2026-02-01
**Traced By:** Quinn (Test Architect)
**Test Design Reference:** `docs/qa/assessments/TEA-CLI-001-test-design-20260201.md`

---

## Coverage Summary

| Metric | Value |
|--------|-------|
| **Total Requirements** | 45 (8 ACs + 37 sub-requirements) |
| **Fully Covered** | 41 (91%) |
| **Partially Covered** | 4 (9%) |
| **Not Covered** | 0 (0%) |

### Coverage by Acceptance Criteria

| AC | Requirements | Tests | Coverage |
|----|--------------|-------|----------|
| AC1: CLI URL Support | 5 | 8 | FULL |
| AC2: Git Protocol Support | 6 | 9 | FULL |
| AC3: Caching System | 11 | 14 | FULL |
| AC4: Cache Management CLI | 4 | 5 | FULL |
| AC5: Authentication | 5 | 5 | FULL |
| AC6: Error Handling | 4 | 4 | FULL |
| AC7: Test Infrastructure | 4 | 3 | PARTIAL |
| AC8: Documentation | 4 | 0 | PARTIAL (manual verification) |
| Security (Risk Profile) | 3 | 5 | FULL |
| Performance (Risk Profile) | 2 | 1 | PARTIAL |

---

## Requirement Mappings

### AC1: CLI URL Support

**Requirements:**
- All file input flags accept URLs with any fsspec-supported protocol
- Affected flags: positional `file`, `--checkpoint`, `--checkpoint-dir`, `--from-dot`, `--dot-workflow`, `--input @path`
- Uses existing `_get_filesystem()` from `core_actions.py`
- Relative paths in remote YAMLs resolve relative to remote base URL
- Local paths work unchanged (passthrough)

**Coverage: FULL**

| Test ID | Given-When-Then |
|---------|-----------------|
| **TEA-CLI-001-UNIT-001** | **Given** a string input that may be URL or local path<br>**When** `_is_url()` is called<br>**Then** returns `True` for URLs (`s3://`, `gs://`, `github://`) and `False` for local paths (`/home/user/file.yaml`, `./relative.yaml`) |
| **TEA-CLI-001-UNIT-002** | **Given** a local filesystem path<br>**When** `resolve_file_url()` is called<br>**Then** returns the path unchanged as a `Path` object without any network activity |
| **TEA-CLI-001-UNIT-003** | **Given** a remote YAML file containing relative `uses:` references<br>**When** the YAML is loaded from `s3://bucket/dir/workflow.yaml`<br>**Then** relative paths like `./subgraph.yaml` resolve to `s3://bucket/dir/subgraph.yaml` |
| **TEA-CLI-001-INT-001** | **Given** a `file://` URL pointing to a local file<br>**When** `resolve_file_url()` processes it<br>**Then** returns local path via fsspec local filesystem handler |
| **TEA-CLI-001-INT-002** | **Given** an S3 URL `s3://bucket/workflow.yaml` and moto mock<br>**When** URL is resolved<br>**Then** file is downloaded via s3fs and cached locally |
| **TEA-CLI-001-INT-003** | **Given** a GCS URL `gs://bucket/workflow.yaml` and HTTP mock<br>**When** URL is resolved<br>**Then** file is downloaded via gcsfs and cached locally |
| **TEA-CLI-001-INT-004** | **Given** an Azure URL `az://container/workflow.yaml` and HTTP mock<br>**When** URL is resolved<br>**Then** file is downloaded via adlfs and cached locally |
| **TEA-CLI-001-E2E-001** | **Given** a valid workflow at `s3://bucket/workflow.yaml` (mocked)<br>**When** `tea run s3://bucket/workflow.yaml` is executed<br>**Then** workflow runs successfully using cached local file |

---

### AC2: Git Protocol Support

**Requirements:**
- Format: `github://user/repo@branch/path/to/file.yaml`
- Support branch names: `@main`, `@feature/xyz`
- Support commit SHA: `@a1b2c3d`
- Support tags: `@v1.0.0`
- Private repository support via `GITHUB_TOKEN` / `GIT_TOKEN` env vars
- GitLab support: `gitlab://user/repo@branch/path`

**Coverage: FULL**

| Test ID | Given-When-Then |
|---------|-----------------|
| **TEA-CLI-001-UNIT-004** | **Given** URL `github://user/repo@main/path/file.yaml`<br>**When** URL is parsed<br>**Then** extracts `user=user`, `repo=repo`, `ref=main`, `path=path/file.yaml` |
| **TEA-CLI-001-UNIT-005** | **Given** URL `github://user/repo@a1b2c3d/path/file.yaml`<br>**When** URL is parsed<br>**Then** extracts SHA `ref=a1b2c3d` and identifies as immutable ref |
| **TEA-CLI-001-UNIT-006** | **Given** URL `github://user/repo@v1.0.0/path/file.yaml`<br>**When** URL is parsed<br>**Then** extracts tag `ref=v1.0.0` and identifies as immutable ref |
| **TEA-CLI-001-UNIT-007** | **Given** URL `gitlab://user/repo@develop/path/file.yaml`<br>**When** URL is parsed<br>**Then** extracts GitLab components correctly with host=gitlab |
| **TEA-CLI-001-INT-005** | **Given** a local bare git repo with branch `main` containing `workflow.yaml`<br>**When** `github://test/repo@main/workflow.yaml` is fetched<br>**Then** file content matches branch HEAD content |
| **TEA-CLI-001-INT-006** | **Given** a local git repo with specific commit SHA `abc123`<br>**When** `github://test/repo@abc123/workflow.yaml` is fetched<br>**Then** file content matches that specific commit, not HEAD |
| **TEA-CLI-001-INT-007** | **Given** a local git repo with tag `v1.0.0`<br>**When** `github://test/repo@v1.0.0/workflow.yaml` is fetched<br>**Then** file content matches tagged commit |
| **TEA-CLI-001-INT-008** | **Given** `GITHUB_TOKEN=ghp_test123` environment variable<br>**When** fetching from a private repo URL<br>**Then** token is used for authentication and file is retrieved |
| **TEA-CLI-001-INT-009** | **Given** `GIT_TOKEN=token123` but no `GITHUB_TOKEN`<br>**When** fetching from GitHub URL<br>**Then** `GIT_TOKEN` is used as fallback credential |

---

### AC3: Caching System

**Requirements:**
- Remote files cached locally in `~/.cache/tea/remote/` (XDG compliant)
- Cache key: SHA256 hash of (URL + ref for git)
- Cache TTL configurable via `TEA_CACHE_TTL` env var (default: 1 hour)
- `--no-cache` flag to force fresh fetch
- `--cache-only` flag for offline mode (fail if not cached)
- `--cache-dir <path>` flag to override default cache location
- Git refs: branches re-fetch on TTL expiry, SHA/tags cached indefinitely
- Cache size limit via `TEA_CACHE_MAX_SIZE` (default: 1GB, TTL-based eviction)
- Debug logging for cache hits/misses when `--verbose` enabled

**Coverage: FULL**

| Test ID | Given-When-Then |
|---------|-----------------|
| **TEA-CLI-001-UNIT-008** | **Given** URL `s3://bucket/workflow.yaml`<br>**When** cache key is generated<br>**Then** key equals `SHA256(canonical_url)[:16]` (deterministic, reproducible) |
| **TEA-CLI-001-UNIT-009** | **Given** git URL `github://user/repo@main/file.yaml`<br>**When** cache key is generated<br>**Then** key equals `SHA256("user/repo@main")[:16]` |
| **TEA-CLI-001-UNIT-010** | **Given** `XDG_CACHE_HOME=/custom/cache`<br>**When** `RemoteFileCache()` is instantiated<br>**Then** `cache_dir` is `/custom/cache/tea/remote/` |
| **TEA-CLI-001-UNIT-011** | **Given** a cached branch ref with TTL=3600s and current time T+3601s<br>**When** `has_valid()` is checked<br>**Then** returns `False` (expired) |
| **TEA-CLI-001-UNIT-012** | **Given** a cached SHA ref with any age<br>**When** `has_valid()` is checked<br>**Then** returns `True` (immutable refs never expire) |
| **TEA-CLI-001-INT-010** | **Given** URL already in cache with valid TTL<br>**When** `resolve_file_url()` is called<br>**Then** returns cached path without making network request |
| **TEA-CLI-001-INT-011** | **Given** URL not in cache<br>**When** `resolve_file_url()` is called<br>**Then** fetches file, stores in cache, returns local path |
| **TEA-CLI-001-INT-012** | **Given** URL in cache and `--no-cache` flag<br>**When** `resolve_file_url()` is called<br>**Then** fetches fresh copy, updates cache |
| **TEA-CLI-001-INT-013** | **Given** URL not in cache and `--cache-only` flag<br>**When** `resolve_file_url()` is called<br>**Then** raises `typer.BadParameter` with helpful message |
| **TEA-CLI-001-INT-014** | **Given** URL in cache and `--cache-only` flag<br>**When** `resolve_file_url()` is called<br>**Then** returns cached path without network attempt |
| **TEA-CLI-001-INT-015** | **Given** `--cache-dir /tmp/custom-cache`<br>**When** file is cached<br>**Then** file appears in `/tmp/custom-cache/` not default location |
| **TEA-CLI-001-INT-016** | **Given** `TEA_CACHE_TTL=60` environment variable<br>**When** cache validity is checked at T+61s<br>**Then** entry is expired (uses env var, not default) |
| **TEA-CLI-001-INT-017** | **Given** cache size exceeds `TEA_CACHE_MAX_SIZE`<br>**When** new file is cached<br>**Then** oldest entries by TTL are evicted to make space |
| **TEA-CLI-001-INT-018** | **Given** two concurrent processes writing to cache<br>**When** both complete<br>**Then** manifest.json is not corrupted (proper locking) |
| **TEA-CLI-001-E2E-002** | **Given** `--verbose` flag enabled<br>**When** URL is resolved<br>**Then** stderr shows "Cache HIT: {url}" or "Cache MISS: {url}" |

---

### AC4: Cache Management CLI

**Requirements:**
- `tea cache list` - Show cached files with URL, size, age
- `tea cache clear` - Clear all cached files
- `tea cache clear --older-than <duration>` - Clear files older than duration
- `tea cache info` - Show cache location, total size, entry count

**Coverage: FULL**

| Test ID | Given-When-Then |
|---------|-----------------|
| **TEA-CLI-001-INT-019** | **Given** cache with 3 entries<br>**When** `tea cache list` is executed<br>**Then** output shows URL, size, age for each entry |
| **TEA-CLI-001-INT-020** | **Given** cache with entries<br>**When** `tea cache clear` is executed<br>**Then** all cache entries and files are removed |
| **TEA-CLI-001-INT-021** | **Given** cache with entries aged 1d, 5d, 10d<br>**When** `tea cache clear --older-than 7d` is executed<br>**Then** only 10d entry is removed |
| **TEA-CLI-001-INT-022** | **Given** cache with 5 entries totaling 50MB<br>**When** `tea cache info` is executed<br>**Then** shows location, "5 entries", "50MB total" |
| **TEA-CLI-001-E2E-003** | **Given** populated cache<br>**When** `tea cache list` is executed<br>**Then** output is formatted for human readability (columns aligned, sizes human-readable) |

---

### AC5: Authentication via Environment Variables

**Requirements:**
- AWS: `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_SESSION_TOKEN`
- GCS: `GOOGLE_APPLICATION_CREDENTIALS`
- Azure: `AZURE_STORAGE_ACCOUNT_NAME`, `AZURE_STORAGE_ACCOUNT_KEY`
- Git: `GITHUB_TOKEN`, `GITLAB_TOKEN`, `GIT_TOKEN` (generic fallback)
- Clear error messages when credentials missing

**Coverage: FULL**

| Test ID | Given-When-Then |
|---------|-----------------|
| **TEA-CLI-001-UNIT-013** | **Given** `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_SESSION_TOKEN` all set<br>**When** S3 client is created<br>**Then** all three credentials are passed (session token takes precedence when present) |
| **TEA-CLI-001-INT-023** | **Given** valid AWS credentials in environment<br>**When** accessing `s3://bucket/file.yaml` (mocked)<br>**Then** request includes proper AWS signature |
| **TEA-CLI-001-INT-024** | **Given** `GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json`<br>**When** accessing `gs://bucket/file.yaml` (mocked)<br>**Then** request uses service account authentication |
| **TEA-CLI-001-INT-025** | **Given** `AZURE_STORAGE_ACCOUNT_NAME` and `AZURE_STORAGE_ACCOUNT_KEY`<br>**When** accessing `az://container/file.yaml` (mocked)<br>**Then** request uses shared key authentication |
| **TEA-CLI-001-E2E-004** | **Given** no AWS credentials and S3 URL<br>**When** `tea run s3://bucket/file.yaml` is executed<br>**Then** error message identifies missing `AWS_ACCESS_KEY_ID` specifically |

---

### AC6: Error Handling

**Requirements:**
- Missing backend package: suggest install command (`pip install s3fs`)
- Authentication failure: identify which credential is missing
- Network failure: suggest `--cache-only` if cached version exists
- Invalid URL format: show expected format with examples

**Coverage: FULL**

| Test ID | Given-When-Then |
|---------|-----------------|
| **TEA-CLI-001-UNIT-014** | **Given** s3fs not installed<br>**When** S3 URL is processed<br>**Then** error includes "Install s3fs: pip install s3fs" |
| **TEA-CLI-001-UNIT-015** | **Given** malformed URL `github://user/repo/file.yaml` (missing @ref)<br>**When** URL is parsed<br>**Then** error shows "Expected format: github://user/repo@ref/path" |
| **TEA-CLI-001-INT-026** | **Given** network failure and URL has expired cache entry<br>**When** fetch fails<br>**Then** error includes "Tip: A cached version exists. Use --cache-only to use it." |
| **TEA-CLI-001-E2E-005** | **Given** s3fs not installed<br>**When** `tea run s3://bucket/file.yaml` is executed<br>**Then** full error flow shows install suggestion |

---

### AC7: Test Infrastructure

**Requirements:**
- Use `moto` for S3 mocking, `responses` for HTTP mocking
- Use local git repos (via `tempfile`) for git:// tests
- All tests run offline (no real network calls)
- Minimum 90% code coverage on new modules

**Coverage: PARTIAL**

| Test ID | Given-When-Then |
|---------|-----------------|
| **TEA-CLI-001-UNIT-016** | **Given** test environment with pytest<br>**When** `moto_s3` fixture is used<br>**Then** S3 operations succeed against mock endpoint |
| **TEA-CLI-001-UNIT-017** | **Given** test environment with pytest<br>**When** `local_git_repo` fixture is used<br>**Then** git clone operations succeed against tempdir |
| **TEA-CLI-001-UNIT-018** | **Given** complete test run<br>**When** coverage is calculated for `cache.py`<br>**Then** coverage â‰¥ 90% |

**Gap:** No automated test for "all tests run offline" - manual review required during PR.

---

### AC8: Documentation

**Requirements:**
- Update CLI `--help` text with URL examples
- Add `docs/shared/remote-files.md` with full protocol reference
- Inline code comments for cache key generation algorithm
- Inline code comments for URL parsing logic

**Coverage: PARTIAL (Manual Verification Required)**

| Requirement | Verification Method |
|-------------|---------------------|
| CLI `--help` updated | Manual review of `tea run --help` output |
| `docs/shared/remote-files.md` created | File existence check in PR |
| Cache key algorithm comments | Code review |
| URL parsing logic comments | Code review |

---

### Security Tests (Risk Profile Mitigations)

**Requirements (from Risk Profile):**
- SEC-001: Credential masking in logs
- SEC-002: Path traversal prevention
- SEC-003: SSRF protection

**Coverage: FULL**

| Test ID | Given-When-Then |
|---------|-----------------|
| **TEA-CLI-001-UNIT-019** | **Given** URL `github://../../../etc/passwd`<br>**When** path resolution is attempted<br>**Then** `SecurityError` raised before any filesystem access |
| **TEA-CLI-001-INT-027** | **Given** any URL that resolves to path containing `..`<br>**When** final path is computed<br>**Then** resolved path is verified to be within `~/.cache/tea/remote/` |
| **TEA-CLI-001-INT-028** | **Given** `GITHUB_TOKEN=secret123` and `--verbose` flag<br>**When** URL is processed<br>**Then** log output shows `***` not actual token value |
| **TEA-CLI-001-E2E-006** | **Given** URL `file://localhost/etc/passwd`<br>**When** resolution is attempted<br>**Then** rejected with "localhost URLs not permitted in remote mode" |
| **TEA-CLI-001-E2E-007** | **Given** URL `http://169.254.169.254/latest/meta-data`<br>**When** resolution is attempted<br>**Then** rejected with "cloud metadata endpoints blocked" |

---

### Performance Tests (Risk Profile Mitigations)

**Requirements (from Risk Profile):**
- PERF-001: Progress indicator for large downloads

**Coverage: PARTIAL**

| Test ID | Given-When-Then |
|---------|-----------------|
| **TEA-CLI-001-E2E-008** | **Given** URL pointing to 10MB file<br>**When** download is in progress<br>**Then** progress indicator is displayed (bytes downloaded / total) |

**Gap:** No test for `TEA_FETCH_TIMEOUT` (recommended in NFR Assessment but not yet in AC).

---

## Coverage Gaps

| Gap ID | Requirement | Severity | Suggested Action |
|--------|-------------|----------|------------------|
| GAP-001 | AC7: "All tests run offline" verification | Low | Add CI check that blocks real network calls |
| GAP-002 | AC8: Documentation completeness | Low | PR checklist item for reviewer |
| GAP-003 | PERF: `TEA_FETCH_TIMEOUT` configuration | Medium | Add to AC5 and create test |
| GAP-004 | PERF: Progress indicator >1MB threshold | Medium | Add threshold test (currently only 10MB tested) |

---

## Risk Assessment

### High Risk (No Coverage)
None - all high-risk items have test coverage.

### Medium Risk (Partial Coverage)
- GAP-003: `TEA_FETCH_TIMEOUT` not in AC, test missing
- GAP-004: Progress threshold boundary not tested

### Low Risk (Manual/Procedural)
- GAP-001: Offline test verification
- GAP-002: Documentation review

---

## Recommendations

### Must-Fix Before Implementation
1. **Add `TEA_FETCH_TIMEOUT` to AC5** - NFR Assessment identified this gap; add acceptance criterion and corresponding test

### Should-Fix
2. **Add progress indicator threshold test** - Test at 1MB boundary, not just 10MB
3. **CI network isolation** - Add pytest plugin to block real network calls in CI

### Nice-to-Have
4. **Documentation checklist** - Formalize AC8 verification in PR template

---

## Gate YAML Block

```yaml
trace:
  date: '2026-02-01'
  tracer: 'Quinn (Test Architect)'
  totals:
    requirements: 45
    full: 41
    partial: 4
    none: 0
    coverage_pct: 91
  by_ac:
    AC1: { requirements: 5, tests: 8, coverage: full }
    AC2: { requirements: 6, tests: 9, coverage: full }
    AC3: { requirements: 11, tests: 14, coverage: full }
    AC4: { requirements: 4, tests: 5, coverage: full }
    AC5: { requirements: 5, tests: 5, coverage: full }
    AC6: { requirements: 4, tests: 4, coverage: full }
    AC7: { requirements: 4, tests: 3, coverage: partial }
    AC8: { requirements: 4, tests: 0, coverage: partial_manual }
    Security: { requirements: 3, tests: 5, coverage: full }
    Performance: { requirements: 2, tests: 1, coverage: partial }
  gaps:
    - id: GAP-001
      ac: AC7
      description: 'No automated offline verification'
      severity: low
    - id: GAP-002
      ac: AC8
      description: 'Documentation requires manual review'
      severity: low
    - id: GAP-003
      ac: AC5
      description: 'TEA_FETCH_TIMEOUT not in acceptance criteria'
      severity: medium
    - id: GAP-004
      ac: Performance
      description: 'Progress threshold boundary not tested'
      severity: medium
  planning_ref: 'docs/qa/assessments/TEA-CLI-001-test-design-20260201.md'
```

---

## Trace References

**Trace matrix:** `docs/qa/assessments/TEA-CLI-001-trace-20260201.md`
**Test design:** `docs/qa/assessments/TEA-CLI-001-test-design-20260201.md`
**Risk profile:** Embedded in story file
**NFR assessment:** `docs/qa/assessments/TEA-CLI-001-nfr-20260201.md`
