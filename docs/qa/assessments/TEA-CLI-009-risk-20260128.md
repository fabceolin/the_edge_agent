# Risk Profile: Story TEA-CLI-009

Date: 2026-01-28
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 7
- Critical Risks: 0
- High Risks: 1
- Medium Risks: 4
- Low Risks: 2
- Risk Score: 71/100

## Critical Risks Requiring Immediate Attention

No critical risks identified.

## High Risk: TECH-001

**Score: 6 (High)**
**Title:** Off-by-one errors in wave/step indexing

**Probability**: Medium - Common bug pattern when converting between 1-based (user-facing) and 0-based (internal) indices. The story specifies 1-based wave/step numbers for CLI options, but Python's `enumerate()` defaults to 0-based indexing and the internal `levels` list in cli.py is 0-indexed.

**Impact**: High - Users could skip the wrong phase or inadvertently re-execute already-completed nodes, causing wasted compute time and potential side effects.

**Affected Components:**
- `cli.py` run command (lines ~700-839)
- Wave iteration logic
- Step iteration logic

**Mitigation**:
- Use explicit `enumerate(levels, 1)` consistently throughout implementation
- Add assertion guards: `assert wave_num >= 1` at validation entry points
- Implement thorough boundary testing for edge cases
- Code review with focus on index conversion points

**Testing Focus**:
- `--dot-start-wave 0` → error (invalid)
- `--dot-start-wave 1` → no-op (should execute from wave 1)
- `--dot-start-wave N` where N = total_waves → execute last wave only
- `--dot-start-wave N+1` → error with "has {N} waves" message
- Same pattern for `--dot-start-step`

## Risk Distribution

### By Category

- Technical (TECH): 4 risks (1 high, 3 medium)
- Data (DATA): 1 risk (1 medium)
- Operational (OPS): 2 risks (2 low)
- Security (SEC): 0 risks
- Performance (PERF): 0 risks
- Business (BUS): 0 risks

### By Component

- CLI (cli.py): 5 risks
- Parser (dot_parser.py): 1 risk
- Documentation: 1 risk

## Detailed Risk Register

| Risk ID  | Category    | Description                                                    | Probability | Impact     | Score | Priority |
|----------|-------------|----------------------------------------------------------------|-------------|------------|-------|----------|
| TECH-001 | Technical   | Off-by-one errors in wave/step indexing                        | Medium (2)  | High (3)   | 6     | High     |
| TECH-002 | Technical   | Phase structure mismatch between CLI levels and PhaseInfo      | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-003 | Technical   | Mutual exclusivity validation for --dot-start-from             | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-001 | Data        | Label lookup fails for nodes with special characters           | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-004 | Technical   | Dry-run output doesn't clearly show skipped items              | Medium (2)  | Medium (2) | 4     | Medium   |
| OPS-001  | Operational | Summary message counts incorrect after skipping                | Low (1)     | Medium (2) | 2     | Low      |
| OPS-002  | Operational | Error messages expose internal structure                       | Low (1)     | Low (1)    | 1     | Low      |

## Risk Mitigations

### TECH-001: Off-by-one Indexing

```yaml
mitigation:
  risk_id: 'TECH-001'
  strategy: 'preventive'
  actions:
    - 'Use enumerate(levels, 1) for 1-based iteration'
    - 'Add assertion guards at validation boundaries'
    - 'Code review focused on index conversions'
    - 'Comprehensive boundary testing'
  testing_requirements:
    - 'Unit tests for wave 0, 1, N, N+1'
    - 'Unit tests for step 0, 1, M, M+1'
    - 'Integration test with multi-wave DOT file'
  residual_risk: 'Low - With proper testing coverage'
  owner: 'dev'
  timeline: 'Before PR merge'
```

### TECH-002: Phase Structure Mismatch

```yaml
mitigation:
  risk_id: 'TECH-002'
  strategy: 'preventive'
  actions:
    - 'Use consistent label resolution (node.label vs node_id)'
    - 'Build label map during initial phase iteration'
    - 'Integration test with real DOT files'
  testing_requirements:
    - 'Test with DOT file having PhaseInfo clusters'
    - 'Test with DOT file using implicit phases (fan-out detection)'
  residual_risk: 'Low'
  owner: 'dev'
  timeline: 'During implementation'
```

### TECH-003: Mutual Exclusivity

```yaml
mitigation:
  risk_id: 'TECH-003'
  strategy: 'preventive'
  actions:
    - 'Add explicit validation at command entry'
    - 'Raise typer.BadParameter for clear error'
  testing_requirements:
    - 'Test --dot-start-from with --dot-start-wave → error'
    - 'Test --dot-start-from alone → works'
  residual_risk: 'Minimal'
  owner: 'dev'
  timeline: 'During implementation'
```

### DATA-001: Label Matching

```yaml
mitigation:
  risk_id: 'DATA-001'
  strategy: 'preventive'
  actions:
    - 'Build label map with both original and normalized keys'
    - 'Include available labels in error message (AC-18)'
    - 'Consider fuzzy matching for suggestions'
  testing_requirements:
    - 'Test label with spaces'
    - 'Test label with quotes'
    - 'Test label with special characters'
  residual_risk: 'Low - Good error messages compensate'
  owner: 'dev'
  timeline: 'During implementation'
```

### TECH-004: Dry-run Clarity

```yaml
mitigation:
  risk_id: 'TECH-004'
  strategy: 'preventive'
  actions:
    - 'Add [SKIPPED] prefix in dry-run output'
    - 'Use distinct styling for skipped items'
    - 'Add summary at end showing skip counts'
  testing_requirements:
    - 'Verify dry-run output shows skipped items clearly'
    - 'Verify executed items shown normally'
  residual_risk: 'Minimal'
  owner: 'dev'
  timeline: 'During implementation'
```

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests

No critical risks - proceed with High risk tests.

### Priority 1: High Risk Tests (TECH-001)

1. **Boundary tests for wave selection:**
   - `--dot-start-wave 0` → error (invalid wave number)
   - `--dot-start-wave 1` → starts from wave 1 (no skip message)
   - `--dot-start-wave N` where N = total waves → last wave only
   - `--dot-start-wave N+1` → error with actual wave count

2. **Boundary tests for step selection:**
   - `--dot-start-step 0` → error (invalid step number)
   - `--dot-start-step 1` → starts from step 1 (no skip message)
   - `--dot-start-step M` where M = wave steps → last step only
   - `--dot-start-step M+1` → error with actual step count

3. **Combined boundary tests:**
   - `--dot-start-wave 2 --dot-start-step 1` → skip wave 1, all steps in wave 2
   - `--dot-start-wave 1 --dot-start-step 3` → no wave skip, skip steps 1-2

### Priority 2: Medium Risk Tests

4. **Label resolution tests (DATA-001):**
   - Label with spaces: "Run Tests"
   - Label with quotes: 'Deploy "Prod"'
   - Label with special characters: "Step #1"
   - Non-existent label → error listing available labels

5. **Mutual exclusivity tests (TECH-003):**
   - `--dot-start-from "Build" --dot-start-wave 2` → error
   - `--dot-start-from "Build"` alone → works, resolves to correct wave/step

6. **Dry-run output tests (TECH-004):**
   - Verify skipped waves marked with [SKIPPED] or similar
   - Verify executed items shown with normal formatting
   - Verify skip summary at end

### Priority 3: Low Risk Tests

7. **Summary accuracy tests (OPS-001):**
   - Count executed nodes after skipping
   - Verify final message: "Executed X of Y nodes"

8. **Error message quality (OPS-002):**
   - Verify user-friendly error format
   - No internal variable names in messages

## Risk Acceptance Criteria

### Must Fix Before Production

- All TECH-001 mitigations implemented with passing tests

### Can Deploy with Mitigation

- DATA-001: Good error messages compensate for edge case label issues
- TECH-004: Dry-run output clarity can be improved post-launch

### Accepted Risks

- None - all identified risks have viable mitigations

## Monitoring Requirements

Post-deployment monitoring for:

- CLI error rates for new options
- User feedback on skip behavior
- Bug reports related to index confusion

## Risk Review Triggers

Review and update risk profile when:

- Phase detection algorithm changes
- New DOT attributes added
- User reports index-related bugs
- CLI argument parsing framework changes

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 4
    low: 2
  highest:
    id: TECH-001
    score: 6
    title: 'Off-by-one errors in wave/step indexing'
  recommendations:
    must_fix:
      - 'Use enumerate(levels, 1) consistently'
      - 'Add boundary assertions'
      - 'Comprehensive boundary testing'
    monitor:
      - 'CLI error rates post-deployment'
```

## Integration with Quality Gates

**Deterministic Gate Mapping:**

- Highest risk score: 6 (TECH-001)
- Score 6 ≥ 6 → Gate = **CONCERNS**
- No score ≥ 9 → Not FAIL

**Gate Status:** CONCERNS

**Reason:** TECH-001 presents a High risk requiring careful implementation and mandatory boundary testing before merge.
