# NFR Assessment: TEA-CLI-002

**Date:** 2026-02-01
**Reviewer:** Quinn (Test Architect)
**Story:** TEA-CLI-002: URL-Based File Input for Rust CLI
**Mode:** YOLO (Non-interactive - Core Four NFRs)

## Summary

| NFR | Status | Notes |
|-----|--------|-------|
| Security | CONCERNS | Credential handling needs explicit safeguards; path traversal mitigation required |
| Performance | CONCERNS | Target latency unknown; cache performance not specified |
| Reliability | CONCERNS | Network failure handling partially specified; concurrent access risks identified |
| Maintainability | PASS | Trait-based design enables testing; clear module structure |

**Overall NFR Status:** CONCERNS
**Quality Score:** 70/100 (3 CONCERNS Ã— 10 = 30 deducted)

---

## Security Assessment

### Status: CONCERNS

**Evidence Found:**
- AC2 mentions private repository support via `GITHUB_TOKEN` / `GIT_TOKEN` / `GITLAB_TOKEN` env vars
- Technical design shows credential handling in `GitFetcher::get_credentials()`
- Risk profile already identified SEC-001 (credential exposure) and SEC-002 (path traversal) as critical

**Gaps Identified:**

1. **Credential Exposure in Logs (Critical)**
   - No explicit requirement to redact tokens from error messages or debug logs
   - `--verbose` flag could expose credentials
   - **Recommendation:** Add AC requirement: "Tokens MUST be redacted from all log output including --verbose mode"

2. **Path Traversal Protection**
   - Cache paths use URL-derived components
   - Malicious URLs like `github://user/repo@main/../../../etc/passwd` could escape cache directory
   - **Recommendation:** Add AC requirement: "All cache paths MUST be canonicalized and validated to remain within cache directory"

3. **URL Validation**
   - No explicit validation of URL schemes before processing
   - Potential for unexpected protocol handlers
   - **Recommendation:** Whitelist supported protocols explicitly in code

4. **Cache Directory Permissions**
   - No requirement for secure default permissions on `~/.cache/tea/remote/`
   - **Recommendation:** Set directory permissions to 0700 on creation

**What's Good:**
- Uses environment variables (not config files) for credentials
- Auth token fallback chain is documented

---

## Performance Assessment

### Status: CONCERNS

**Evidence Found:**
- Cache system with TTL support via `TEA_CACHE_TTL`
- SHA256-based cache keys for deduplication
- Object_store crate provides optimized cloud storage access

**Gaps Identified:**

1. **No Target Latency Defined**
   - No performance requirements for URL resolution time
   - No target for cache hit/miss latency
   - **Target Unknown:** Cannot validate without thresholds
   - **Recommendation:** Define targets e.g., "Cache hit: <50ms, Cache miss: <5s for typical files"

2. **Large File Handling**
   - No specification for handling large files (>100MB)
   - Memory impact of cloning large repos via git2 not addressed
   - **Recommendation:** Add file size limits or streaming download support

3. **Network Timeout Configuration**
   - No explicit timeout for network operations
   - Object_store has defaults but they may be inappropriate for edge use cases
   - **Recommendation:** Document default timeouts; allow configuration

4. **Cache Size Management**
   - `tea cache clear --older-than <duration>` exists but no automatic eviction
   - Could lead to unbounded disk usage
   - **Recommendation:** Consider max cache size configuration

**What's Good:**
- TTL-based cache expiration
- Permanent cache for immutable refs (SHA/tags)
- Shared cache with Python reduces duplication

---

## Reliability Assessment

### Status: CONCERNS

**Evidence Found:**
- AC6 specifies: "Suggest `--cache-only` on network failure if cache exists"
- AC3 specifies cache hit behavior
- Error messages should match Python exactly

**Gaps Identified:**

1. **Concurrent Access (Risk DATA-001)**
   - No file locking on cache manifest
   - Parallel runs could corrupt manifest JSON
   - **Recommendation:** Implement file locking or atomic writes for manifest updates

2. **Partial Download Recovery**
   - No specification for handling interrupted downloads
   - Incomplete files could be cached as valid
   - **Recommendation:** Use temp files + atomic rename; verify file integrity

3. **Git Clone Failures**
   - Large repos may timeout or fail mid-clone
   - No retry specification for transient git errors
   - **Recommendation:** Add retry with exponential backoff for git operations

4. **Network State Detection**
   - `--cache-only` suggestion requires detecting "network failure"
   - No specification for what constitutes network failure vs. auth failure vs. 404
   - **Recommendation:** Classify error types explicitly in error handling

5. **Manifest Version Compatibility**
   - Manifest has `version: u32` but no migration path for version changes
   - **Recommendation:** Document manifest version handling; reject unknown versions gracefully

**What's Good:**
- Cache fallback on network failure is specified
- Error message parity with Python ensures consistent UX
- `is_permanent` flag prevents stale cache issues for immutable refs

---

## Maintainability Assessment

### Status: PASS

**Evidence Found:**
- AC5 explicitly requires trait-based design with `RemoteFileSystem` trait
- Mock implementation specified for unit tests
- `wiremock` specified for HTTP integration tests
- All tests required to run offline
- Clear module structure in technical design

**Positive Indicators:**

1. **Testability: Excellent**
   - `RemoteFileSystem` trait enables dependency injection
   - `MockRemoteFileSystem` provides deterministic test behavior
   - Integration tests use wiremock for HTTP mocking
   - Git tests use local tempfile repos

2. **Code Structure: Good**
   - Clear module separation (mod.rs, cache.rs, git.rs, cloud.rs, traits.rs)
   - Public API isolated in mod.rs
   - Matches existing Rust codebase patterns

3. **Documentation: Adequate**
   - AC7 requires docs/rust/actions-reference.md updates
   - Inline code comments required to match Python
   - CLI help text updates specified

4. **Test Coverage Strategy: Good**
   - Cross-language cache interop tests specified
   - Offline test requirement enforces proper mocking
   - Integration test example provided in story

**Minor Improvement Opportunities:**
- Consider adding property-based tests for URL parsing
- Consider fuzzing for cache key generation

---

## Critical Issues

### 1. **Credential Exposure in Verbose Mode** (Security)
- **Risk:** Tokens could appear in debug output
- **Impact:** Credential theft if logs are shared or captured
- **Fix:** Implement token redaction in all error/debug formatting

### 2. **Path Traversal in Cache Paths** (Security)
- **Risk:** Malicious URLs could escape cache directory
- **Impact:** Arbitrary file read/write
- **Fix:** Canonicalize and validate all paths before use

### 3. **Cache Manifest Corruption** (Reliability)
- **Risk:** Concurrent access without locking
- **Impact:** Lost cache entries, parse errors
- **Fix:** Implement file locking or atomic writes

---

## Quick Wins

| Improvement | Effort | Impact |
|-------------|--------|--------|
| Add path canonicalization | Low | High (Security) |
| Implement token redaction | Low | High (Security) |
| Add manifest file locking | Medium | Medium (Reliability) |
| Document timeout defaults | Low | Low (Performance) |
| Add cache size config | Medium | Low (Performance) |

---

## Test Recommendations

### Security Tests (Priority: Critical)
```rust
#[test]
fn test_token_not_in_error_messages() {
    std::env::set_var("GITHUB_TOKEN", "secret123");
    let err = fetch_github_url("github://invalid/repo@main/file");
    assert!(!format!("{:?}", err).contains("secret123"));
}

#[test]
fn test_path_traversal_blocked() {
    let result = RemoteFile::parse("github://user/repo@main/../../../etc/passwd");
    assert!(result.is_err() || !result.unwrap().local_path().contains("/etc/"));
}
```

### Performance Tests (Priority: Medium)
```rust
#[test]
fn test_cache_hit_latency() {
    // Pre-populate cache
    let cache = setup_cached_file("url", "/path/to/file");
    let start = Instant::now();
    let _ = cache.get("url");
    assert!(start.elapsed() < Duration::from_millis(50));
}
```

### Reliability Tests (Priority: High)
```rust
#[test]
fn test_concurrent_cache_writes() {
    let handles: Vec<_> = (0..10).map(|i| {
        std::thread::spawn(move || {
            cache.store(&format!("url_{}", i), &path);
        })
    }).collect();
    for h in handles { h.join().unwrap(); }
    // Verify manifest is valid JSON
    let manifest = std::fs::read_to_string(manifest_path).unwrap();
    serde_json::from_str::<CacheManifest>(&manifest).unwrap();
}
```

---

## NFR Acceptance Criteria Additions

Based on this assessment, recommend adding to story:

### AC8: Security Hardening
- [ ] All credential values (tokens, keys) MUST be redacted from error messages and logs
- [ ] All cache paths MUST be canonicalized and validated to remain within cache directory
- [ ] Cache directory MUST be created with 0700 permissions
- [ ] URL protocol scheme MUST be validated against whitelist before processing

### AC9: Performance Requirements
- [ ] Cache hit latency MUST be under 100ms for local filesystem
- [ ] Document default network timeouts in CLI help
- [ ] Support `TEA_CACHE_MAX_SIZE` for automatic eviction (optional)

### AC10: Reliability Requirements
- [ ] Cache manifest writes MUST be atomic (temp file + rename)
- [ ] Interrupted downloads MUST NOT result in corrupted cache entries
- [ ] Implement retry with backoff for transient network errors (max 3 retries)

---

## Gate YAML Block

```yaml
# Gate YAML (copy/paste):
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: CONCERNS
    notes: 'Missing: token redaction, path traversal protection, secure permissions'
  performance:
    status: CONCERNS
    notes: 'Target latency unknown; cache size limits not specified'
  reliability:
    status: CONCERNS
    notes: 'Concurrent cache access risks; partial download recovery unspecified'
  maintainability:
    status: PASS
    notes: 'Trait-based design with mocking; clear module structure; offline tests'
```

---

NFR assessment: docs/qa/assessments/TEA-CLI-002-nfr-20260201.md

Gate NFR block ready -> paste into docs/qa/gates/TEA-CLI-002-url-file-input-rust.yml under nfr_validation
